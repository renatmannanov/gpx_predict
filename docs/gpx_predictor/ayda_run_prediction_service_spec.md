# Ayda Run: –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–±–µ–≥–∞ —Å —É—á—ë—Ç–æ–º —Ä–µ–ª—å–µ—Ñ–∞

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** –Ø–Ω–≤–∞—Ä—å 2025  
**–ü—Ä–æ–µ–∫—Ç:** Ayda Run ‚Äî –ø–æ–¥—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Ç—Ä–µ–π–ª–æ–≤—ã—Ö –∏ –≥–æ—Ä–Ω—ã—Ö –∑–∞–±–µ–≥–∞—Ö

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#1-–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª–∏](#2-–±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç-–∏-—Ü–µ–ª–∏)
3. [–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–≤—ã–µ —Ä–∞–º–∫–∏](#3-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è-–∏-–ø—Ä–∞–≤–æ–≤—ã–µ-—Ä–∞–º–∫–∏)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#4-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
5. [–ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Ñ–æ—Ä–º—É–ª—ã](#5-–∞–ª–≥–æ—Ä–∏—Ç–º—ã-–∏-—Ñ–æ—Ä–º—É–ª—ã)
   - 5.5 [–†–µ–∂–∏–º –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ (–±–µ–∑ –±–µ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)](#55-—Ä–µ–∂–∏–º-–¥–ª—è-—Ç—É—Ä–∏—Å—Ç–æ–≤-–±–µ–∑-–±–µ–≥–æ–≤—ã—Ö-–¥–∞–Ω–Ω—ã—Ö)
   - 5.6 [Crowdsourced –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏](#56-crowdsourced-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è-–æ-–ø–æ–∫—Ä—ã—Ç–∏–∏)
6. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#6-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
7. [API Endpoints](#7-api-endpoints)
8. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Strava](#8-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å–æ-strava)
9. [Privacy Policy –∏ —Å–æ–≥–ª–∞—Å–∏—è](#9-privacy-policy-–∏-—Å–æ–≥–ª–∞—Å–∏—è)
10. [–†–∏—Å–∫–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏](#10-—Ä–∏—Å–∫–∏-–∏-–ø–æ–¥–≤–æ–¥–Ω—ã–µ-–∫–∞–º–Ω–∏)
11. [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#11-–ø–ª–∞–Ω-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
12. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞](#12-–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞)

---

## 1. –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### 1.1 –ß—Ç–æ –¥–µ–ª–∞–µ–º

–°–æ–∑–¥–∞—ë–º standalone –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–±–µ–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ:
- **GPX —Ñ–∞–π–ª–∞** —Ü–µ–ª–µ–≤–æ–π —Ç—Ä–∞—Å—Å—ã (–∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
- **–î–∞–Ω–Ω—ã—Ö –∞—Ç–ª–µ—Ç–∞** –∏–∑ Strava (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –∏–ª–∏ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –≤—Ä—É—á–Ω—É—é
- **–ù–∞—É—á–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª** (Riegel, Minetti) –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤–ª–∏—è–Ω–∏—è —Ä–µ–ª—å–µ—Ñ–∞

### 1.2 –ö–ª—é—á–µ–≤–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å

**Strava Performance Predictions –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–ª—å–µ—Ñ** ‚Äî –∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –¥–ª—è "–ø–ª–æ—Å–∫–æ–π —Ç—Ä–∞—Å—Å—ã, –ø–æ—Ö–æ–∂–µ–π –Ω–∞ —Å—Ç–∞–¥–∏–æ–Ω". –î–ª—è —Ç—Ä–µ–π–ª–æ–≤—ã—Ö –∏ –≥–æ—Ä–Ω—ã—Ö –∑–∞–±–µ–≥–æ–≤ —ç—Ç–æ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ.

–ù–∞—à —Å–µ—Ä–≤–∏—Å –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç gap:
```
Strava: "–¢—ã –ø—Ä–æ–±–µ–∂–∏—à—å –º–∞—Ä–∞—Ñ–æ–Ω –∑–∞ 3:45"
–†–µ–∞–ª—å–Ω–æ—Å—Ç—å: –ê–ª–º–∞—Ç–∏–Ω—Å–∫–∏–π –º–∞—Ä–∞—Ñ–æ–Ω —Å 847–º –Ω–∞–±–æ—Ä–∞ –≤—ã—Å–æ—Ç—ã
–ù–∞—à –ø—Ä–æ–≥–Ω–æ–∑: "4:32 —Å —É—á—ë—Ç–æ–º —Ä–µ–ª—å–µ—Ñ–∞ —Ç—Ä–∞—Å—Å—ã"
```

### 1.3 –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è

**–ü–µ—Ä–≤–∏—á–Ω–∞—è (–±–µ–≥—É–Ω—ã):**
- –¢—Ä–µ–π–ª—Ä–∞–Ω–Ω–µ—Ä—ã, –≥–æ—Ç–æ–≤—è—â–∏–µ—Å—è –∫ –≥–æ—Ä–Ω—ã–º –∑–∞–±–µ–≥–∞–º
- –ë–µ–≥—É–Ω—ã, —É—á–∞—Å—Ç–≤—É—é—â–∏–µ –≤ –≥–æ—Ä–æ–¥—Å–∫–∏—Ö –º–∞—Ä–∞—Ñ–æ–Ω–∞—Ö —Å —Ä–µ–ª—å–µ—Ñ–æ–º
- –ö–ª—É–±—ã –∏–∑ Ayda Run (cross-sell –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)

**–í—Ç–æ—Ä–∏—á–Ω–∞—è (—Ç—É—Ä–∏—Å—Ç—ã) ‚Äî –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:**
- –ù–æ–≤–∏—á–∫–∏, –∏–¥—É—â–∏–µ –≤ –≥–æ—Ä—ã –ø–µ—Ä–≤—ã–π —Ä–∞–∑
- –°–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏ –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±–µ–∑ –æ–ø—ã—Ç–∞
- –õ—é–±–∏—Ç–µ–ª–∏, –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞—é—â–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞

> ‚ö†Ô∏è **–ö–æ–Ω—Ç–µ–∫—Å—Ç –ê–ª–º–∞—Ç—ã:** –ï–∂–µ–≥–æ–¥–Ω–æ –¥–µ—Å—è—Ç–∫–∏ –ª—é–¥–µ–π –ø–æ–ø–∞–¥–∞—é—Ç –≤ –±–µ–¥—É –≤ –≥–æ—Ä–∞—Ö –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–∏. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å-—Ñ–∏—á–∞, –Ω–æ –∏ –≤–∫–ª–∞–¥ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

---

## 2. –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª–∏

### 2.1 –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ü–µ–ª–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–û–†–û–ù–ö–ê –ü–†–ò–í–õ–ï–ß–ï–ù–ò–Ø                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  1. –ë–µ–≥—É–Ω –∏—â–µ—Ç "–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ç–µ–º–ø–∞ –±–µ–≥–∞ –≥–æ—Ä—ã"               ‚îÇ
‚îÇ                        ‚Üì                                    ‚îÇ
‚îÇ  2. –ù–∞—Ö–æ–¥–∏—Ç –Ω–∞—à –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä                     ‚îÇ
‚îÇ                        ‚Üì                                    ‚îÇ
‚îÇ  3. –ü–æ–ª—É—á–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑, —à–µ—Ä–∏—Ç –≤ —Å–æ—Ü—Å–µ—Ç–∏                      ‚îÇ
‚îÇ                        ‚Üì                                    ‚îÇ
‚îÇ  4. –í–∏–¥–∏—Ç CTA: "–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è —Å –∫–ª—É–±–æ–º Ayda Run"              ‚îÇ
‚îÇ                        ‚Üì                                    ‚îÇ
‚îÇ  5. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –¶–µ–ª—å (6 –º–µ—Å) | –ö–∞–∫ –∏–∑–º–µ—Ä—è—Ç—å |
|---------|--------------|--------------|
| MAU –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ | 5,000 | Analytics |
| –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ Ayda Run | 5% | UTM tracking |
| –®–µ—Ä—ã –≤ —Å–æ—Ü—Å–µ—Ç–∏ | 500/–º–µ—Å | Share button clicks |
| Retention (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ä–∞—Å—á—ë—Ç—ã) | 30% | User tracking |

### 2.3 –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

| –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç | –ò—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è | –ù–∞—à–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ |
|-----------|----------------|-------------------|
| Strava Performance Predictions | –¢–æ–ª—å–∫–æ –ø–ª–æ—Å–∫–∏–µ —Ç—Ä–∞—Å—Å—ã | GPX + —Ä–µ–ª—å–µ—Ñ |
| McMillan Calculator | –ù–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ GPX | –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ |
| Go&Race | –ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ | –î–∞–Ω–Ω—ã–µ –∞—Ç–ª–µ—Ç–∞ –∏–∑ Strava |
| Garmin Race Predictor | –ü—Ä–∏–≤—è–∑–∞–Ω –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É | –í–µ–±-—Å–µ—Ä–≤–∏—Å –¥–ª—è –≤—Å–µ—Ö |
| **–í—Å–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã** | **–¢–æ–ª—å–∫–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑** | **üéØ –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ (–£–¢–ü!)** |

### 2.4 üéØ –£–¢–ü: –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –ø–æ—Ö–æ–¥–æ–≤

> **–ö–ª—é—á–µ–≤–æ–π –∏–Ω—Å–∞–π—Ç:** –í –≥–æ—Ä—ã —Ä–µ–¥–∫–æ —Ö–æ–¥—è—Ç –≤ –æ–¥–∏–Ω–æ—á–∫—É. –ì—Ä—É–ø–ø–∞ –∏–¥—ë—Ç —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é —Å–∞–º–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.

#### 2.4.1 –ü—Ä–æ–±–ª–µ–º–∞

```
–¢–∏–ø–∏—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
‚îú‚îÄ‚îÄ –û–ª–µ–≥ (–æ–ø—ã—Ç–Ω—ã–π, –Ω–∞–ª–µ–≥–∫–µ):     –ø—Ä–æ–≥–Ω–æ–∑ 4 —á–∞—Å–∞
‚îú‚îÄ‚îÄ –ú–∞—Ä–∏–Ω–∞ (–ª—é–±–∏—Ç–µ–ª—å, —Å –¥–µ—Ç—å–º–∏): –ø—Ä–æ–≥–Ω–æ–∑ 7 —á–∞—Å–æ–≤
‚îú‚îÄ‚îÄ –°–∞—à–∞ (–Ω–æ–≤–∏—á–æ–∫, —Ç—è–∂—ë–ª—ã–π —Ä—é–∫–∑–∞–∫): –ø—Ä–æ–≥–Ω–æ–∑ 8 —á–∞—Å–æ–≤
‚îî‚îÄ‚îÄ –ì—Ä—É–ø–ø–∞ –≤—ã—Ö–æ–¥–∏—Ç –≤–º–µ—Å—Ç–µ...

–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
‚îú‚îÄ‚îÄ –û–ª–µ–≥ —É–±–µ–≥–∞–µ—Ç –≤–ø–µ—Ä—ë–¥, –∂–¥—ë—Ç, —Å–∫—É—á–∞–µ—Ç
‚îú‚îÄ‚îÄ –ú–∞—Ä–∏–Ω–∞ —Å –¥–µ—Ç—å–º–∏ –æ—Ç—Å—Ç–∞—ë—Ç, –Ω–µ—Ä–≤–Ω–∏—á–∞–µ—Ç
‚îú‚îÄ‚îÄ –°–∞—à–∞ –≤—ã–±–∏–≤–∞–µ—Ç—Å—è –∏–∑ —Å–∏–ª, —Ç—è–Ω–µ—Ç –≤—Å–µ—Ö –Ω–∞–∑–∞–¥
‚îî‚îÄ‚îÄ –í—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ —Ç–µ–º–Ω–æ—Ç–µ, —É—Å—Ç–∞–≤—à–∏–µ –∏ –∑–ª—ã–µ

–¢–∏–ø–∏—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:
‚îú‚îÄ‚îÄ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –≥—Ä—É–ø–ø–µ
‚îú‚îÄ‚îÄ –ö—Ç–æ-—Ç–æ —Ç—Ä–∞–≤–º–∏—Ä—É–µ—Ç—Å—è (—Å–ø–µ—à–∫–∞ –Ω–∞ —Å–ø—É—Å–∫–µ)
‚îú‚îÄ‚îÄ –ù–µ —É—Å–ø–µ–≤–∞—é—Ç –¥–æ —Ç–µ–º–Ω–æ—Ç—ã
‚îî‚îÄ‚îÄ –ë–æ–ª—å—à–µ –Ω–µ —Ö–æ—Ç—è—Ç —Ö–æ–¥–∏—Ç—å –≤–º–µ—Å—Ç–µ
```

#### 2.4.2 –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ: –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üë• –ü–†–û–ì–ù–û–ó –î–õ–Ø –ì–†–£–ü–ü–´                                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  –ú–∞—Ä—à—Ä—É—Ç: –ö–æ–∫-–ñ–∞–π–ª—è—É (12 –∫–º, +680–º)                             ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  –£–ß–ê–°–¢–ù–ò–ö–ò                         –ò–Ω–¥–∏–≤–∏–¥.  –°—Ç–∞—Ç—É—Å     ‚îÇ   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
‚îÇ  ‚îÇ  üë§ –û–ª–µ–≥ (–æ–ø—ã—Ç–Ω—ã–π, –ª—ë–≥–∫–∏–π)         4:00      üü¢ –ë—ã—Å—Ç—Ä—ã–π ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  üë§ –ú–∞—Ä–∏–Ω–∞ (–ª—é–±–∏—Ç–µ–ª—å, —Å —Ä–µ–±—ë–Ω–∫–æ–º)  6:30      üü° –°—Ä–µ–¥–Ω–∏–π ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  üë§ –°–∞—à–∞ (–Ω–æ–≤–∏—á–æ–∫, —Ç—è–∂—ë–ª—ã–π)        7:30      üî¥ –ú–µ–¥–ª–µ–Ω–Ω—ã–π‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  üë§ –î–∏–º–∞ (—Ä–µ–≥—É–ª—è—Ä–Ω–æ, —Å—Ä–µ–¥–Ω–∏–π)      5:00      üü¢ –ë—ã—Å—Ç—Ä—ã–π ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  üìä –ê–ù–ê–õ–ò–ó –ì–†–£–ü–ü–´                                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã:  7:30 - 8:30                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  (–ø–æ —Å–∞–º–æ–º—É –º–µ–¥–ª–µ–Ω–Ω–æ–º—É + –≤—Ä–µ–º—è –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏/–æ–∂–∏–¥–∞–Ω–∏–µ)   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –†–∞–∑–±—Ä–æ—Å —Å–∫–æ—Ä–æ—Å—Ç–µ–π: –í–´–°–û–ö–ò–ô ‚ö†Ô∏è                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –û–ª–µ–≥ –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –°–∞—à—É ~3.5 —á–∞—Å–∞ —Å—É–º–º–∞—Ä–Ω–æ               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚ö†Ô∏è –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:                                               ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îÇ  1. üîÑ –†–ê–ó–î–ï–õ–ò–¢–¨–°–Ø –ù–ê –î–í–ï –ú–ò–ù–ò-–ì–†–£–ü–ü–´:                     ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –ì—Ä—É–ø–ø–∞ –ê (–û–ª–µ–≥ + –î–∏–º–∞): —Å—Ç–∞—Ä—Ç 08:00, —Ç–µ–º–ø –±—ã—Å—Ç—Ä—ã–π   ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –ì—Ä—É–ø–ø–∞ –ë (–ú–∞—Ä–∏–Ω–∞ + –°–∞—à–∞): —Å—Ç–∞—Ä—Ç 07:00, —Ç–µ–º–ø —Å–ø–æ–∫–æ–π–Ω—ã–π‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –í—Å—Ç—Ä–µ—á–∞ –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ –≤ ~11:00                          ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îÇ  2. ‚ö° –ü–ï–†–ï–†–ê–°–ü–†–ï–î–ï–õ–ò–¢–¨ –ù–ê–ì–†–£–ó–ö–£:                           ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –û–ª–µ–≥ –º–æ–∂–µ—Ç –≤–∑—è—Ç—å —á–∞—Å—Ç—å –≤–µ—â–µ–π –°–∞—à–∏ (-2–∫–≥)            ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –≠—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –°–∞—à—É –Ω–∞ ~40 –º–∏–Ω                          ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îÇ  3. üìç –ù–ê–ó–ù–ê–ß–ò–¢–¨ –¢–û–ß–ö–ò –°–ë–û–†–ê:                              ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –ö–º 3 ‚Äî —Ä–æ–¥–Ω–∏–∫ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö)     ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –ö–º 6 ‚Äî —Å–º–æ—Ç—Ä–æ–≤–∞—è –ø–ª–æ—â–∞–¥–∫–∞                            ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îÇ  4. ‚è∞ –£–°–¢–ê–ù–û–í–ò–¢–¨ –í–†–ï–ú–Ø –†–ê–ó–í–û–†–û–¢–ê:                         ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –ù–µ –ø–æ–∑–∂–µ 12:00 –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å   ‚îÇ
‚îÇ  ‚îÇ     ‚Ä¢ –≠—Ç–æ –¥–∞—Å—Ç –∑–∞–ø–∞—Å –Ω–∞ —Å–ø—É—Å–∫ –¥–æ —Ç–µ–º–Ω–æ—Ç—ã                   ‚îÇ
‚îÇ  ‚îÇ                                                              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–ª–∞–Ω –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º]                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 2.4.3 –ê–ª–≥–æ—Ä–∏—Ç–º –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞

```python
from dataclasses import dataclass
from typing import List, Optional
from enum import Enum

class GroupRole(Enum):
    """–†–æ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –≥—Ä—É–ø–ø–µ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏"""
    FAST = "fast"           # –¢–æ–ø 25% ‚Äî –±—É–¥–µ—Ç –∂–¥–∞—Ç—å
    AVERAGE = "average"     # –°—Ä–µ–¥–Ω–∏–µ 50%
    SLOW = "slow"           # –ù–∏–∂–Ω–∏–µ 25% ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–º–ø –≥—Ä—É–ø–ø—ã

@dataclass
class GroupMember:
    """–£—á–∞—Å—Ç–Ω–∏–∫ –≥—Ä—É–ø–ø—ã"""
    name: str
    profile: HikerProfile
    individual_time_hours: float
    role: Optional[GroupRole] = None

@dataclass
class GroupPrediction:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞"""
    members: List[GroupMember]
    group_time_hours: float           # –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤—Å–µ–π –≥—Ä—É–ø–ø—ã
    spread_hours: float               # –†–∞–∑–±—Ä–æ—Å –º–µ–∂–¥—É –±—ã—Å—Ç—Ä—ã–º –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–º
    split_recommended: bool           # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç—å—Å—è
    subgroups: Optional[List[List[str]]]  # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∏–Ω–∏-–≥—Ä—É–ø–ø—ã
    recommendations: List[dict]
    meeting_points: List[dict]        # –¢–æ—á–∫–∏ —Å–±–æ—Ä–∞


def predict_group_time(
    members: List[GroupMember],
    course: CourseInfo
) -> GroupPrediction:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –≥—Ä—É–ø–ø—ã.

    –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
    1. –ì—Ä—É–ø–ø–∞ –∏–¥—ë—Ç —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é —Å–∞–º–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ
    2. –ë–æ–ª—å—à–æ–π —Ä–∞–∑–±—Ä–æ—Å = –±–æ–ª—å—à–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è
    3. –ü—Ä–∏ —Å–∏–ª—å–Ω–æ–º —Ä–∞–∑–±—Ä–æ—Å–µ –ª—É—á—à–µ —Ä–∞–∑–¥–µ–ª–∏—Ç—å—Å—è
    """

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    sorted_members = sorted(members, key=lambda m: m.individual_time_hours)

    fastest_time = sorted_members[0].individual_time_hours
    slowest_time = sorted_members[-1].individual_time_hours
    spread = slowest_time - fastest_time

    # –ù–∞–∑–Ω–∞—á–∞–µ–º —Ä–æ–ª–∏
    n = len(members)
    for i, member in enumerate(sorted_members):
        if i < n * 0.25:
            member.role = GroupRole.FAST
        elif i >= n * 0.75:
            member.role = GroupRole.SLOW
        else:
            member.role = GroupRole.AVERAGE

    # –ì—Ä—É–ø–ø–æ–≤–æ–µ –≤—Ä–µ–º—è = –º–µ–¥–ª–µ–Ω–Ω—ã–π + overhead –Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ
    # –ß–µ–º –±–æ–ª—å—à–µ spread, —Ç–µ–º –±–æ–ª—å—à–µ overhead
    waiting_overhead = spread * 0.15  # ~15% –æ—Ç —Ä–∞–∑–±—Ä–æ—Å–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    group_time = slowest_time + waiting_overhead

    # –†–µ—à–µ–Ω–∏–µ –æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏
    # –†–∞–∑–¥–µ–ª—è–µ–º—Å—è –µ—Å–ª–∏ —Ä–∞–∑–±—Ä–æ—Å > 2 —á–∞—Å–æ–≤ –∏–ª–∏ > 40% –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ
    split_recommended = (
        spread > 2.0 or
        spread / slowest_time > 0.4
    )

    # –§–æ—Ä–º–∏—Ä—É–µ–º –º–∏–Ω–∏-–≥—Ä—É–ø–ø—ã
    subgroups = None
    if split_recommended and n >= 4:
        subgroups = _suggest_subgroups(sorted_members)

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    recommendations = _generate_group_recommendations(
        sorted_members, spread, course
    )

    # –¢–æ—á–∫–∏ —Å–±–æ—Ä–∞
    meeting_points = _suggest_meeting_points(course, sorted_members)

    return GroupPrediction(
        members=sorted_members,
        group_time_hours=round(group_time, 1),
        spread_hours=round(spread, 1),
        split_recommended=split_recommended,
        subgroups=subgroups,
        recommendations=recommendations,
        meeting_points=meeting_points
    )


def _suggest_subgroups(members: List[GroupMember]) -> List[List[str]]:
    """
    –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–∏–Ω–∏-–≥—Ä—É–ø–ø—ã.

    –ü—Ä–∏–Ω—Ü–∏–ø—ã:
    - –ú–∏–Ω–∏–º—É–º 2 —á–µ–ª–æ–≤–µ–∫–∞ –≤ –≥—Ä—É–ø–ø–µ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
    - –ü–æ—Ö–æ–∂–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–º–µ—Å—Ç–µ
    - –û–ø—ã—Ç–Ω—ã–π –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    """

    fast = [m for m in members if m.role == GroupRole.FAST]
    average = [m for m in members if m.role == GroupRole.AVERAGE]
    slow = [m for m in members if m.role == GroupRole.SLOW]

    # –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –±—ã—Å—Ç—Ä—ã–µ + —á–∞—Å—Ç—å —Å—Ä–µ–¥–Ω–∏—Ö, –º–µ–¥–ª–µ–Ω–Ω—ã–µ + —á–∞—Å—Ç—å —Å—Ä–µ–¥–Ω–∏—Ö
    group_a = fast + average[:len(average)//2]
    group_b = slow + average[len(average)//2:]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º—É–º 2 –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
    if len(group_a) < 2 or len(group_b) < 2:
        return None  # –ù–µ —Ä–∞–∑–¥–µ–ª—è–µ–º

    return [
        [m.name for m in group_a],
        [m.name for m in group_b]
    ]


def _generate_group_recommendations(
    members: List[GroupMember],
    spread: float,
    course: CourseInfo
) -> List[dict]:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã"""

    recommendations = []

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞
    if spread > 1.5:
        slow_group = [m for m in members if m.role == GroupRole.SLOW]
        recommendations.append({
            "type": "staggered_start",
            "icon": "‚è∞",
            "title": "–†–∞–∑–Ω—ã–π —Å—Ç–∞—Ä—Ç",
            "description": f"–ú–µ–¥–ª–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ ({', '.join(m.name for m in slow_group)}) "
                          f"–ª—É—á—à–µ –≤—ã–π—Ç–∏ –Ω–∞ 30-60 –º–∏–Ω —Ä–∞–Ω—å—à–µ"
        })

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é –≥—Ä—É–∑–∞
    fast_members = [m for m in members if m.role == GroupRole.FAST]
    slow_with_heavy = [
        m for m in members
        if m.role == GroupRole.SLOW and m.profile.backpack == BackpackWeight.HEAVY
    ]

    if fast_members and slow_with_heavy:
        recommendations.append({
            "type": "redistribute_load",
            "icon": "üéí",
            "title": "–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥—Ä—É–∑",
            "description": f"{fast_members[0].name} –º–æ–∂–µ—Ç –≤–∑—è—Ç—å —á–∞—Å—Ç—å –≤–µ—â–µ–π "
                          f"—É {slow_with_heavy[0].name} ‚Äî —ç—Ç–æ —É—Å–∫–æ—Ä–∏—Ç –≥—Ä—É–ø–ø—É"
        })

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ç–æ—á–∫–∞–º —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞
    recommendations.append({
        "type": "turnaround",
        "icon": "üîÑ",
        "title": "–ï–¥–∏–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞",
        "description": "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –æ–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–ø–ø. "
                      "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –≤–µ—Ä—à–∏–Ω—ã."
    })

    # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Å–≤—è–∑–∏
    if len(members) > 4:
        recommendations.append({
            "type": "communication",
            "icon": "üì±",
            "title": "–û—Å—Ç–∞–≤–∞–π—Ç–µ—Å—å –Ω–∞ —Å–≤—è–∑–∏",
            "description": "–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ. "
                          "–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–≤—è–∑—å –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö."
        })

    return recommendations


def _suggest_meeting_points(
    course: CourseInfo,
    members: List[GroupMember]
) -> List[dict]:
    """–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ç–æ—á–∫–∏ —Å–±–æ—Ä–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ"""

    points = []

    # –¢–æ—á–∫–∏ –∫–∞–∂–¥—ã–µ ~3-4 –∫–º –∏–ª–∏ –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Å—Ç–∞—Ö
    distance_interval = 3.5  # –∫–º
    current_km = distance_interval

    while current_km < course.distance_km:
        # –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é —Ç–æ—á–∫—É
        poi = find_nearest_poi(course, current_km)

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö
        fast_arrival = estimate_arrival_time(
            members[0], current_km, course
        )
        slow_arrival = estimate_arrival_time(
            members[-1], current_km, course
        )

        points.append({
            "km": round(current_km, 1),
            "name": poi.name if poi else f"–ö–º {current_km:.0f}",
            "type": poi.type if poi else "checkpoint",
            "fast_arrival": fast_arrival,
            "slow_arrival": slow_arrival,
            "wait_time": slow_arrival - fast_arrival,
            "mandatory": poi.mandatory if poi else False
        })

        current_km += distance_interval

    return points
```

#### 2.4.4 API –¥–ª—è –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞

```yaml
POST /api/v1/predict/group
Request:
  Content-Type: application/json

  {
    "route": {
      "gpx_file_id": "uuid",      # –ò–ª–∏ known_route_id
      "is_round_trip": true
    },
    "members": [
      {
        "name": "–û–ª–µ–≥",
        "experience": "experienced",
        "backpack_weight": "light",
        "has_children": false,
        "first_time_altitude": false
      },
      {
        "name": "–ú–∞—Ä–∏–Ω–∞",
        "experience": "casual",
        "backpack_weight": "medium",
        "has_children": true,
        "first_time_altitude": false
      },
      {
        "name": "–°–∞—à–∞",
        "experience": "beginner",
        "backpack_weight": "heavy",
        "has_children": false,
        "first_time_altitude": true
      }
    ]
  }

Response:
  {
    "group_prediction": {
      "total_time_hours": 8.2,
      "time_formatted": "8 —á 10 –º–∏–Ω",
      "spread_hours": 3.5,
      "spread_warning": "high"
    },
    "members": [
      {
        "name": "–û–ª–µ–≥",
        "individual_time_hours": 4.5,
        "role": "fast",
        "wait_time_estimate": "~3 —á–∞—Å–∞"
      },
      {
        "name": "–ú–∞—Ä–∏–Ω–∞",
        "individual_time_hours": 6.5,
        "role": "average"
      },
      {
        "name": "–°–∞—à–∞",
        "individual_time_hours": 8.0,
        "role": "slow",
        "limiting_factor": true
      }
    ],
    "recommendations": [
      {
        "type": "split_groups",
        "priority": "high",
        "icon": "üë•",
        "title": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç—å—Å—è",
        "description": "–†–∞–∑–±—Ä–æ—Å —Å–∫–æ—Ä–æ—Å—Ç–µ–π —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π",
        "suggested_groups": [
          {"name": "–ì—Ä—É–ø–ø–∞ –ê", "members": ["–û–ª–µ–≥"], "start": "08:00"},
          {"name": "–ì—Ä—É–ø–ø–∞ –ë", "members": ["–ú–∞—Ä–∏–Ω–∞", "–°–∞—à–∞"], "start": "07:00"}
        ]
      },
      {
        "type": "redistribute_load",
        "priority": "medium",
        "icon": "üéí",
        "title": "–ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≥—Ä—É–∑",
        "description": "–û–ª–µ–≥ –º–æ–∂–µ—Ç –≤–∑—è—Ç—å —á–∞—Å—Ç—å –≤–µ—â–µ–π —É –°–∞—à–∏"
      }
    ],
    "meeting_points": [
      {
        "km": 3.2,
        "name": "–†–æ–¥–Ω–∏–∫",
        "type": "water_source",
        "mandatory": true,
        "fast_arrival": "09:15",
        "slow_arrival": "10:30"
      },
      {
        "km": 6.0,
        "name": "–í–µ—Ä—à–∏–Ω–∞",
        "type": "destination",
        "mandatory": true,
        "fast_arrival": "10:30",
        "slow_arrival": "12:15"
      }
    ],
    "safety_notes": [
      "‚ö†Ô∏è –ù–∏–∫—Ç–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–¥—Ç–∏ –æ–¥–∏–Ω ‚Äî –º–∏–Ω–∏–º—É–º 2 —á–µ–ª–æ–≤–µ–∫–∞",
      "üì± –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤—è–∑—å –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º",
      "üîÑ –û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞: 12:00"
    ],
    "share_url": "https://..."
  }
```

#### 2.4.5 –ü–æ—á–µ–º—É —ç—Ç–æ –£–¢–ü

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã | –ú—ã |
|----------|------------|-----|
| –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ | ‚úÖ | ‚úÖ |
| –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ | ‚ùå | ‚úÖ |
| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é | ‚ùå | ‚úÖ |
| –¢–æ—á–∫–∏ —Å–±–æ—Ä–∞ | ‚ùå | ‚úÖ |
| –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ | ‚ùå | ‚úÖ |

**–í–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å:**
- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –ø–æ—Ö–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –≤—Å–µ–π –≥—Ä—É–ø–ø–µ
- –ö–∞–∂–¥—ã–π –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å
- –í—Å–µ –≤–∏–¥—è—Ç –æ–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑
- –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —à–µ—Ä–∏–Ω–≥ –±–µ–∑ —É—Å–∏–ª–∏–π

---

## 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–∞–≤–æ–≤—ã–µ —Ä–∞–º–∫–∏

### 3.1 Strava API Agreement ‚Äî –∫–ª—é—á–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

> **–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:** –ù–∞—Ä—É—à–µ–Ω–∏–µ —ç—Ç–∏—Ö –ø—Ä–∞–≤–∏–ª = –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç API

#### 3.1.1 –ß—Ç–æ –ó–ê–ü–†–ï–©–ï–ù–û

```
‚ùå –ó–ê–ü–†–ï–©–ï–ù–û:

1. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ë
   "Third-party apps may only display a user's Strava activity 
   data to that specific user"

2. –û–±—É—á–∞—Ç—å ML/AI –º–æ–¥–µ–ª–∏ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö Strava
   "You may not use Strava Data for any model training related 
   to artificial intelligence, machine learning"

3. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
   "You may not process Strava Data, even in an aggregated or 
   de-identified manner, for analytics, analyses, customer 
   insights generation"

4. –•—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à–µ –±–æ–ª–µ–µ 7 –¥–Ω–µ–π
   "No Strava Data shall remain in your cache longer than 
   seven days"

5. –ü—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   "You must delete all Data about an end-user upon such 
   end user's request or termination"
```

#### 3.1.2 –ß—Ç–æ –†–ê–ó–†–ï–®–ï–ù–û

```
‚úÖ –†–ê–ó–†–ï–®–ï–ù–û:

1. –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ï–ì–û —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   ‚Üí –ü—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—É—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
   ‚Üí Riegel, Minetti ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –Ω–µ Strava Data

3. –•—Ä–∞–Ω–∏—Ç—å –ü–†–û–ò–ó–í–û–î–ù–´–ï –¥–∞–Ω–Ω—ã–µ (—Ç–≤–æ–∏ —Ä–∞—Å—á—ë—Ç—ã)
   ‚Üí calculated_gap, predicted_time ‚Äî —ç—Ç–æ —Ç–≤–æ—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

4. –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
   ‚Üí –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–ê–ú —Ä–µ—à–∞–µ—Ç, —à–µ—Ä–∏—Ç—å –ª–∏ —Å–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑

5. "Community Application" –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–¥–æ 9,999 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
   ‚Üí –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —á–ª–µ–Ω–∞–º–∏ –≥—Ä—É–ø–ø—ã –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ 
   —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
```

### 3.2 GDPR/Privacy —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

```
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Privacy Policy:

1. –ö–ê–ö–ò–ï –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞–µ–º
   - –°–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª–µ–π

2. –û–¢–ö–£–î–ê –ø–æ–ª—É—á–∞–µ–º
   - Strava API (—Å OAuth consent)
   - –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (GPX)
   - –†—É—á–Ω–æ–π –≤–≤–æ–¥

3. –ó–ê–ß–ï–ú –∏—Å–ø–æ–ª—å–∑—É–µ–º
   - –†–∞—Å—á—ë—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞

4. –ö–ê–ö –î–û–õ–ì–û —Ö—Ä–∞–Ω–∏–º
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö

5. –ö–û–ú–£ –ø–µ—Ä–µ–¥–∞—ë–º
   - –ù–∏–∫–æ–º—É (–∏–ª–∏ —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å)

6. –ö–ê–ö —É–¥–∞–ª–∏—Ç—å
   - –ö–Ω–æ–ø–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö + –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Strava
```

### 3.3 –¢–∞–±–ª–∏—Ü–∞: –ß—Ç–æ —Ö–æ—Ç–∏–º vs –ß—Ç–æ –º–æ–∂–Ω–æ

| –ß—Ç–æ —Ö–æ—Ç–∏–º | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ |
|-----------|-------------|----------------------|
| ML –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –±–µ–≥—É–Ω–æ–≤ | –ó–∞–ø—Ä–µ—â–µ–Ω–æ API Agreement | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—É—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã (Riegel, Minetti) |
| –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–æ—Ö–æ–∂–∏–º–∏ –∞—Ç–ª–µ—Ç–∞–º–∏ | –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–æ–Ω–æ–∫ |
| –•—Ä–∞–Ω–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é Strava | Max 7 –¥–Ω–µ–π –≤ –∫—ç—à–µ | –•—Ä–∞–Ω–∏—Ç—å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, —É–¥–∞–ª—è—Ç—å —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ |
| –ü–æ–∫–∞–∑–∞—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ | –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∏–º | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —à–µ—Ä–∏—Ç —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
| –£–ª—É—á—à–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –¥–∞–Ω–Ω—ã—Ö | ML –∑–∞–ø—Ä–µ—â—ë–Ω | –°–æ–±–∏—Ä–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–æ–∫ (user input), –Ω–µ Strava data |

---

## 4. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 4.1 –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                           –ö–õ–ò–ï–ù–¢                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  ‚îÇ Telegram    ‚îÇ  ‚îÇ Web App     ‚îÇ  ‚îÇ Mobile      ‚îÇ                  ‚îÇ
‚îÇ  ‚îÇ Mini App    ‚îÇ  ‚îÇ (React)     ‚îÇ  ‚îÇ (–±—É–¥—É—â–µ–µ)   ‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                ‚îÇ                ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        API GATEWAY                                   ‚îÇ
‚îÇ                     (FastAPI / Python)                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ /predict        ‚îÇ  ‚îÇ /athlete        ‚îÇ  ‚îÇ /gpx            ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ ‚îÇ  ‚îÇ –î–∞–Ω–Ω—ã–µ –∞—Ç–ª–µ—Ç–∞   ‚îÇ  ‚îÇ –ó–∞–≥—Ä—É–∑–∫–∞ GPX    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ           ‚îÇ                    ‚îÇ                    ‚îÇ               ‚îÇ
‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                ‚îÇ                                     ‚îÇ
‚îÇ                                ‚ñº                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                    PREDICTION ENGINE                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ GPX Parser   ‚îÇ  ‚îÇ Riegel Calc  ‚îÇ  ‚îÇ Minetti GAP  ‚îÇ        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ + DEM Fix    ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                    ‚îÇ                    ‚îÇ
          ‚ñº                    ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MongoDB         ‚îÇ  ‚îÇ Strava API      ‚îÇ  ‚îÇ DEM Service     ‚îÇ
‚îÇ (user data,     ‚îÇ  ‚îÇ (OAuth,         ‚îÇ  ‚îÇ (SRTM elevation ‚îÇ
‚îÇ  predictions)   ‚îÇ  ‚îÇ  activities)    ‚îÇ  ‚îÇ  correction)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.2 –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–≤–æ–π–Ω–æ–≥–æ –≤–≤–æ–¥–∞

```
–í–ê–†–ò–ê–ù–¢ –ê: –ë–µ–∑ Strava (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç:                        ‚îÇ
‚îÇ - GPX —Ñ–∞–π–ª —Ç—Ä–∞—Å—Å—ã                           ‚îÇ
‚îÇ - –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 10–ö (–≤—Ä—É—á–Ω—É—é)         ‚îÇ
‚îÇ - –í–µ—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)                         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ –°–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:                          ‚îÇ
‚îÇ - –ü—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏                           ‚îÇ
‚îÇ - –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–í–ê–†–ò–ê–ù–¢ –ë: –°–æ Strava (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç:                    ‚îÇ
‚îÇ - Strava OAuth                              ‚îÇ
‚îÇ - GPX —Ñ–∞–π–ª —Ç—Ä–∞—Å—Å—ã                           ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç:              ‚îÇ
‚îÇ - Best efforts (5K, 10K, HM, M)             ‚îÇ
‚îÇ - –ò—Å—Ç–æ—Ä–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ (6 –º–µ—Å)                ‚îÇ
‚îÇ - –°—Ä–µ–¥–Ω–∏–π –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º                   ‚îÇ
‚îÇ - HR –∑–æ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)                       ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ –°–µ—Ä–≤–∏—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:                          ‚îÇ
‚îÇ - –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑                      ‚îÇ
‚îÇ - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor               ‚îÇ
‚îÇ - –ê–Ω–∞–ª–∏–∑ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**–ó–∞—á–µ–º –¥–≤–æ–π–Ω–æ–π –≤–≤–æ–¥:**
1. –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö, –¥–∞–∂–µ –±–µ–∑ Strava
2. –°–Ω–∏–∂–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç API (–µ—Å–ª–∏ Strava –∑–∞–∫—Ä–æ–µ—Ç –¥–æ—Å—Ç—É–ø)
3. –ü–æ–∑–≤–æ–ª—è–µ—Ç A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å

### 4.3 –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------------|------------|
| API Server | FastAPI (Python) | REST API, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| GPX Parser | gpxpy | –ü–∞—Ä—Å–∏–Ω–≥ GPX, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ elevation profile |
| DEM Service | Open-Elevation API ‚Üí srtm.py (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ) | –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –≤—ã—Å–æ—Ç—ã |
| Prediction Engine | NumPy, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã | –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ |
| Database | **PostgreSQL + PostGIS** | –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–≥–Ω–æ–∑–æ–≤, geo-queries |
| Cache | In-memory (MVP) ‚Üí Redis (–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ) | –ö—ç—à Strava –¥–∞–Ω–Ω—ã—Ö (7 –¥–Ω–µ–π) |
| Auth | Telegram (—Ç—É—Ä–∏—Å—Ç—ã) + Strava OAuth 2.0 (–±–µ–≥—É–Ω—ã) | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| Frontend | React / Telegram Mini App | UI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| Hosting | Railway | –î–µ–ø–ª–æ–π backend + frontend |

> **üìù –†–µ—à–µ–Ω–∏—è –ø–æ —Å—Ç–µ–∫—É (–æ–±—Å—É–∂–¥–µ–Ω–æ 2025-01-09):**
> - **PostgreSQL –≤–º–µ—Å—Ç–æ MongoDB** ‚Äî –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º Ayda Run, PostGIS –¥–ª—è geo-queries
> - **–ë–µ–∑ Redis –¥–ª—è MVP** ‚Äî in-memory rate limiting –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
> - **Open-Elevation API –¥–ª—è MVP** ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è; srtm.py (~14GB) –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
> - **Share images ‚Äî –ø–æ—Å–ª–µ MVP** ‚Äî —É–±—Ä–∞–Ω–æ –∏–∑ scope –ø–µ—Ä–≤—ã—Ö —Ñ–∞–∑

---

## 5. –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Ñ–æ—Ä–º—É–ª—ã

### 5.1 –§–æ—Ä–º—É–ª–∞ Riegel ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –¥—Ä—É–≥—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é

**–ò—Å—Ç–æ—á–Ω–∏–∫:** Riegel, P.S. (1981). "Athletic Records and Human Endurance"

```python
def riegel_prediction(known_time: float, known_distance: float, 
                      target_distance: float, fatigue_factor: float = 1.06) -> float:
    """
    –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è –Ω–∞ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
    
    Args:
        known_time: –ò–∑–≤–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10–ö –∑–∞ 3000 —Å–µ–∫)
        known_distance: –ò–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10)
        target_distance: –¶–µ–ª–µ–≤–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 42.195)
        fatigue_factor: –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å—Ç–∞–ª–æ—Å—Ç–∏ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç 1.06, 
                        –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π 1.03-1.15)
    
    Returns:
        –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    
    –§–æ—Ä–º—É–ª–∞:
        T2 = T1 √ó (D2/D1)^fatigue_factor
    
    –ü—Ä–∏–º–µ—Ä:
        10–ö –∑–∞ 50 –º–∏–Ω ‚Üí –º–∞—Ä–∞—Ñ–æ–Ω –∑–∞ ~3:48
        riegel_prediction(3000, 10, 42.195) = 13680 —Å–µ–∫ = 3:48:00
    """
    return known_time * (target_distance / known_distance) ** fatigue_factor
```

**–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor:**

```python
def calculate_personal_fatigue_factor(results: list[dict]) -> float:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å—Ç–∞–ª–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ 
    –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    Args:
        results: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä:
                 [{"distance": 5, "time": 1320},   # 5–ö –∑–∞ 22:00
                  {"distance": 10, "time": 2820},  # 10–ö –∑–∞ 47:00
                  {"distance": 21.1, "time": 6480}] # HM –∑–∞ 1:48:00
    
    Returns:
        –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor (–æ–±—ã—á–Ω–æ 1.03-1.15)
    """
    from math import log
    
    factors = []
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
    sorted_results = sorted(results, key=lambda x: x["distance"])
    
    # –í—ã—á–∏—Å–ª—è–µ–º factor –º–µ–∂–¥—É –∫–∞–∂–¥–æ–π –ø–∞—Ä–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–π
    for i in range(len(sorted_results) - 1):
        r1 = sorted_results[i]
        r2 = sorted_results[i + 1]
        
        # factor = log(T2/T1) / log(D2/D1)
        factor = log(r2["time"] / r1["time"]) / log(r2["distance"] / r1["distance"])
        factors.append(factor)
    
    # –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if factors:
        return sum(factors) / len(factors)
    else:
        return 1.06  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
```

### 5.2 –§–æ—Ä–º—É–ª–∞ Minetti ‚Äî –≤–ª–∏—è–Ω–∏–µ —É–∫–ª–æ–Ω–∞ –Ω–∞ —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç—ã

**–ò—Å—Ç–æ—á–Ω–∏–∫:** Minetti, A.E. et al. (2002). "Energy cost of walking and running at extreme uphill and downhill slopes"

```python
import numpy as np

def minetti_energy_cost(gradient: float) -> float:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç –Ω–∞ —É–∫–ª–æ–Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–ª–æ—Å–∫–æ–π 
    –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏.
    
    Args:
        gradient: –£–∫–ª–æ–Ω –≤ –¥–æ–ª—è—Ö (0.10 = 10%, -0.05 = -5%)
    
    Returns:
        –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç (1.0 = –ø–ª–æ—Å–∫–∞—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å)
    
    –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
        - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–∞ —Ç—Ä–µ–¥–º–∏–ª–µ —Å 10 —ç–ª–∏—Ç–Ω—ã–º–∏ —Ç—Ä–µ–π–ª—Ä–∞–Ω–Ω–µ—Ä–∞–º–∏
        - –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–Ω–æ—Å—Ç—å –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
        - –ü–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –∫—Ä—É—Ç—ã—Ö —Å–ø—É—Å–∫–∞—Ö
    """
    g = gradient
    
    # –ü–æ–ª–∏–Ω–æ–º 5-–π —Å—Ç–µ–ø–µ–Ω–∏ –∏–∑ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è Minetti
    # –î–∞–µ—Ç —ç–Ω–µ—Ä–≥–æ–∑–∞—Ç—Ä–∞—Ç—ã –≤ ml O2 / kg / m
    cost = (155.4 * g**5 
            - 30.4 * g**4 
            - 43.3 * g**3 
            + 46.3 * g**2 
            + 19.5 * g 
            + 3.6)
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ –ø–ª–æ—Å–∫–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (gradient = 0 ‚Üí cost ‚âà 3.6)
    flat_cost = 3.6
    
    return cost / flat_cost


def strava_adjusted_gap(gradient: float) -> float:
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å GAP –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö Strava (2017).
    –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É Minetti —Å –∫—Ä—É—Ç—ã–º–∏ —Å–ø—É—Å–∫–∞–º–∏.
    
    –ò—Å—Ç–æ—á–Ω–∏–∫: Strava Engineering Blog "An Improved GAP Model"
    
    Args:
        gradient: –£–∫–ª–æ–Ω –≤ –¥–æ–ª—è—Ö
    
    Returns:
        –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ç–µ–º–ø–∞ (1.0 = –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    
    –û—Ç–ª–∏—á–∏—è –æ—Ç Minetti:
        - –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ —Å–ø—É—Å–∫–µ: -10% (–Ω–µ -50%)
        - –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å–ø—É—Å–∫: -9% –≥—Ä–∞–¥–∏–µ–Ω—Ç (–Ω–µ -20%)
    """
    if gradient >= 0:
        # –ü–æ–¥—ä—ë–º: –ø—Ä–∏–º–µ—Ä–Ω–æ +12% –Ω–∞ –∫–∞–∂–¥—ã–µ 1% —É–∫–ª–æ–Ω–∞
        # (–±–ª–∏–∑–∫–æ –∫ Minetti)
        return 1 + (gradient * 12)
    else:
        # –°–ø—É—Å–∫: –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ -12% –ø—Ä–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–µ -9%
        # –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç
        optimal_descent = -0.09
        max_benefit = 0.88  # –º–∞–∫—Å–∏–º—É–º 12% —É—Å–∫–æ—Ä–µ–Ω–∏—è
        
        if gradient >= optimal_descent:
            # –î–æ –æ–ø—Ç–∏–º—É–º–∞: –ª–∏–Ω–µ–π–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ
            return 1 + (gradient / optimal_descent) * (1 - max_benefit)
        else:
            # –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º—É–º–∞: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç
            # –ü—Ä–∏ -18% —É–∂–µ –Ω–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
            overshoot = gradient - optimal_descent
            return max_benefit + abs(overshoot) * 1.3  # –≤–æ–∑–≤—Ä–∞—Ç –∫ 1.0 –∏ –≤—ã—à–µ
```

### 5.3 –ü–æ–ª–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è

```python
from dataclasses import dataclass
from typing import List, Optional
import gpxpy

@dataclass
class Segment:
    """–°–µ–≥–º–µ–Ω—Ç —Ç—Ä–∞—Å—Å—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞"""
    distance_m: float      # –î–ª–∏–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –º–µ—Ç—Ä–∞—Ö
    elevation_start: float # –í—ã—Å–æ—Ç–∞ –≤ –Ω–∞—á–∞–ª–µ
    elevation_end: float   # –í—ã—Å–æ—Ç–∞ –≤ –∫–æ–Ω—Ü–µ
    gradient: float        # –£–∫–ª–æ–Ω (0.10 = 10%)

@dataclass  
class PredictionResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞"""
    total_time_seconds: float
    total_distance_km: float
    total_elevation_gain_m: float
    total_elevation_loss_m: float
    segments: List[dict]  # –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
    confidence_range: tuple  # (min, max) –≤ —Å–µ–∫—É–Ω–¥–∞—Ö


def parse_gpx_to_segments(gpx_content: str, 
                          min_segment_length: float = 100) -> List[Segment]:
    """
    –ü–∞—Ä—Å–∏—Ç GPX —Ñ–∞–π–ª –∏ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
    
    Args:
        gpx_content: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ GPX —Ñ–∞–π–ª–∞
        min_segment_length: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ –º–µ—Ç—Ä–∞—Ö
                           (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã = —à—É–º)
    
    Returns:
        –°–ø–∏—Å–æ–∫ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ —Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–µ–π –∏ —É–∫–ª–æ–Ω–æ–º
    """
    gpx = gpxpy.parse(gpx_content)
    segments = []
    
    for track in gpx.tracks:
        for segment in track.segments:
            points = segment.points
            
            current_distance = 0
            segment_start_idx = 0
            
            for i in range(1, len(points)):
                prev_point = points[i-1]
                curr_point = points[i]
                
                # –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
                dist = prev_point.distance_2d(curr_point)
                current_distance += dist
                
                # –ö–æ–≥–¥–∞ –Ω–∞–∫–æ–ø–∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ ‚Äî —Å–æ–∑–¥–∞—ë–º —Å–µ–≥–º–µ–Ω—Ç
                if current_distance >= min_segment_length:
                    start_point = points[segment_start_idx]
                    end_point = curr_point
                    
                    elevation_change = end_point.elevation - start_point.elevation
                    gradient = elevation_change / current_distance if current_distance > 0 else 0
                    
                    segments.append(Segment(
                        distance_m=current_distance,
                        elevation_start=start_point.elevation,
                        elevation_end=end_point.elevation,
                        gradient=gradient
                    ))
                    
                    current_distance = 0
                    segment_start_idx = i
    
    return segments


def predict_race_time(
    gpx_content: str,
    athlete_flat_pace: float,  # —Å–µ–∫/–∫–º –Ω–∞ –ø–ª–æ—Å–∫–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
    fatigue_factor: float = 1.06,
    use_strava_gap_model: bool = True,
    technical_terrain: bool = False
) -> PredictionResult:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–±–µ–≥–∞.
    
    Args:
        gpx_content: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ GPX —Ñ–∞–π–ª–∞
        athlete_flat_pace: –¢–µ–º–ø –∞—Ç–ª–µ—Ç–∞ –Ω–∞ –ø–ª–æ—Å–∫–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ (—Å–µ–∫/–∫–º)
                          –ù–∞–ø—Ä–∏–º–µ—Ä, 300 = 5:00/–∫–º
        fatigue_factor: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å—Ç–∞–ª–æ—Å—Ç–∏
        use_strava_gap_model: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å Strava 
                              (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç—Ä–µ–π–ª–æ–≤)
        technical_terrain: –§–ª–∞–≥ —Ç–µ—Ö–Ω–∏—á–Ω–æ–π —Ç—Ä–∞—Å—Å—ã 
                          (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤—ã–≥–æ–¥—É –æ—Ç —Å–ø—É—Å–∫–æ–≤)
    
    Returns:
        PredictionResult —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º –∏ —Ä–∞—Å–∫–ª–∞–¥–∫–æ–π
    """
    segments = parse_gpx_to_segments(gpx_content)
    
    total_time = 0
    total_distance = 0
    elevation_gain = 0
    elevation_loss = 0
    segment_results = []
    
    for seg in segments:
        # –í—ã–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª—å GAP
        if use_strava_gap_model:
            pace_adjustment = strava_adjusted_gap(seg.gradient)
        else:
            pace_adjustment = minetti_energy_cost(seg.gradient)
        
        # –î–ª—è —Ç–µ—Ö–Ω–∏—á–Ω—ã—Ö —Ç—Ä–∞—Å—Å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã–≥–æ–¥—É –æ—Ç —Å–ø—É—Å–∫–æ–≤
        if technical_terrain and pace_adjustment < 1.0:
            pace_adjustment = max(pace_adjustment, 0.95)  # –º–∞–∫—Å–∏–º—É–º 5% —É—Å–∫–æ—Ä–µ–Ω–∏—è
        
        # –†–∞—Å—á—ë—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–µ–≥–º–µ–Ω—Ç–∞
        segment_distance_km = seg.distance_m / 1000
        segment_pace = athlete_flat_pace * pace_adjustment
        segment_time = segment_pace * segment_distance_km
        
        total_time += segment_time
        total_distance += segment_distance_km
        
        # –ü–æ–¥—Å—á—ë—Ç –Ω–∞–±–æ—Ä–∞/—Å–±—Ä–æ—Å–∞ –≤—ã—Å–æ—Ç—ã
        if seg.elevation_end > seg.elevation_start:
            elevation_gain += seg.elevation_end - seg.elevation_start
        else:
            elevation_loss += seg.elevation_start - seg.elevation_end
        
        segment_results.append({
            "distance_km": round(segment_distance_km, 2),
            "gradient_percent": round(seg.gradient * 100, 1),
            "pace_sec_per_km": round(segment_pace, 0),
            "segment_time_sec": round(segment_time, 0)
        })
    
    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –¥–ª–∏–Ω—É –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (fatigue)
    # –ü—Ä–∏–º–µ–Ω—è–µ–º Riegel –¥–ª—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–π > 10–∫–º
    if total_distance > 10:
        base_time_10k = athlete_flat_pace * 10  # –≤—Ä–µ–º—è –Ω–∞ 10–ö
        fatigue_multiplier = (total_distance / 10) ** (fatigue_factor - 1)
        total_time *= fatigue_multiplier
    
    # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (¬±10% –¥–ª—è —Ç—Ä–µ–π–ª–æ–≤)
    confidence_min = total_time * 0.90
    confidence_max = total_time * 1.10
    
    return PredictionResult(
        total_time_seconds=round(total_time, 0),
        total_distance_km=round(total_distance, 2),
        total_elevation_gain_m=round(elevation_gain, 0),
        total_elevation_loss_m=round(elevation_loss, 0),
        segments=segment_results,
        confidence_range=(round(confidence_min, 0), round(confidence_max, 0))
    )
```

### 5.4 –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –≤—ã—Å–æ—Ç—ã GPX —á–µ—Ä–µ–∑ DEM

```python
import srtm

def correct_gpx_elevation(gpx_content: str, smooth: bool = True) -> str:
    """
    –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—ã—Å–æ—Ç—ã –≤ GPX —Ñ–∞–π–ª–µ –∏—Å–ø–æ–ª—å–∑—É—è SRTM DEM.
    
    –ü—Ä–æ–±–ª–µ–º–∞: GPS-–≤—ã—Å–æ—Ç–∞ –∏–º–µ–µ—Ç –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å ¬±10-50–º, —Å–æ–∑–¥–∞—ë—Ç "–ª–æ–∂–Ω—ã–µ —Ö–æ–ª–º—ã"
    –†–µ—à–µ–Ω–∏–µ: –ó–∞–º–µ–Ω—è–µ–º GPS-–≤—ã—Å–æ—Ç—É –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑ Digital Elevation Model
    
    Args:
        gpx_content: –ò—Å—Ö–æ–¥–Ω—ã–π GPX —Ñ–∞–π–ª
        smooth: –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (—É–±–∏—Ä–∞–µ—Ç —à—É–º DEM –Ω–∞ —Å–µ—Ä–ø–∞–Ω—Ç–∏–Ω–∞—Ö)
    
    Returns:
        GPX —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤—ã—Å–æ—Ç–æ–π
    """
    gpx = gpxpy.parse(gpx_content)
    elevation_data = srtm.get_data()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≤—ã—Å–æ—Ç—É –∏–∑ DEM
    elevation_data.add_elevations(gpx, smooth=smooth)
    
    return gpx.to_xml()


def calculate_elevation_gain(points: list, threshold: float = 3.0) -> float:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π —à—É–º–∞.
    
    –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–æ—Å—Ç–æ–µ —Å—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—ä—ë–º–æ–≤ –¥–∞—ë—Ç –∑–∞–≤—ã—à–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
              –∏–∑-–∑–∞ —à—É–º–∞ GPS (¬±3–º —Å–æ–∑–¥–∞—ë—Ç "–ª–æ–∂–Ω—ã–µ" –ø–æ–¥—ä—ë–º—ã –Ω–∞ –ø–ª–æ—Å–∫–æ–π –¥–æ—Ä–æ–≥–µ)
    
    –†–µ—à–µ–Ω–∏–µ: –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã—Å–æ—Ç—ã –º–µ–Ω—å—à–µ threshold
    
    Args:
        points: –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ —Å elevation
        threshold: –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è —É—á—ë—Ç–∞ (–º–µ—Ç—Ä—ã)
    
    Returns:
        –°—É–º–º–∞—Ä–Ω—ã–π –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã –≤ –º–µ—Ç—Ä–∞—Ö
    """
    if not points:
        return 0
    
    gain = 0
    current_low = points[0].elevation
    
    for point in points[1:]:
        if point.elevation - current_low > threshold:
            # –ó–Ω–∞—á–∏–º—ã–π –ø–æ–¥—ä—ë–º ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º
            gain += point.elevation - current_low
            current_low = point.elevation
        elif point.elevation < current_low:
            # –°–ø—É—Å–∫ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º baseline
            current_low = point.elevation
    
    return gain
```

### 5.5 –†–µ–∂–∏–º –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ (–±–µ–∑ –±–µ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

#### 5.5.1 –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ê–ª–º–∞—Ç—ã ‚Äî –Ω–µ –±–µ–≥—É–Ω—ã, –∞ —Ç—É—Ä–∏—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥—É—Ç –≤ –≥–æ—Ä—ã –Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö. –£ –Ω–∏—Ö –Ω–µ—Ç Strava, –Ω–µ—Ç –±–µ–≥–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏ –æ–Ω–∏ —á–∞—Å—Ç–æ –Ω–µ–¥–æ–æ—Ü–µ–Ω–∏–≤–∞—é—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞.

```
–ë–µ–≥—É–Ω: "–ú–æ–π 10–ö –∑–∞ 50 –º–∏–Ω—É—Ç" ‚Üí –º–æ–∂–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ç–µ–º–ø
–¢—É—Ä–∏—Å—Ç: "–Ø –ø—Ä–æ—Å—Ç–æ —Ö–æ–∂—É –∏–Ω–æ–≥–¥–∞" ‚Üí –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
```

**–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ª—é–¥–∏ –≤—ã—Ö–æ–¥—è—Ç —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ, –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –¥–æ —Ç–µ–º–Ω–æ—Ç—ã, –ø–æ–ø–∞–¥–∞—é—Ç –≤ –±–µ–¥—É.

#### 5.5.2 –†–µ—à–µ–Ω–∏–µ: –ü—Ä–∞–≤–∏–ª–æ –ù–µ–π—Å–º–∏—Ç–∞ + –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–∞–≤–∏–ª–æ –ù–µ–π—Å–º–∏—Ç–∞ (1892)** ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –ø–µ—à–µ–≥–æ —Ç—É—Ä–∏–∑–º–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ø–∞—Å–∞—Ç–µ–ª—è–º–∏ –∏ –≥–æ—Ä–Ω—ã–º–∏ –≥–∏–¥–∞–º–∏:

```python
def naismith_time(distance_km: float, elevation_gain_m: float) -> float:
    """
    –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –ù–µ–π—Å–º–∏—Ç–∞:
    - 5 –∫–º/—á–∞—Å –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    - +1 —á–∞—Å –Ω–∞ –∫–∞–∂–¥—ã–µ 600–º –Ω–∞–±–æ—Ä–∞ –≤—ã—Å–æ—Ç—ã
    
    –ò—Å—Ç–æ—á–Ω–∏–∫: Naismith, W.W. (1892) Scottish Mountaineering Club Journal
    
    Returns: –≤—Ä–µ–º—è –≤ —á–∞—Å–∞—Ö
    """
    horizontal_time = distance_km / 5.0  # —á–∞—Å—ã
    vertical_time = elevation_gain_m / 600.0  # —á–∞—Å—ã
    
    return horizontal_time + vertical_time


def naismith_with_descent(distance_km: float, 
                          elevation_gain_m: float,
                          elevation_loss_m: float) -> float:
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å —É—á—ë—Ç–æ–º —Å–ø—É—Å–∫–æ–≤ (Tranter's corrections, 1970):
    - –ü–æ–ª–æ–≥–∏–π —Å–ø—É—Å–∫ (<12¬∞): –Ω–µ–º–Ω–æ–≥–æ —É—Å–∫–æ—Ä—è–µ—Ç
    - –ö—Ä—É—Ç–æ–π —Å–ø—É—Å–∫ (>12¬∞): –∑–∞–º–µ–¥–ª—è–µ—Ç (–Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –∫–æ–ª–µ–Ω–∏, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å)
    
    Args:
        distance_km: –û–±—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
        elevation_gain_m: –°—É–º–º–∞—Ä–Ω—ã–π –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã
        elevation_loss_m: –°—É–º–º–∞—Ä–Ω—ã–π —Å–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã
    
    Returns:
        –í—Ä–µ–º—è –≤ —á–∞—Å–∞—Ö
    """
    base_time = naismith_time(distance_km, elevation_gain_m)
    
    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Å–ø—É—Å–∫–æ–≤
    # –ö—Ä—É—Ç–æ–π —Å–ø—É—Å–∫ –∑–∞–º–µ–¥–ª—è–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ 10 –º–∏–Ω / 300–º —Å–±—Ä–æ—Å–∞
    if elevation_loss_m > 0:
        descent_factor = elevation_loss_m / 300  # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "–±–ª–æ–∫–æ–≤" –ø–æ 300–º
        descent_time = descent_factor * (10/60)  # 10 –º–∏–Ω = 10/60 —á–∞—Å–∞
        base_time += descent_time
    
    return base_time
```

#### 5.5.3 –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∏—Å—Ç–∞ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö

–í–º–µ—Å—Ç–æ –∑–∞–ø—Ä–æ—Å–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ 10–ö, —Å–æ–±–∏—Ä–∞–µ–º –∫–æ—Å–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:

```python
from enum import Enum
from dataclasses import dataclass
from typing import List

class ExperienceLevel(Enum):
    """–£—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ —Ç—É—Ä–∏—Å—Ç–∞"""
    BEGINNER = "beginner"      # –ù–æ–≤–∏—á–æ–∫: —Ä–µ–¥–∫–æ —Ö–æ–¥–∏—Ç, –æ—Ñ–∏—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Üí 1.5x
    CASUAL = "casual"          # –õ—é–±–∏—Ç–µ–ª—å: –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –≥–æ–¥ ‚Üí 1.2x
    REGULAR = "regular"        # –†–µ–≥—É–ª—è—Ä–Ω–æ: –∫–∞–∂–¥—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Üí 1.0x (–±–∞–∑–æ–≤—ã–π)
    EXPERIENCED = "experienced" # –û–ø—ã—Ç–Ω—ã–π: –º–Ω–æ–≥–æ–¥–Ω–µ–≤–∫–∏, –≤—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ ‚Üí 0.85x

class BackpackWeight(Enum):
    """–í–µ—Å —Ä—é–∫–∑–∞–∫–∞"""
    LIGHT = "light"    # <5 –∫–≥ (–≤–æ–¥–∞, –ø–µ—Ä–µ–∫—É—Å) ‚Üí 1.0x
    MEDIUM = "medium"  # 5-10 –∫–≥ (–æ–¥–Ω–æ–¥–Ω–µ–≤–Ω—ã–π –ø–æ—Ö–æ–¥) ‚Üí 1.1x
    HEAVY = "heavy"    # >10 –∫–≥ (–º–Ω–æ–≥–æ–¥–Ω–µ–≤–∫–∞) ‚Üí 1.25x

@dataclass
class HikerProfile:
    """–ü—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞"""
    experience: ExperienceLevel
    backpack: BackpackWeight
    group_size: int
    max_altitude_m: float  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    has_children: bool = False
    has_elderly: bool = False
    first_time_altitude: bool = False  # –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∞ –≤—ã—Å–æ—Ç–µ >3000–º


def get_hiker_multiplier(profile: HikerProfile) -> float:
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –æ–±—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∞.
    
    –í—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–µ—Ä–µ–º–Ω–æ–∂–∞—é—Ç—Å—è, —Ç.–∫. —Ñ–∞–∫—Ç–æ—Ä—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è.
    
    Returns:
        –ú–Ω–æ–∂–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ (1.0 = –±–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –ø–æ –ù–µ–π—Å–º–∏—Ç—É)
    """
    
    # –ë–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ –æ–ø—ã—Ç—É
    experience_mult = {
        ExperienceLevel.BEGINNER: 1.5,     # –ù–∞ 50% –º–µ–¥–ª–µ–Ω–Ω–µ–µ
        ExperienceLevel.CASUAL: 1.2,       # –ù–∞ 20% –º–µ–¥–ª–µ–Ω–Ω–µ–µ
        ExperienceLevel.REGULAR: 1.0,      # –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è
        ExperienceLevel.EXPERIENCED: 0.85  # –ù–∞ 15% –±—ã—Å—Ç—Ä–µ–µ
    }
    
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ –≤–µ—Å—É —Ä—é–∫–∑–∞–∫–∞
    backpack_mult = {
        BackpackWeight.LIGHT: 1.0,
        BackpackWeight.MEDIUM: 1.1,
        BackpackWeight.HEAVY: 1.25
    }
    
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≥—Ä—É–ø–ø—ã (–∂–¥—ë–º –æ—Ç—Å—Ç–∞—é—â–∏—Ö, —á–∞—â–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
    if profile.group_size <= 2:
        group_mult = 1.0
    elif profile.group_size <= 5:
        group_mult = 1.1
    else:
        group_mult = 1.3  # –ë–æ–ª—å—à–∏–µ –≥—Ä—É–ø–ø—ã –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–µ
    
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤—ã—Å–æ—Ç—ã (–≥–∏–ø–æ–∫—Å–∏—è, –∞–∫–∫–ª–∏–º–∞—Ç–∏–∑–∞—Ü–∏—è)
    # –û—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –ê–ª–º–∞—Ç—ã: –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –¥–æ 3500-4000–º
    if profile.max_altitude_m < 2500:
        altitude_mult = 1.0
    elif profile.max_altitude_m < 3000:
        altitude_mult = 1.1
    elif profile.max_altitude_m < 3500:
        altitude_mult = 1.2
    else:
        altitude_mult = 1.35  # –í—ã—à–µ 3500–º ‚Äî —Å–µ—Ä—å—ë–∑–Ω–∞—è –≤—ã—Å–æ—Ç–∞
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
    extra_mult = 1.0
    if profile.has_children:
        extra_mult *= 1.4  # –î–µ—Ç–∏ —Å–∏–ª—å–Ω–æ –∑–∞–º–µ–¥–ª—è—é—Ç
    if profile.has_elderly:
        extra_mult *= 1.3
    if profile.first_time_altitude and profile.max_altitude_m > 3000:
        extra_mult *= 1.15  # –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∞ –≤—ã—Å–æ—Ç–µ ‚Äî –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ
    
    # –û–±—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
    total = (
        experience_mult[profile.experience] *
        backpack_mult[profile.backpack] *
        group_mult *
        altitude_mult *
        extra_mult
    )
    
    return round(total, 2)
```

#### 5.5.4 –ü–æ–ª–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∞

```python
from dataclasses import dataclass
from typing import List, Optional
from datetime import datetime, timedelta

@dataclass
class HikePrediction:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è –ø–æ—Ö–æ–¥–∞"""
    estimated_time_hours: float      # –†–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è
    safe_time_hours: float           # –í—Ä–µ–º—è —Å –∑–∞–ø–∞—Å–æ–º (+20%)
    recommended_start: str           # –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞
    recommended_turnaround: str      # –í—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (–¥–ª—è —Ä–∞–¥–∏–∞–ª—å–Ω—ã—Ö)
    warnings: List[dict]             # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    breakdown: dict                  # –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —É—á–∞—Å—Ç–∫–∞–º


def predict_hike_time(
    gpx_content: str,
    profile: HikerProfile,
    is_round_trip: bool = True,
    sunrise: str = "06:00",
    sunset: str = "20:00"
) -> HikePrediction:
    """
    –ü—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Ö–æ–¥–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∞ –±–µ–∑ –±–µ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    Args:
        gpx_content: GPX —Ñ–∞–π–ª –º–∞—Ä—à—Ä—É—Ç–∞
        profile: –ü—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞
        is_round_trip: True –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ –ø–æ —Ç–æ–π –∂–µ —Ç—Ä–æ–ø–µ
        sunrise: –í—Ä–µ–º—è –≤–æ—Å—Ö–æ–¥–∞ (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å–≤–µ—Ç–æ–≤–æ–≥–æ –¥–Ω—è)
        sunset: –í—Ä–µ–º—è –∑–∞–∫–∞—Ç–∞
    
    Returns:
        HikePrediction —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏
    """
    
    # 1. –ü–∞—Ä—Å–∏–º GPX –∏ –ø–æ–ª—É—á–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    course = parse_gpx_course(gpx_content)
    
    # 2. –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –ø–æ –ù–µ–π—Å–º–∏—Ç—É
    base_time_hours = naismith_with_descent(
        distance_km=course.distance_km,
        elevation_gain_m=course.elevation_gain_m,
        elevation_loss_m=course.elevation_loss_m
    )
    
    # –ï—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ ‚Äî —É–¥–≤–∞–∏–≤–∞–µ–º (–Ω–æ –æ–±—Ä–∞—Ç–Ω–æ –æ–±—ã—á–Ω–æ –±—ã—Å—Ç—Ä–µ–µ)
    if is_round_trip:
        # –û–±—Ä–∞—Ç–Ω—ã–π –ø—É—Ç—å: —Å–ø—É—Å–∫ –≤–º–µ—Å—Ç–æ –ø–æ–¥—ä—ë–º–∞, –Ω–æ –Ω–æ–≥–∏ —É–∂–µ —É—Å—Ç–∞–ª–∏
        return_time = naismith_with_descent(
            distance_km=course.distance_km,
            elevation_gain_m=course.elevation_loss_m,  # Swap!
            elevation_loss_m=course.elevation_gain_m
        )
        return_time *= 0.9  # –û–±—ã—á–Ω–æ –Ω–∞ 10% –±—ã—Å—Ç—Ä–µ–µ (–∑–Ω–∞–∫–æ–º–∞—è —Ç—Ä–æ–ø–∞)
        base_time_hours += return_time
    
    # 3. –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞
    multiplier = get_hiker_multiplier(profile)
    adjusted_time = base_time_hours * multiplier
    
    # 4. –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç–¥—ã—Ö
    # –ù–æ–≤–∏—á–∫–∏: 10 –º–∏–Ω –æ—Ç–¥—ã—Ö–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
    # –û–ø—ã—Ç–Ω—ã–µ: 5 –º–∏–Ω –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
    if profile.experience == ExperienceLevel.BEGINNER:
        rest_time = (adjusted_time // 1) * (15/60)  # 15 –º–∏–Ω/—á–∞—Å
    elif profile.experience == ExperienceLevel.CASUAL:
        rest_time = (adjusted_time // 1) * (10/60)  # 10 –º–∏–Ω/—á–∞—Å
    else:
        rest_time = (adjusted_time // 2) * (10/60)  # 10 –º–∏–Ω/2 —á–∞—Å–∞
    
    adjusted_time += rest_time
    
    # 5. –í—Ä–µ–º—è –Ω–∞ –æ–±–µ–¥ (–µ—Å–ª–∏ –ø–æ—Ö–æ–¥ >4 —á–∞—Å–æ–≤)
    if adjusted_time > 4:
        adjusted_time += 0.5  # 30 –º–∏–Ω—É—Ç –Ω–∞ –æ–±–µ–¥
    
    # 6. –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø–∞—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    safe_time = adjusted_time * 1.2  # +20%
    
    # 7. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞
    # –¶–µ–ª—å: –≤–µ—Ä–Ω—É—Ç—å—Å—è –º–∏–Ω–∏–º—É–º –∑–∞ —á–∞—Å –¥–æ –∑–∞–∫–∞—Ç–∞
    sunset_hour = int(sunset.split(":")[0])
    target_return = sunset_hour - 1  # –ó–∞ —á–∞—Å –¥–æ –∑–∞–∫–∞—Ç–∞
    
    recommended_start_hour = target_return - safe_time
    
    if recommended_start_hour < 5:
        start_warning = "‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–Ω—è!"
        recommended_start = "05:00 (–†–ê–ù–û!)"
    else:
        recommended_start = f"{int(recommended_start_hour):02d}:00"
        start_warning = None
    
    # 8. –í—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞ (–¥–ª—è —Ä–∞–¥–∏–∞–ª—å–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤)
    # –ù–µ –±–æ–ª—å—à–µ 40% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–æ–¥—ä—ë–º, –∏–Ω–∞—á–µ –Ω–µ —É—Å–ø–µ—Ç—å –¥–æ —Ç–µ–º–Ω–æ—Ç—ã
    if is_round_trip:
        ascent_portion = 0.45  # 45% –Ω–∞ –ø–æ–¥—ä—ë–º
        max_ascent_time = safe_time * ascent_portion
        turnaround_hour = int(recommended_start_hour) + max_ascent_time
        recommended_turnaround = f"{int(turnaround_hour):02d}:{int((turnaround_hour % 1) * 60):02d}"
    else:
        recommended_turnaround = None
    
    # 9. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    warnings = generate_safety_warnings(course, profile, adjusted_time)
    if start_warning:
        warnings.insert(0, {"level": "danger", "message": start_warning})
    
    # 10. –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —É—á–∞—Å—Ç–∫–∞–º (–¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤)
    breakdown = {
        "base_naismith": round(base_time_hours, 1),
        "profile_multiplier": multiplier,
        "rest_time": round(rest_time, 1),
        "total_adjusted": round(adjusted_time, 1),
        "safety_buffer": "+20%"
    }
    
    return HikePrediction(
        estimated_time_hours=round(adjusted_time, 1),
        safe_time_hours=round(safe_time, 1),
        recommended_start=recommended_start,
        recommended_turnaround=recommended_turnaround,
        warnings=warnings,
        breakdown=breakdown
    )


def generate_safety_warnings(course, profile: HikerProfile, total_time: float) -> List[dict]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∞.
    
    –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–µ—Å—á–∞—Å—Ç–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤!
    """
    warnings = []
    
    # –í—ã—Å–æ—Ç–∞ –¥–ª—è –Ω–µ–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö
    if course.max_altitude_m > 3000 and profile.experience == ExperienceLevel.BEGINNER:
        warnings.append({
            "level": "danger",
            "icon": "‚ö†Ô∏è",
            "message": f"–í—ã—Å–æ—Ç–∞ {course.max_altitude_m:.0f}–º –æ–ø–∞—Å–Ω–∞ –¥–ª—è –Ω–µ–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö!",
            "detail": "–†–∏—Å–∫ –≥–æ—Ä–Ω–æ–π –±–æ–ª–µ–∑–Ω–∏: –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, —Ç–æ—à–Ω–æ—Ç–∞, —Å–ª–∞–±–æ—Å—Ç—å. –ü—Ä–∏ —Å–∏–º–ø—Ç–æ–º–∞—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–ø—É—Å–∫–∞–π—Ç–µ—Å—å."
        })
    
    # –í—ã—Å–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö
    if course.max_altitude_m > 3500:
        warnings.append({
            "level": "warning",
            "icon": "üèîÔ∏è",
            "message": f"–í—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ: {course.max_altitude_m:.0f}–º",
            "detail": "–ò–¥–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º."
        })
    
    # –î–ª–∏–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤
    if course.distance_km > 15 and profile.experience in [ExperienceLevel.BEGINNER, ExperienceLevel.CASUAL]:
        warnings.append({
            "level": "warning",
            "icon": "üìè",
            "message": f"–î–ª–∏–Ω–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç: {course.distance_km:.1f} –∫–º",
            "detail": "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ö–≤–∞—Ç–∏—Ç —Å–∏–ª –∏ —Å–≤–µ—Ç–æ–≤–æ–≥–æ –¥–Ω—è. –í–æ–∑—å–º–∏—Ç–µ —Ñ–æ–Ω–∞—Ä–∏–∫ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π."
        })
    
    # –ë–æ–ª—å—à–æ–π –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã
    if course.elevation_gain_m > 800:
        liters_needed = max(2, course.elevation_gain_m / 400)  # ~0.5–ª –Ω–∞ 200–º –Ω–∞–±–æ—Ä–∞
        warnings.append({
            "level": "info",
            "icon": "üíß",
            "message": f"–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã: +{course.elevation_gain_m:.0f}–º",
            "detail": f"–í–æ–∑—å–º–∏—Ç–µ –º–∏–Ω–∏–º—É–º {liters_needed:.1f}–ª –≤–æ–¥—ã –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞."
        })
    
    # –û–¥–∏–Ω–æ—á–Ω—ã–π –ø–æ—Ö–æ–¥
    if profile.group_size == 1:
        warnings.append({
            "level": "warning",
            "icon": "üë§",
            "message": "–û–¥–∏–Ω–æ—á–Ω—ã–π –ø–æ—Ö–æ–¥",
            "detail": "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ –∫–æ–º—É-—Ç–æ –º–∞—Ä—à—Ä—É—Ç –∏ –≤—Ä–µ–º—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è. –í–æ–∑—å–º–∏—Ç–µ –∑–∞—Ä—è–∂–µ–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω."
        })
    
    # –û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π –¥–µ–Ω—å
    if total_time > 10:
        warnings.append({
            "level": "danger",
            "icon": "‚è∞",
            "message": f"–û—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π –ø–æ—Ö–æ–¥: {total_time:.1f} —á–∞—Å–æ–≤",
            "detail": "–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–æ—á—ë–≤–∫—É –∏–ª–∏ —Ä–∞–∑–±–µ–π—Ç–µ –Ω–∞ –¥–≤–∞ –¥–Ω—è. –í—ã—Å–æ–∫ —Ä–∏—Å–∫ –Ω–µ —É—Å–ø–µ—Ç—å –¥–æ —Ç–µ–º–Ω–æ—Ç—ã."
        })
    
    # –ö—Ä—É—Ç—ã–µ —Å–ø—É—Å–∫–∏ (>30% —É–∫–ª–æ–Ω)
    if hasattr(course, 'max_descent_gradient') and course.max_descent_gradient > 0.30:
        warnings.append({
            "level": "warning",
            "icon": "‚õ∑Ô∏è",
            "message": "–ö—Ä—É—Ç—ã–µ —Å–ø—É—Å–∫–∏ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ",
            "detail": "–ù—É–∂–Ω–∞ —Ö–æ—Ä–æ—à–∞—è –æ–±—É–≤—å —Å –ø—Ä–æ—Ç–µ–∫—Ç–æ—Ä–æ–º. –†–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è —Ç—Ä–µ–∫–∫–∏–Ω–≥–æ–≤—ã–µ –ø–∞–ª–∫–∏."
        })
    
    # –î–µ—Ç–∏ –≤ –≥—Ä—É–ø–ø–µ
    if profile.has_children:
        warnings.append({
            "level": "info",
            "icon": "üë∂",
            "message": "–ü–æ—Ö–æ–¥ —Å –¥–µ—Ç—å–º–∏",
            "detail": "–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ –±–æ–ª—å—à–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫. –ò–º–µ–π—Ç–µ –∑–∞–ø–∞—Å–Ω–æ–π –ø–ª–∞–Ω –Ω–∞ —Å–ª—É—á–∞–π —É—Å—Ç–∞–ª–æ—Å—Ç–∏."
        })
    
    return warnings
```

#### 5.5.5 UI –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üèîÔ∏è –°–ö–û–õ–¨–ö–û –ó–ê–ô–ú–Å–¢ –ü–û–•–û–î?                                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  –Ø –±–µ–≥—É–Ω, –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ        ‚Üí  [–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä]       ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∏–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –Ø –∏–¥—É –≤ –ø–æ—Ö–æ–¥                                                   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  1. –í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç                                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  [–ó–∞–≥—Ä—É–∑–∏—Ç—å GPX]  –∏–ª–∏  [–í—ã–±—Ä–∞—Ç—å –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö ‚ñº]        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –ê–ª–º–∞—Ç—ã:                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ë—É—Ç–∞–∫–æ–≤—Å–∫–∏–π –≤–æ–¥–æ–ø–∞–¥ (8 –∫–º, +450–º) ‚Äî –ª–µ–≥–∫–æ          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ö–æ–∫-–ñ–∞–π–ª—è—É (12 –∫–º, +680–º) ‚Äî —Å—Ä–µ–¥–Ω–µ                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ü–∏–∫ –§—É—Ä–º–∞–Ω–æ–≤–∞ (14 –∫–º, +1200–º) ‚Äî —Å–ª–æ–∂–Ω–æ             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ –ë–æ–ª—å—à–æ–µ –ê–ª–º–∞—Ç–∏–Ω—Å–∫–æ–µ –æ–∑–µ—Ä–æ (18 –∫–º, +900–º) ‚Äî —Å—Ä–µ–¥–Ω–µ  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  2. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –í–∞—à –æ–ø—ã—Ç –≤ –≥–æ—Ä–∞—Ö:                                      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚óã –ù–æ–≤–∏—á–æ–∫ (—Ä–µ–¥–∫–æ —Ö–æ–∂—É, –æ—Ñ–∏—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞)                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚óè –õ—é–±–∏—Ç–µ–ª—å (–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –≥–æ–¥)                       ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚óã –†–µ–≥—É–ª—è—Ä–Ω–æ (–∫–∞–∂–¥—ã–µ –≤—ã—Ö–æ–¥–Ω—ã–µ)                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚óã –û–ø—ã—Ç–Ω—ã–π (–º–Ω–æ–≥–æ–¥–Ω–µ–≤–∫–∏, –≤—ã—Å–æ–∫–æ–≥–æ—Ä—å–µ)                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –†—é–∫–∑–∞–∫:                                                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚óè –õ—ë–≥–∫–∏–π (<5 –∫–≥)  ‚óã –°—Ä–µ–¥–Ω–∏–π (5-10 –∫–≥)  ‚óã –¢—è–∂—ë–ª—ã–π      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫:  [3 ‚ñº]                                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  [  ] –° –¥–µ—Ç—å–º–∏     [  ] –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∞ –≤—ã—Å–æ—Ç–µ >3000–º    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º—è –ø–æ—Ö–æ–¥–∞]                                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚Üì –†–ï–ó–£–õ–¨–¢–ê–¢ ‚Üì

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚è±Ô∏è –ü–†–û–ì–ù–û–ó: –ö–û–ö-–ñ–ê–ô–õ–Ø–£                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ     –†–∞—Å—á—ë—Ç–Ω–æ–µ –≤—Ä–µ–º—è:    5.5 —á–∞—Å–æ–≤                               ‚îÇ
‚îÇ     –° –∑–∞–ø–∞—Å–æ–º (+20%):   6.5 —á–∞—Å–æ–≤                               ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  üìÖ –ü–õ–ê–ù –î–ù–Ø                                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  07:00  –í—ã—Ö–æ–¥ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–∞—Ä—Ç)                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  10:30  –ö–æ–∫-–ñ–∞–π–ª—è—É (—Ç–æ—á–∫–∞ —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞)                    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  10:45  –û–±–µ–¥, –æ—Ç–¥—ã—Ö                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  11:15  –ù–∞—á–∞–ª–æ —Å–ø—É—Å–∫–∞                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  13:30  –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ                                     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚ö†Ô∏è –ù–µ —É—Ö–æ–¥–∏—Ç–µ –ø–æ–∑–∂–µ 12:00 ‚Äî –ø–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–∞—Ö –ø–æ—Ä—Ç–∏—Ç—Å—è   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ     –ø–æ—Å–ª–µ –æ–±–µ–¥–∞!                                        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚ö†Ô∏è –í–ê–ñ–ù–û:                                                      ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ üèîÔ∏è –í—ã—Å–æ—Ç–∞ 2500–º ‚Äî –∏–¥–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–µ–π—Ç–µ –≤–æ–¥—É            ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ üíß –í–æ–∑—å–º–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2–ª –≤–æ–¥—ã –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ üë§ –°–æ–æ–±—â–∏—Ç–µ –∫–æ–º—É-—Ç–æ –≤–∞—à –º–∞—Ä—à—Ä—É—Ç!                          ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–ª–∞–Ω–æ–º]  [üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–±–µ –≤ Telegram]        ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 5.5.6 API –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç—É—Ä–∏—Å—Ç–∞

```yaml
POST /api/v1/predict/hike
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>                    # GPX —Ñ–∞–π–ª –º–∞—Ä—à—Ä—É—Ç–∞
  # –ò–õ–ò
  known_route_id: string              # ID –∏–∑ –±–∞–∑—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
  
  experience: string                  # beginner|casual|regular|experienced
  backpack_weight: string             # light|medium|heavy
  group_size: int                     # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫
  has_children: bool                  # –ï—Å—Ç—å –ª–∏ –¥–µ—Ç–∏
  first_time_altitude: bool           # –ü–µ—Ä–≤—ã–π —Ä–∞–∑ –Ω–∞ –≤—ã—Å–æ—Ç–µ
  is_round_trip: bool                 # –ú–∞—Ä—à—Ä—É—Ç —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ

Response:
  {
    "prediction": {
      "estimated_hours": 5.5,
      "safe_hours": 6.6,
      "formatted": "5 —á 30 –º–∏–Ω ‚Äî 6 —á 40 –º–∏–Ω"
    },
    "schedule": {
      "recommended_start": "07:00",
      "turnaround_time": "10:30",
      "expected_return": "13:30"
    },
    "course": {
      "name": "–ö–æ–∫-–ñ–∞–π–ª—è—É",
      "distance_km": 12,
      "elevation_gain_m": 680,
      "max_altitude_m": 2500
    },
    "warnings": [
      {
        "level": "info",
        "icon": "üíß",
        "message": "–í–æ–∑—å–º–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2–ª –≤–æ–¥—ã –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"
      }
    ],
    "breakdown": {
      "base_time": 3.2,
      "profile_multiplier": 1.44,
      "rest_time": 0.7,
      "total": 5.5
    }
  }
```

---

### 5.6 Crowdsourced –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏

#### 5.6.1 –ü—Ä–æ–±–ª–µ–º–∞

GPX —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –≤—ã—Å–æ—Ç—É, –Ω–æ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ —Ç—Ä–æ–ø—ã:

```
‚úì GPX –¥–∞—ë—Ç: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –≤—ã—Å–æ—Ç–∞
‚úó GPX –ù–ï –¥–∞—ë—Ç: 
  - –¢–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è (–≥—Ä—É–Ω—Ç, –∫–∞–º–Ω–∏, –æ—Å—ã–ø—å, –∫–æ—Ä–Ω–∏, –≥—Ä—è–∑—å, —Å–Ω–µ–≥)
  - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å
  - –û–ø–∞—Å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
  - –°–µ–∑–æ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–ø—É—Å–∫–æ–≤:**

–§–æ—Ä–º—É–ª–∞ Minetti –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —Å–ø—É—Å–∫ -10% –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 12% –±—ã—Å—Ç—Ä–µ–µ –ø–æ–¥—ä—ë–º–∞. –ù–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ö–æ—Ä–æ—à–µ–π —Ç—Ä–æ–ø–µ. –ù–∞ –æ—Å—ã–ø–∏ –∏–ª–∏ –º–æ–∫—Ä—ã—Ö –∫–∞–º–Ω—è—Ö —Å–ø—É—Å–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –ú–ï–î–õ–ï–ù–ù–ï–ï –ø–æ–¥—ä—ë–º–∞.

```
–¢–µ–æ—Ä–∏—è (Minetti):     –°–ø—É—Å–∫ -10% ‚Üí —Ç–µ–º–ø √ó 0.88
–†–µ–∞–ª—å–Ω–æ—Å—Ç—å (–æ—Å—ã–ø—å):   –°–ø—É—Å–∫ -10% ‚Üí —Ç–µ–º–ø √ó 1.80
```

#### 5.6.2 –†–µ—à–µ–Ω–∏–µ: Geo-indexed —Å–µ–≥–º–µ–Ω—Ç—ã

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –ù–ï –∫ GPX —Ñ–∞–π–ª—É, –∞ –∫ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º. –õ—é–±–æ–π –Ω–æ–≤—ã–π GPX, –ø—Ä–æ—Ö–æ–¥—è—â–∏–π —á–µ—Ä–µ–∑ —ç—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

```python
import geohash2
from dataclasses import dataclass, field
from typing import List, Optional
from datetime import datetime
from enum import Enum

class SurfaceType(Enum):
    """–¢–∏–ø—ã –ø–æ–∫—Ä—ã—Ç–∏—è —Ç—Ä–æ–ø—ã"""
    DIRT = "dirt"           # –ì—Ä—É–Ω—Ç–æ–≤–∞—è —Ç—Ä–æ–ø–∞
    ROCK = "rock"           # –ö–∞–º–Ω–∏
    SCREE = "scree"         # –û—Å—ã–ø—å, –∫—É—Ä—É–º–Ω–∏–∫
    ROOTS = "roots"         # –ö–æ—Ä–Ω–∏ –¥–µ—Ä–µ–≤—å–µ–≤
    MUD = "mud"             # –ì—Ä—è–∑—å, —Ä–∞–∑–º—ã—Ç–∞—è —Ç—Ä–æ–ø–∞
    SNOW = "snow"           # –°–Ω–µ–≥
    ICE = "ice"             # –õ—ë–¥
    GRASS = "grass"         # –¢—Ä–∞–≤–∞
    SAND = "sand"           # –ü–µ—Å–æ–∫
    ASPHALT = "asphalt"     # –ê—Å—Ñ–∞–ª—å—Ç
    TECHNICAL = "technical"  # –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —Å–ª–æ–∂–Ω—ã–π —É—á–∞—Å—Ç–æ–∫

class Season(Enum):
    """–°–µ–∑–æ–Ω—ã (–≤–∞–∂–Ω–æ –¥–ª—è –≥–æ—Ä!)"""
    SPRING = "spring"   # –ú–∞—Ä—Ç-–º–∞–π: —Å–Ω–µ–≥ —Ç–∞–µ—Ç, –≥—Ä—è–∑—å, —Ä—É—á—å–∏
    SUMMER = "summer"   # –ò—é–Ω—å-–∞–≤–≥—É—Å—Ç: —Å—É—Ö–æ, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –≥—Ä–æ–∑—ã
    AUTUMN = "autumn"   # –°–µ–Ω—Ç—è–±—Ä—å-–Ω–æ—è–±—Ä—å: –ª–∏—Å—Ç–≤–∞, –ø–µ—Ä–≤—ã–π —Å–Ω–µ–≥
    WINTER = "winter"   # –î–µ–∫–∞–±—Ä—å-—Ñ–µ–≤—Ä–∞–ª—å: —Å–Ω–µ–≥, –ª—ë–¥


@dataclass
class TrailSegmentInfo:
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ–≥–º–µ–Ω—Ç–µ —Ç—Ä–æ–ø—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏"""
    
    # –ì–µ–æ–ø—Ä–∏–≤—è–∑–∫–∞ (–ù–ï –∫ —Ñ–∞–π–ª—É!)
    geohash: str  # 7-—Å–∏–º–≤–æ–ª—å–Ω—ã–π geohash ‚âà 150–º x 150–º —è—á–µ–π–∫–∞
    
    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
    surface_votes: dict  # {"dirt": 15, "rock": 8, "scree": 3}
    primary_surface: str  # –ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–π —Ç–∏–ø
    
    # –°–ª–æ–∂–Ω–æ—Å—Ç—å (1-5)
    difficulty_avg: float
    difficulty_votes: int
    
    # –°–µ–∑–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    seasonal_info: dict  # –ü–æ —Å–µ–∑–æ–Ω–∞–º —Ä–∞–∑–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ!
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    warnings: List[dict]
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
    recent_comments: List[dict]
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    reports_count: int
    last_updated: datetime


def point_to_geohash(lat: float, lon: float, precision: int = 7) -> str:
    """
    –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ geohash.
    
    Precision 7 = ~150–º x 150–º —è—á–µ–π–∫–∞
    –≠—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è —Ç—Ä–æ–ø—ã, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º –º–µ–ª–∫–∞—è
    (—á—Ç–æ–±—ã —Ä–∞–∑–Ω—ã–µ GPS —Ç—Ä–µ–∫–∏ –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –æ–¥–Ω—É —è—á–µ–π–∫—É)
    
    –ü—Ä–∏–º–µ—Ä—ã geohash –¥–ª—è –ê–ª–º–∞—Ç—ã:
    - –ö–æ–∫-–ñ–∞–π–ª—è—É: "txp2wm7"
    - –ë—É—Ç–∞–∫–æ–≤—Å–∫–∏–π –≤–æ–¥–æ–ø–∞–¥: "txp2yk3"
    """
    return geohash2.encode(lat, lon, precision=precision)


def find_segment_info(lat: float, lon: float, 
                      season: Season = Season.SUMMER) -> Optional[TrailSegmentInfo]:
    """
    –ò—â–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–≥–º–µ–Ω—Ç–µ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.
    
    Args:
        lat, lon: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏
        season: –¢–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω (–≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏–µ!)
    
    Returns:
        TrailSegmentInfo –∏–ª–∏ None
    """
    gh = point_to_geohash(lat, lon)
    
    # –ò—â–µ–º –≤ –±–∞–∑–µ
    info = db.trail_segments.find_one({"geohash": gh})
    
    if info:
        segment = TrailSegmentInfo(**info)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ–∑–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        if season.value in segment.seasonal_info:
            seasonal = segment.seasonal_info[season.value]
            segment.primary_surface = seasonal.get("surface_primary", segment.primary_surface)
            segment.difficulty_avg = seasonal.get("difficulty_avg", segment.difficulty_avg)
        
        return segment
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ —è—á–µ–π–∫–∏ (—Ç—Ä–æ–ø–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ)
    neighbors = geohash2.neighbors(gh)
    for neighbor_gh in neighbors:
        info = db.trail_segments.find_one({"geohash": neighbor_gh})
        if info:
            return TrailSegmentInfo(**info)
    
    return None
```

#### 5.6.3 Matching GPX —Ñ–∞–π–ª–æ–≤ –∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º

```python
def match_gpx_to_known_routes(gpx_content: str) -> Optional[dict]:
    """
    –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π GPX —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏.
    
    –ü—Ä–æ–±–ª–µ–º–∞: –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–æ–π GPX,
    –Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –º–∞—Ä—à—Ä—É—Ç —Ç–æ—Ç –∂–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ö–æ–∫-–ñ–∞–π–ª—è—É).
    
    –†–µ—à–µ–Ω–∏–µ: "Fingerprint" –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç–æ—á–∫–∞–º.
    """
    
    gpx = gpxpy.parse(gpx_content)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
    key_points = extract_key_points(gpx)
    
    # –°–æ–∑–¥–∞—ë–º "–æ—Ç–ø–µ—á–∞—Ç–æ–∫" –º–∞—Ä—à—Ä—É—Ç–∞
    route_fingerprint = {
        # –ì–µ–æ—Ö–µ—à–∏ —Å—Ç–∞—Ä—Ç–∞, —Ñ–∏–Ω–∏—à–∞, –≤—ã—Å—à–µ–π —Ç–æ—á–∫–∏
        "start_geohash": point_to_geohash(
            key_points["start"].latitude, 
            key_points["start"].longitude,
            precision=5  # ~5–∫–º —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è matching
        ),
        "end_geohash": point_to_geohash(
            key_points["end"].latitude,
            key_points["end"].longitude,
            precision=5
        ),
        "highest_geohash": point_to_geohash(
            key_points["highest"].latitude,
            key_points["highest"].longitude,
            precision=5
        ),
        # –û–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
        "distance_bucket": round(key_points["distance_km"]),  # –î–æ –∫–º
        "elevation_bucket": round(key_points["elevation_gain"] / 100) * 100  # –î–æ 100–º
    }
    
    # –ò—â–µ–º –ø–æ—Ö–æ–∂–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –≤ –±–∞–∑–µ
    similar = db.known_routes.find_one({
        "fingerprint.start_geohash": route_fingerprint["start_geohash"],
        "fingerprint.end_geohash": route_fingerprint["end_geohash"],
        "fingerprint.distance_bucket": {
            "$gte": route_fingerprint["distance_bucket"] - 2,
            "$lte": route_fingerprint["distance_bucket"] + 2
        }
    })
    
    if similar:
        # –í—ã—á–∏—Å–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
        confidence = calculate_match_confidence(route_fingerprint, similar["fingerprint"])
        
        return {
            "matched_route_id": str(similar["_id"]),
            "matched_route_name": similar["name"],
            "confidence": confidence,
            "surface_info_available": bool(similar.get("surface_info")),
            "reports_count": similar.get("reports_count", 0)
        }
    
    return None


def extract_key_points(gpx) -> dict:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è fingerprinting"""
    
    all_points = []
    for track in gpx.tracks:
        for segment in track.segments:
            all_points.extend(segment.points)
    
    if not all_points:
        return {}
    
    start = all_points[0]
    end = all_points[-1]
    highest = max(all_points, key=lambda p: p.elevation or 0)
    
    # –û–±—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
    total_distance = sum(
        all_points[i].distance_2d(all_points[i+1])
        for i in range(len(all_points) - 1)
    ) / 1000  # –≤ –∫–º
    
    return {
        "start": start,
        "end": end,
        "highest": highest,
        "distance_km": total_distance,
        "elevation_gain": calculate_elevation_gain(all_points)
    }


def calculate_match_confidence(fp1: dict, fp2: dict) -> float:
    """–í—ã—á–∏—Å–ª—è–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–≤—É—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤"""
    
    score = 0
    max_score = 0
    
    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≥–µ–æ—Ö–µ—à–µ–π (–≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ)
    if fp1["start_geohash"] == fp2["start_geohash"]:
        score += 30
    max_score += 30
    
    if fp1["end_geohash"] == fp2["end_geohash"]:
        score += 30
    max_score += 30
    
    if fp1["highest_geohash"] == fp2["highest_geohash"]:
        score += 20
    max_score += 20
    
    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (¬±1 –∫–º)
    if abs(fp1["distance_bucket"] - fp2["distance_bucket"]) <= 1:
        score += 10
    max_score += 10
    
    # –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –≤—ã—Å–æ—Ç—ã (¬±100–º)
    if abs(fp1["elevation_bucket"] - fp2["elevation_bucket"]) <= 100:
        score += 10
    max_score += 10
    
    return round(score / max_score, 2)
```

#### 5.6.4 –û–±–æ–≥–∞—â–µ–Ω–∏–µ GPX –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏

```python
def enrich_gpx_with_surface_info(
    gpx_content: str,
    season: Season = Season.SUMMER
) -> dict:
    """
    –û–±–æ–≥–∞—â–∞–µ—Ç GPX –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∏–∑ crowdsourced –±–∞–∑—ã.
    
    Returns:
        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∏ –æ–±–æ–≥–∞—â—ë–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã
    """
    
    gpx = gpxpy.parse(gpx_content)
    
    enriched_segments = []
    unknown_segments = []
    
    for track in gpx.tracks:
        for segment in track.segments:
            for i, point in enumerate(segment.points):
                # –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –¥–ª—è —ç—Ç–æ–π —Ç–æ—á–∫–∏
                info = find_segment_info(
                    point.latitude, 
                    point.longitude,
                    season=season
                )
                
                if info and info.reports_count >= 2:  # –ú–∏–Ω–∏–º—É–º 2 –æ—Ç—á—ë—Ç–∞
                    enriched_segments.append({
                        "index": i,
                        "lat": point.latitude,
                        "lon": point.longitude,
                        "surface": info.primary_surface,
                        "difficulty": info.difficulty_avg,
                        "confidence": min(info.reports_count / 5, 1.0),  # 5+ = 100%
                        "warnings": info.warnings[:2]  # –¢–æ–ø-2 –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                    })
                else:
                    unknown_segments.append({
                        "index": i,
                        "lat": point.latitude,
                        "lon": point.longitude
                    })
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
    surface_counts = {}
    for seg in enriched_segments:
        surface = seg["surface"]
        surface_counts[surface] = surface_counts.get(surface, 0) + 1
    
    total_points = len(enriched_segments) + len(unknown_segments)
    coverage = len(enriched_segments) / total_points if total_points > 0 else 0
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
    if surface_counts:
        primary_surface = max(surface_counts, key=surface_counts.get)
        surface_percentage = {
            k: round(v / len(enriched_segments) * 100, 1) 
            for k, v in surface_counts.items()
        }
    else:
        primary_surface = "unknown"
        surface_percentage = {}
    
    return {
        "coverage_percent": round(coverage * 100, 1),
        "primary_surface": primary_surface,
        "surface_breakdown": surface_percentage,
        "unknown_segments_count": len(unknown_segments),
        "enriched_segments": enriched_segments,
        "data_quality": (
            "high" if coverage > 0.7 else
            "medium" if coverage > 0.3 else
            "low"
        )
    }
```

#### 5.6.5 –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ surface info –∫ –ø—Ä–æ–≥–Ω–æ–∑—É

```python
# –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø—É –ø–æ–∫—Ä—ã—Ç–∏—è
# –§–æ—Ä–º–∞—Ç: (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç_–ø–æ–¥—ä—ë–º, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç_—Å–ø—É—Å–∫)
SURFACE_MULTIPLIERS = {
    "dirt": (1.0, 1.0),       # –ì—Ä—É–Ω—Ç ‚Äî baseline
    "asphalt": (0.95, 0.95),  # –ê—Å—Ñ–∞–ª—å—Ç ‚Äî —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ
    "grass": (1.05, 1.05),    # –¢—Ä–∞–≤–∞ ‚Äî —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    "rock": (1.1, 1.3),       # –ö–∞–º–Ω–∏ ‚Äî —Å–ø—É—Å–∫ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    "scree": (1.3, 1.8),      # –û—Å—ã–ø—å ‚Äî —Å–ø—É—Å–∫ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω—ã–π
    "roots": (1.1, 1.4),      # –ö–æ—Ä–Ω–∏ ‚Äî –æ–ø–∞—Å–Ω–æ –Ω–∞ —Å–ø—É—Å–∫–µ
    "mud": (1.2, 1.5),        # –ì—Ä—è–∑—å ‚Äî —Å–∫–æ–ª—å–∑–∫–æ –≤–µ–∑–¥–µ
    "snow": (1.3, 1.2),       # –°–Ω–µ–≥ ‚Äî —Å–ø—É—Å–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ (–≥–ª–∏—Å—Å–µ—Ä)
    "ice": (1.5, 2.0),        # –õ—ë–¥ ‚Äî –æ—á–µ–Ω—å –æ–ø–∞—Å–Ω–æ –Ω–∞ —Å–ø—É—Å–∫–µ
    "sand": (1.4, 1.3),       # –ü–µ—Å–æ–∫ ‚Äî —Ç—è–∂–µ–ª–æ –∏–¥—Ç–∏
    "technical": (1.2, 1.6),  # –¢–µ—Ö–Ω–∏—á–Ω—ã–π —É—á–∞—Å—Ç–æ–∫
}


def apply_surface_correction(
    base_pace: float,
    surface_type: str,
    is_descent: bool,
    confidence: float = 1.0
) -> float:
    """
    –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–µ–º–ø –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –ø–æ–∫—Ä—ã—Ç–∏—è.
    
    Args:
        base_pace: –ë–∞–∑–æ–≤—ã–π —Ç–µ–º–ø (—Å–µ–∫/–∫–º –∏–ª–∏ —á–∞—Å—ã/–∫–º)
        surface_type: –¢–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è
        is_descent: True –µ—Å–ª–∏ —ç—Ç–æ —Å–ø—É—Å–∫
        confidence: –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ –¥–∞–Ω–Ω—ã—Ö (0-1)
    
    Returns:
        –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–º–ø
    """
    
    if surface_type not in SURFACE_MULTIPLIERS:
        surface_type = "dirt"  # fallback
    
    mult = SURFACE_MULTIPLIERS[surface_type]
    correction = mult[1] if is_descent else mult[0]
    
    # –£—á–∏—Ç—ã–≤–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å ‚Üí –±–ª–∏–∂–µ –∫ 1.0
    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –Ω–µ –¥–µ–ª–∞–µ–º —Å–∏–ª—å–Ω—ã—Ö –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–æ–∫
    final_correction = 1.0 + (correction - 1.0) * confidence
    
    return base_pace * final_correction


def predict_with_surface(
    gpx_content: str,
    athlete_pace: float,
    season: Season = Season.SUMMER
) -> dict:
    """
    –ü—Ä–æ–≥–Ω–æ–∑ —Å —É—á—ë—Ç–æ–º crowdsourced –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏.
    """
    
    # –û–±–æ–≥–∞—â–∞–µ–º GPX –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
    surface_data = enrich_gpx_with_surface_info(gpx_content, season)
    
    segments = parse_gpx_to_segments(gpx_content)
    
    total_time = 0
    segment_results = []
    
    for i, seg in enumerate(segments):
        # –ë–∞–∑–æ–≤—ã–π GAP (—Ç–æ–ª—å–∫–æ —É–∫–ª–æ–Ω)
        base_pace = apply_gap_model(athlete_pace, seg.gradient)
        
        # –ù–∞—Ö–æ–¥–∏–º surface info –¥–ª—è —ç—Ç–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
        seg_surface = find_segment_in_enriched(i, surface_data["enriched_segments"])
        
        # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏–µ
        is_descent = seg.gradient < -0.02  # –°–ø—É—Å–∫ > 2%
        
        if seg_surface:
            final_pace = apply_surface_correction(
                base_pace,
                seg_surface["surface"],
                is_descent,
                seg_surface["confidence"]
            )
            surface_used = seg_surface["surface"]
        else:
            final_pace = base_pace
            surface_used = "unknown"
        
        segment_time = final_pace * (seg.distance_m / 1000)
        total_time += segment_time
        
        segment_results.append({
            "distance_km": seg.distance_m / 1000,
            "gradient_percent": round(seg.gradient * 100, 1),
            "surface": surface_used,
            "pace_sec_per_km": round(final_pace),
            "time_sec": round(segment_time)
        })
    
    return {
        "total_time_seconds": round(total_time),
        "segments": segment_results,
        "surface_info": {
            "coverage": surface_data["coverage_percent"],
            "primary": surface_data["primary_surface"],
            "breakdown": surface_data["surface_breakdown"],
            "quality": surface_data["data_quality"]
        }
    }
```

#### 5.6.6 –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```python
from pydantic import BaseModel
from typing import List, Optional

class SurfaceReport(BaseModel):
    """–û—Ç—á—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞"""
    
    # –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞
    overall_difficulty: int  # 1-5
    primary_surfaces: List[str]  # –í—ã–±–æ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞
    
    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏
    difficult_sections: Optional[List[dict]]  # –û—Ç–º–µ—Ç–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ
    weather_conditions: Optional[str]  # dry, wet, snow
    date_hiked: Optional[str]
    comment: Optional[str]


async def submit_surface_report(
    gpx_content: str,
    report: SurfaceReport,
    user_experience: str  # beginner|regular|experienced
) -> dict:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç—á—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞.
    
    –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞—é—Ç—Å—è –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, –Ω–µ –∫ —Ñ–∞–π–ª—É!
    """
    
    gpx = gpxpy.parse(gpx_content)
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–∑–æ–Ω
    if report.date_hiked:
        month = datetime.fromisoformat(report.date_hiked).month
        season = get_season_from_month(month)
    else:
        season = get_current_season()
    
    updates_count = 0
    
    # –î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    for track in gpx.tracks:
        for segment in track.segments:
            # –ë–µ—Ä—ë–º –∫–∞–∂–¥—É—é N-—é —Ç–æ—á–∫—É (–Ω–µ –≤—Å–µ ‚Äî —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ)
            for i, point in enumerate(segment.points[::10]):  # –∫–∞–∂–¥–∞—è 10-—è
                gh = point_to_geohash(point.latitude, point.longitude)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å
                update = {
                    "$inc": {
                        "reports_count": 1,
                        "difficulty_votes": 1,
                    },
                    "$set": {
                        "last_updated": datetime.utcnow()
                    },
                    "$push": {
                        f"seasonal_info.{season.value}.reports": {
                            "difficulty": report.overall_difficulty,
                            "surfaces": report.primary_surfaces,
                            "weather": report.weather_conditions,
                            "user_level": user_experience,
                            "date": datetime.utcnow()
                        }
                    }
                }
                
                # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Ç–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è
                for surface in report.primary_surfaces:
                    update["$inc"][f"surface_votes.{surface}"] = 1
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–π difficulty
                # (–∏—Å–ø–æ–ª—å–∑—É–µ–º $inc –∏ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º)
                update["$inc"]["difficulty_sum"] = report.overall_difficulty
                
                await db.trail_segments.update_one(
                    {"geohash": gh},
                    update,
                    upsert=True  # –°–æ–∑–¥–∞—ë–º –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                )
                updates_count += 1
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
    if report.difficult_sections:
        for section in report.difficult_sections:
            gh = point_to_geohash(section["lat"], section["lon"])
            
            await db.trail_segments.update_one(
                {"geohash": gh},
                {
                    "$push": {
                        "warnings": {
                            "type": section.get("type", "difficult"),
                            "description": section.get("comment", ""),
                            "reported_at": datetime.utcnow(),
                            "season": season.value
                        }
                    }
                },
                upsert=True
            )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
    if report.comment:
        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ —Å–µ—Ä–µ–¥–∏–Ω–µ –º–∞—Ä—à—Ä—É—Ç–∞
        middle_point = get_middle_point(gpx)
        gh = point_to_geohash(middle_point.latitude, middle_point.longitude)
        
        await db.trail_segments.update_one(
            {"geohash": gh},
            {
                "$push": {
                    "recent_comments": {
                        "$each": [{
                            "text": report.comment[:500],  # –õ–∏–º–∏—Ç
                            "date": datetime.utcnow(),
                            "season": season.value,
                            "user_experience": user_experience
                        }],
                        "$slice": -10  # –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10
                    }
                }
            }
        )
    
    return {
        "success": True,
        "segments_updated": updates_count,
        "message": "–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç—á—ë—Ç –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º —Ç—É—Ä–∏—Å—Ç–∞–º."
    }


def recalculate_segment_stats():
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π job –¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–µ–≥–º–µ–Ω—Ç–æ–≤.
    –ó–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞–∑ –≤ –¥–µ–Ω—å.
    """
    
    for segment in db.trail_segments.find():
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º primary surface
        if segment.get("surface_votes"):
            primary = max(segment["surface_votes"], key=segment["surface_votes"].get)
        else:
            primary = "unknown"
        
        # –°—Ä–µ–¥–Ω–∏–π difficulty
        if segment.get("difficulty_votes", 0) > 0:
            avg_difficulty = segment.get("difficulty_sum", 0) / segment["difficulty_votes"]
        else:
            avg_difficulty = 3  # default
        
        db.trail_segments.update_one(
            {"_id": segment["_id"]},
            {
                "$set": {
                    "primary_surface": primary,
                    "difficulty_avg": round(avg_difficulty, 1)
                }
            }
        )
```

#### 5.6.7 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenStreetMap

```python
import overpy

def get_osm_surface_info(lat: float, lon: float, radius: float = 50) -> Optional[dict]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∏–∑ OpenStreetMap –∫–∞–∫ fallback.
    
    OSM —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–µ —Ç–µ–≥–∏:
    - surface=asphalt/gravel/dirt/rock/sand/grass
    - tracktype=grade1-5 (–∫–∞—á–µ—Å—Ç–≤–æ –ª–µ—Å–Ω–æ–π –¥–æ—Ä–æ–≥–∏)
    - sac_scale=hiking/mountain_hiking/demanding_mountain_hiking/alpine_hiking
    
    Args:
        lat, lon: –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        radius: –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ –≤ –º–µ—Ç—Ä–∞—Ö
    
    Returns:
        –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∏–ª–∏ None
    """
    
    api = overpy.Overpass()
    
    # –ò—â–µ–º —Ç—Ä–æ–ø—ã/–¥–æ—Ä–æ–≥–∏ —Ä—è–¥–æ–º —Å —Ç–æ—á–∫–æ–π
    query = f"""
    [out:json][timeout:10];
    (
      way["highway"~"path|track|footway"](around:{radius},{lat},{lon});
    );
    out body;
    """
    
    try:
        result = api.query(query)
        
        for way in result.ways:
            tags = way.tags
            
            surface = tags.get("surface")
            tracktype = tags.get("tracktype")
            sac_scale = tags.get("sac_scale")
            
            if surface or tracktype or sac_scale:
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º OSM —Ç–µ–≥–∏ –≤ –Ω–∞—à–∏ —Ç–∏–ø—ã
                our_surface = map_osm_to_surface(surface, tracktype, sac_scale)
                
                return {
                    "source": "osm",
                    "surface": our_surface,
                    "osm_surface": surface,
                    "osm_tracktype": tracktype,
                    "osm_sac_scale": sac_scale,
                    "confidence": 0.6  # OSM –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã
                }
        
        return None
        
    except Exception as e:
        print(f"OSM query error: {e}")
        return None


def map_osm_to_surface(surface: str, tracktype: str, sac_scale: str) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç OSM —Ç–µ–≥–∏ –≤ –Ω–∞—à–∏ —Ç–∏–ø—ã –ø–æ–∫—Ä—ã—Ç–∏—è"""
    
    # –ú–∞–ø–ø–∏–Ω–≥ surface
    surface_map = {
        "asphalt": "asphalt",
        "paved": "asphalt",
        "gravel": "dirt",
        "fine_gravel": "dirt",
        "dirt": "dirt",
        "earth": "dirt",
        "ground": "dirt",
        "grass": "grass",
        "rock": "rock",
        "stone": "rock",
        "pebblestone": "rock",
        "sand": "sand",
        "mud": "mud",
        "snow": "snow",
        "ice": "ice"
    }
    
    if surface and surface in surface_map:
        return surface_map[surface]
    
    # –ú–∞–ø–ø–∏–Ω–≥ tracktype (grade1 = –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
    tracktype_map = {
        "grade1": "dirt",      # –•–æ—Ä–æ—à–∞—è –≥—Ä—É–Ω—Ç–æ–≤–∫–∞
        "grade2": "dirt",
        "grade3": "dirt",
        "grade4": "roots",     # –ü–ª–æ—Ö–∞—è —Ç—Ä–æ–ø–∞
        "grade5": "technical"  # –û—á–µ–Ω—å –ø–ª–æ—Ö–∞—è
    }
    
    if tracktype and tracktype in tracktype_map:
        return tracktype_map[tracktype]
    
    # –ú–∞–ø–ø–∏–Ω–≥ sac_scale (—Å–ª–æ–∂–Ω–æ—Å—Ç—å –∞–ª—å–ø–∏–Ω–∏—Å—Ç—Å–∫–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞)
    sac_map = {
        "hiking": "dirt",
        "mountain_hiking": "rock",
        "demanding_mountain_hiking": "scree",
        "alpine_hiking": "technical",
        "demanding_alpine_hiking": "technical",
        "difficult_alpine_hiking": "technical"
    }
    
    if sac_scale and sac_scale in sac_map:
        return sac_map[sac_scale]
    
    return "unknown"


def get_surface_info_combined(
    lat: float, 
    lon: float, 
    season: Season = Season.SUMMER
) -> dict:
    """
    –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.
    –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: crowdsourced > OSM > default
    """
    
    # 1. –°–Ω–∞—á–∞–ª–∞ –Ω–∞—à–∏ crowdsourced –¥–∞–Ω–Ω—ã–µ
    crowd_info = find_segment_info(lat, lon, season)
    
    if crowd_info and crowd_info.reports_count >= 3:
        return {
            "source": "crowdsourced",
            "surface": crowd_info.primary_surface,
            "difficulty": crowd_info.difficulty_avg,
            "confidence": min(crowd_info.reports_count / 5, 1.0),
            "seasonal": True,
            "warnings": crowd_info.warnings[:2]
        }
    
    # 2. Fallback –Ω–∞ OSM
    osm_info = get_osm_surface_info(lat, lon)
    
    if osm_info:
        return osm_info
    
    # 3. Default (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π)
    return {
        "source": "default",
        "surface": "unknown",
        "difficulty": 3,
        "confidence": 0.3,
        "warning": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Ç–æ—á–Ω—ã–º"
    }
```

#### 5.6.8 MongoDB —Å—Ö–µ–º–∞ –¥–ª—è trail segments

```python
trail_segment_schema = {
    "_id": "ObjectId",
    
    # –ì–µ–æ–ø—Ä–∏–≤—è–∑–∫–∞
    "geohash": "string",  # 7-—Å–∏–º–≤–æ–ª—å–Ω—ã–π geohash (–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω)
    "location": {
        "type": "Point",
        "coordinates": ["lon", "lat"]  # –î–ª—è geo-–∑–∞–ø—Ä–æ—Å–æ–≤
    },
    
    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø–æ–∫—Ä—ã—Ç–∏–µ
    "surface_votes": {
        "dirt": 15,
        "rock": 8,
        "scree": 3
        # ...
    },
    "primary_surface": "string",  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ votes
    
    # –°–ª–æ–∂–Ω–æ—Å—Ç—å
    "difficulty_sum": "float",  # –°—É–º–º–∞ –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫
    "difficulty_votes": "int",  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–æ—Å–æ–≤
    "difficulty_avg": "float",  # –°—Ä–µ–¥–Ω–µ–µ (–ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
    
    # –°–µ–∑–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–û–ß–ï–ù–¨ –≤–∞–∂–Ω–æ –¥–ª—è –≥–æ—Ä!)
    "seasonal_info": {
        "summer": {
            "surface_primary": "dirt",
            "difficulty_avg": 2.8,
            "reports_count": 18,
            "reports": [
                {
                    "difficulty": 3,
                    "surfaces": ["dirt", "rock"],
                    "weather": "dry",
                    "user_level": "regular",
                    "date": "datetime"
                }
            ]
        },
        "winter": {
            "surface_primary": "snow",
            "difficulty_avg": 4.5,
            "reports_count": 4
        }
    },
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    "warnings": [
        {
            "type": "slippery_when_wet",
            "description": "–ü–æ—Å–ª–µ –¥–æ–∂–¥—è –æ—á–µ–Ω—å —Å–∫–æ–ª—å–∑–∫–æ",
            "reported_count": 7,
            "reported_at": "datetime",
            "season": "summer"
        },
        {
            "type": "dangerous_section",
            "description": "–û–±—Ä—ã–≤ —Å–ø—Ä–∞–≤–∞",
            "reported_count": 3,
            "reported_at": "datetime"
        }
    ],
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ª–∏–º–∏—Ç 10)
    "recent_comments": [
        {
            "text": "–¢—Ä–æ–ø–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞ —Å—Ç–∞–ª–∞ –ª—É—á—à–µ",
            "date": "datetime",
            "season": "summer",
            "user_experience": "experienced"
        }
    ],
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    "reports_count": "int",
    "first_report": "datetime",
    "last_updated": "datetime"
}

# –ò–Ω–¥–µ–∫—Å—ã
db.trail_segments.create_index("geohash", unique=True)
db.trail_segments.create_index([("location", "2dsphere")])
db.trail_segments.create_index("primary_surface")
db.trail_segments.create_index("last_updated")
```

#### 5.6.9 UI –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üéâ –ö–ê–ö –ü–†–û–®–Å–õ –ü–û–•–û–î?                                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –í–∞—à –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º —Ç—É—Ä–∏—Å—Ç–∞–º!                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  –û–±—â–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Ä—à—Ä—É—Ç–∞:                                      ‚îÇ
‚îÇ  ‚òÜ ‚òÜ ‚òÜ ‚òÜ ‚òÜ  ‚Üí  ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ (4/5)                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –ö–∞–∫–æ–µ –±—ã–ª–æ –ø–æ–∫—Ä—ã—Ç–∏–µ? (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)                         ‚îÇ
‚îÇ  [‚úì] –ì—Ä—É–Ω—Ç–æ–≤–∞—è —Ç—Ä–æ–ø–∞                                            ‚îÇ
‚îÇ  [‚úì] –ö–∞–º–Ω–∏                                                       ‚îÇ
‚îÇ  [ ] –û—Å—ã–ø—å / –∫—É—Ä—É–º–Ω–∏–∫                                           ‚îÇ
‚îÇ  [ ] –ö–æ—Ä–Ω–∏ –¥–µ—Ä–µ–≤—å–µ–≤                                             ‚îÇ
‚îÇ  [ ] –ì—Ä—è–∑—å / —Ä–∞–∑–º—ã—Ç–∞—è —Ç—Ä–æ–ø–∞                                     ‚îÇ
‚îÇ  [ ] –°–Ω–µ–≥ / –ª—ë–¥                                                 ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:                                              ‚îÇ
‚îÇ  ‚óã –°—É—Ö–æ  ‚óè –ü–æ—Å–ª–µ –¥–æ–∂–¥—è  ‚óã –°–Ω–µ–≥                                  ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  üìç –ë—ã–ª–∏ —Å–ª–æ–∂–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏?                               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –û—Ç–º–µ—Ç—å—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, –≥–¥–µ –±—ã–ª–æ –æ–ø–∞—Å–Ω–æ –∏–ª–∏ —Ç—Ä—É–¥–Ω–æ         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  [          –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞           ]   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                  —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏                            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ                                                          ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  –î–æ–±–∞–≤–ª–µ–Ω–æ: 2 –æ—Ç–º–µ—Ç–∫–∏                                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–º 3.2 ‚Äî "–°–∫–æ–ª—å–∑–∫–∏–µ –∫–∞–º–Ω–∏ —É —Ä—É—á—å—è"                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ –ö–º 7.1 ‚Äî "–ö—Ä—É—Ç–æ–π –ø–æ–¥—ä—ë–º"                            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ –¢—Ä–æ–ø–∞ —Ö–æ—Ä–æ—à–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ—Å–ª–µ –¥–æ–∂–¥—è –Ω–∞ —Å–ø—É—Å–∫–µ        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ –æ—á–µ–Ω—å —Å–∫–æ–ª—å–∑–∫–æ ‚Äî –Ω—É–∂–Ω—ã –ø–∞–ª–∫–∏ –∏–ª–∏ —Ö–æ—Ä–æ—à–∞—è –æ–±—É–≤—å.        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –ö–æ–≥–¥–∞ –±—ã–ª–∏: [–ò—é–ª—å 2025 ‚ñº]                                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤]                                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  üí° –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∞–Ω–æ–Ω–∏–º–Ω—ã –∏ –ø–æ–º–æ–≥—É—Ç —Ç—ã—Å—è—á–∞–º —Ç—É—Ä–∏—Å—Ç–æ–≤!           ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 5.6.10 API –¥–ª—è surface reports

```yaml
# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
POST /api/v1/trails/report
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>                    # GPX –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
  overall_difficulty: int             # 1-5
  primary_surfaces: string[]          # ["dirt", "rock"]
  weather_conditions: string          # dry|wet|snow
  date_hiked: string                  # ISO date
  comment: string                     # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  difficult_sections: json            # [{"lat": x, "lon": y, "type": "slippery", "comment": "..."}]
  user_experience: string             # beginner|regular|experienced

Response:
  {
    "success": true,
    "segments_updated": 47,
    "message": "–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç—á—ë—Ç –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º —Ç—É—Ä–∏—Å—Ç–∞–º.",
    "your_contribution": {
      "total_reports": 5,
      "badge": "Trail Scout ü•æ"
    }
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
POST /api/v1/trails/surface-info
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>
  season: string                      # spring|summer|autumn|winter

Response:
  {
    "coverage_percent": 73.5,
    "data_quality": "high",
    "primary_surface": "dirt",
    "surface_breakdown": {
      "dirt": 45.2,
      "rock": 28.3,
      "scree": 15.1,
      "unknown": 11.4
    },
    "warnings": [
      {
        "km": 3.2,
        "type": "slippery_when_wet",
        "reports_count": 7,
        "description": "–°–∫–æ–ª—å–∑–∫–∏–µ –∫–∞–º–Ω–∏ —É —Ä—É—á—å—è"
      }
    ],
    "recent_comments": [
      {
        "text": "–¢—Ä–æ–ø–∞ —Ö–æ—Ä–æ—à–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–∞",
        "date": "2025-07-15",
        "season": "summer"
      }
    ]
  }
```

---

## 6. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### 6.1 MongoDB —Å—Ö–µ–º–∞

```python
# users collection
user_schema = {
    "_id": "ObjectId",
    "telegram_id": "int (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
    "email": "string (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)", 
    "created_at": "datetime",
    "updated_at": "datetime",
    
    # Strava –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
    "strava": {
        "athlete_id": "int",
        "access_token": "string (encrypted)",
        "refresh_token": "string (encrypted)",
        "token_expires_at": "datetime",
        "connected_at": "datetime",
        "scopes": ["activity:read"]
    },
    
    # –î–∞–Ω–Ω—ã–µ –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç Strava)
    "manual_data": {
        "best_5k_seconds": "int",
        "best_10k_seconds": "int",
        "best_hm_seconds": "int",
        "weight_kg": "float",
        "age": "int"
    },
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    "preferences": {
        "units": "metric|imperial",
        "default_terrain": "road|trail|technical"
    }
}

# athlete_metrics collection
# –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Strava ‚Äî –•–†–ê–ù–ò–¢–¨ –ú–û–ñ–ù–û
# (—ç—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
athlete_metrics_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",
    "updated_at": "datetime",
    
    # Best efforts (–∏–∑ Strava)
    "best_efforts": {
        "5k": {"time_seconds": "int", "date": "datetime"},
        "10k": {"time_seconds": "int", "date": "datetime"},
        "half_marathon": {"time_seconds": "int", "date": "datetime"},
        "marathon": {"time_seconds": "int", "date": "datetime"}
    },
    
    # –†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor
    "personal_fatigue_factor": "float",
    
    # –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    "training_summary": {
        "weekly_volume_km": "float",
        "weekly_runs_count": "int",
        "avg_pace_per_km": "float",
        "total_elevation_gain_monthly": "float"
    }
}

# activities_cache collection
# –ö—ç—à —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö Strava ‚Äî –£–î–ê–õ–Ø–¢–¨ –ß–ï–†–ï–ó 7 –î–ù–ï–ô
activities_cache_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",
    "strava_activity_id": "int",
    "cached_at": "datetime",  # TTL index: —É–¥–∞–ª—è—Ç—å —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
    
    # –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–±–µ–∑ GPS/–∫–∞—Ä—Ç—ã!)
    "data": {
        "name": "string",
        "type": "string",  # "Run", "Trail Run"
        "start_date": "datetime",
        "distance": "float",  # –º–µ—Ç—Ä—ã
        "elapsed_time": "int",  # —Å–µ–∫—É–Ω–¥—ã
        "moving_time": "int",
        "total_elevation_gain": "float",
        "average_speed": "float",
        "average_heartrate": "float",
        "max_heartrate": "float",
        "suffer_score": "int"
    }
    
    # –ù–ï –•–†–ê–ù–ò–ú:
    # - map (polyline)
    # - start_latlng, end_latlng
    # - segment_efforts
    # - splits (—Å–æ–¥–µ—Ä–∂–∞—Ç GPS)
}

# gpx_files collection
# GPX —Ñ–∞–π–ª—ã ‚Äî –ù–ï Strava Data, –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ª—å—à–µ
gpx_files_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",  # null –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ç—Ä–∞—Å—Å
    "uploaded_at": "datetime",
    
    "metadata": {
        "name": "string",
        "distance_km": "float",
        "elevation_gain_m": "float",
        "elevation_loss_m": "float",
        "max_elevation_m": "float",
        "min_elevation_m": "float"
    },
    
    # Elevation profile (–º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫)
    "elevation_profile": [
        {"distance_km": "float", "elevation_m": "float"}
    ],
    
    # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–¥–ª—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞)
    "gpx_content": "string",  # –∏–ª–∏ GridFS –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
    
    # –§–ª–∞–≥ –ø—É–±–ª–∏—á–Ω–æ—Å—Ç–∏
    "is_public": "bool",  # true = –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º (—Å —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    "public_name": "string"  # "–ê–ª–º–∞—Ç—ã –ú–∞—Ä–∞—Ñ–æ–Ω 2025"
}

# predictions collection
# –ü—Ä–æ–≥–Ω–æ–∑—ã ‚Äî —Ç–≤–æ—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Ö—Ä–∞–Ω–∏—Ç—å –±–µ—Å—Å—Ä–æ—á–Ω–æ
predictions_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",
    "gpx_file_id": "ObjectId (ref: gpx_files)",
    "created_at": "datetime",
    
    # –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    "input": {
        "flat_pace_seconds_per_km": "float",
        "fatigue_factor": "float",
        "terrain_type": "road|trail|technical",
        "data_source": "strava|manual"
    },
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞
    "result": {
        "predicted_time_seconds": "int",
        "confidence_min_seconds": "int",
        "confidence_max_seconds": "int",
        "total_distance_km": "float",
        "total_elevation_gain_m": "float"
    },
    
    # –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
    "segments": [
        {
            "km_start": "float",
            "km_end": "float",
            "pace_seconds_per_km": "float",
            "elevation_change_m": "float"
        }
    ],
    
    # –†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –ø–æ—Å–ª–µ –≥–æ–Ω–∫–∏)
    # –≠–¢–û –ù–ï Strava Data ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Å–∞–º
    "actual_result": {
        "time_seconds": "int",
        "entered_at": "datetime",
        "race_name": "string"
    }
}

# hike_predictions collection
# –ü—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ (–æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –±–µ–≥—É–Ω–æ–≤)
hike_predictions_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",  # null –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö
    "gpx_file_id": "ObjectId (ref: gpx_files)",
    "created_at": "datetime",
    
    # –ü—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞
    "hiker_profile": {
        "experience": "beginner|casual|regular|experienced",
        "backpack_weight": "light|medium|heavy",
        "group_size": "int",
        "has_children": "bool",
        "has_elderly": "bool",
        "first_time_altitude": "bool"
    },
    
    # –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞
    "result": {
        "estimated_time_hours": "float",
        "safe_time_hours": "float",
        "recommended_start": "string",
        "recommended_turnaround": "string"
    },
    
    # –†–∞–∑–±–∏–≤–∫–∞
    "breakdown": {
        "base_naismith_hours": "float",
        "profile_multiplier": "float",
        "rest_time_hours": "float",
        "altitude_correction": "float"
    },
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
    "warnings_shown": ["string"],
    
    # –†–µ–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    "actual_result": {
        "time_hours": "float",
        "entered_at": "datetime",
        "difficulty_rating": "int (1-5)",
        "comment": "string"
    }
}

# known_routes collection
# –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã —Å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
known_routes_schema = {
    "_id": "ObjectId",
    "name": "string",  # "–ö–æ–∫-–ñ–∞–π–ª—è—É"
    "name_en": "string",  # "Kok-Zhailau"
    "region": "string",  # "Almaty"
    
    # Fingerprint –¥–ª—è matching
    "fingerprint": {
        "start_geohash": "string",
        "end_geohash": "string",
        "highest_geohash": "string",
        "distance_bucket": "int",
        "elevation_bucket": "int"
    },
    
    # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    "metadata": {
        "distance_km": "float",
        "elevation_gain_m": "float",
        "elevation_loss_m": "float",
        "max_altitude_m": "float",
        "is_round_trip": "bool",
        "difficulty": "easy|medium|hard|expert"
    },
    
    # GPX –¥–∞–Ω–Ω—ã–µ
    "gpx_content": "string",
    "elevation_profile": [{"distance_km": "float", "elevation_m": "float"}],
    
    # Crowdsourced –¥–∞–Ω–Ω—ã–µ
    "surface_info": {
        "primary": "string",
        "breakdown": {"dirt": 60, "rock": 30, "scree": 10}
    },
    "reports_count": "int",
    "avg_rating": "float",
    
    # –ö–æ–Ω—Ç–µ–Ω—Ç
    "description": "string",
    "photos": ["string (urls)"],
    "tips": ["string"],
    
    # –ú–æ–¥–µ—Ä–∞—Ü–∏—è
    "status": "draft|published|archived",
    "created_at": "datetime",
    "updated_at": "datetime"
}

# trail_segments collection
# Crowdsourced –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ (–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏)
trail_segments_schema = {
    "_id": "ObjectId",
    
    # –ì–µ–æ–ø—Ä–∏–≤—è–∑–∫–∞ (–ù–ï –∫ —Ñ–∞–π–ª—É!)
    "geohash": "string",  # 7-—Å–∏–º–≤–æ–ª—å–Ω—ã–π, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    "location": {
        "type": "Point",
        "coordinates": ["lon", "lat"]  # –î–ª—è 2dsphere –∑–∞–ø—Ä–æ—Å–æ–≤
    },
    
    # –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ –ø–æ–∫—Ä—ã—Ç–∏–µ
    "surface_votes": {
        "dirt": "int",
        "rock": "int",
        "scree": "int",
        "roots": "int",
        "mud": "int",
        "snow": "int"
        # ...
    },
    "primary_surface": "string",  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ votes
    
    # –°–ª–æ–∂–Ω–æ—Å—Ç—å
    "difficulty_sum": "float",
    "difficulty_votes": "int",
    "difficulty_avg": "float",
    
    # –°–µ–∑–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ö–†–ò–¢–ò–ß–ù–û –¥–ª—è –≥–æ—Ä!)
    "seasonal_info": {
        "summer": {
            "surface_primary": "string",
            "difficulty_avg": "float",
            "reports_count": "int"
        },
        "winter": {
            "surface_primary": "string",
            "difficulty_avg": "float",
            "reports_count": "int"
        }
    },
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    "warnings": [{
        "type": "string",  # slippery_when_wet, dangerous_section, etc
        "description": "string",
        "reported_count": "int",
        "reported_at": "datetime",
        "season": "string"
    }],
    
    # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
    "recent_comments": [{
        "text": "string (max 500)",
        "date": "datetime",
        "season": "string",
        "user_experience": "string"
    }],
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    "reports_count": "int",
    "first_report": "datetime",
    "last_updated": "datetime"
}

# surface_reports collection
# –ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á—ë—Ç–æ–≤ (–¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞)
surface_reports_schema = {
    "_id": "ObjectId",
    "user_id": "ObjectId (ref: users)",  # null –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö
    "submitted_at": "datetime",
    
    # –ú–∞—Ä—à—Ä—É—Ç
    "route_matched_id": "ObjectId (ref: known_routes)",  # null –µ—Å–ª–∏ –Ω–µ matched
    "gpx_fingerprint": "dict",
    
    # –î–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞
    "overall_difficulty": "int (1-5)",
    "primary_surfaces": ["string"],
    "weather_conditions": "string",
    "date_hiked": "datetime",
    "comment": "string",
    
    # –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
    "difficult_sections": [{
        "lat": "float",
        "lon": "float",
        "geohash": "string",
        "type": "string",
        "comment": "string"
    }],
    
    # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∞–Ω–æ–Ω–∏–º–Ω–æ)
    "user_experience_level": "string",
    
    # –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
    "processed": "bool",
    "segments_updated": "int"
}
```

### 6.2 Redis –∫—ç—à

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π Redis

# –¢–æ–∫–µ–Ω—ã Strava (—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ)
f"strava:tokens:{user_id}" -> {
    "access_token": "encrypted",
    "refresh_token": "encrypted", 
    "expires_at": "timestamp"
}
# TTL: –¥–æ expires_at

# –ö—ç—à –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
f"strava:activities:{user_id}:{activity_id}" -> {
    "distance": float,
    "elapsed_time": int,
    ...
}
# TTL: 7 –¥–Ω–µ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ API Agreement!)

# –ö—ç—à –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
f"athlete:metrics:{user_id}" -> {
    "best_efforts": {...},
    "weekly_volume": float,
    ...
}
# TTL: 24 —á–∞—Å–∞ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ)

# Rate limiting
f"ratelimit:strava:{user_id}" -> count
# TTL: 15 –º–∏–Ω—É—Ç
```

### 6.3 TTL –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è

```python
# MongoDB TTL –∏–Ω–¥–µ–∫—Å—ã

# –£–¥–∞–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π
db.activities_cache.create_index(
    "cached_at", 
    expireAfterSeconds=7*24*60*60  # 7 –¥–Ω–µ–π
)

# –ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Strava
async def on_strava_disconnect(user_id: str):
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∞–µ—Ç Strava.
    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ API Agreement!
    """
    # 1. –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã
    await redis.delete(f"strava:tokens:{user_id}")
    
    # 2. –£–¥–∞–ª—è–µ–º –∫—ç—à –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
    await db.activities_cache.delete_many({"user_id": user_id})
    
    # 3. –£–¥–∞–ª—è–µ–º —Å–≤—è–∑—å —Å–æ Strava
    await db.users.update_one(
        {"_id": user_id},
        {"$unset": {"strava": ""}}
    )
    
    # 4. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ ‚Äî —Ç–æ–∂–µ —É–¥–∞–ª—è–µ–º
    await db.athlete_metrics.delete_many({"user_id": user_id})
    
    # 5. –ü—Ä–æ–≥–Ω–æ–∑—ã –∏ GPX ‚Äî –û–°–¢–ê–í–õ–Ø–ï–ú
    # (—ç—Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)


# –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π

# trail_segments ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ crowdsourced –¥–∞–Ω–Ω—ã—Ö
db.trail_segments.create_index("geohash", unique=True)
db.trail_segments.create_index([("location", "2dsphere")])  # Geo-–∑–∞–ø—Ä–æ—Å—ã
db.trail_segments.create_index("primary_surface")
db.trail_segments.create_index("last_updated")

# known_routes ‚Äî –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
db.known_routes.create_index("fingerprint.start_geohash")
db.known_routes.create_index("fingerprint.end_geohash")
db.known_routes.create_index("region")
db.known_routes.create_index([("name", "text"), ("description", "text")])  # –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫

# hike_predictions ‚Äî –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤
db.hike_predictions.create_index("user_id")
db.hike_predictions.create_index("created_at")
db.hike_predictions.create_index("gpx_file_id")

# surface_reports ‚Äî –∏—Å—Ç–æ—Ä–∏—è –æ—Ç—á—ë—Ç–æ–≤
db.surface_reports.create_index("user_id")
db.surface_reports.create_index("submitted_at")
db.surface_reports.create_index("processed")
```

---

## 7. API Endpoints

### 7.1 –ü—É–±–ª–∏—á–Ω—ã–µ endpoints (–±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)

```yaml
# –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –±–µ–∑ Strava
POST /api/v1/predict/simple
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>           # GPX —Ñ–∞–π–ª —Ç—Ä–∞—Å—Å—ã
  best_10k_seconds: int      # –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 10–ö
  terrain_type: string       # "road" | "trail" | "technical"

Response:
  {
    "prediction": {
      "time_seconds": 16320,
      "time_formatted": "4:32:00",
      "confidence_range": {
        "min_formatted": "4:05:00",
        "max_formatted": "4:59:00"
      }
    },
    "course": {
      "distance_km": 42.2,
      "elevation_gain_m": 847,
      "elevation_loss_m": 823
    },
    "segments": [
      {
        "km": "0-5",
        "pace": "5:45/–∫–º",
        "elevation_change": "+120–º"
      },
      ...
    ],
    "share_image_url": "https://...",  # –ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞
    "cta": {
      "text": "–¢—Ä–µ–Ω–∏—Ä—É–π—Å—è —Å –∫–ª—É–±–æ–º Ayda Run",
      "url": "https://ayda.run?utm_source=predictor"
    }
  }
```

### 7.2 –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ endpoints

```yaml
# OAuth flow –¥–ª—è Strava
GET /api/v1/auth/strava
Response: Redirect to Strava authorization

GET /api/v1/auth/strava/callback?code=xxx
Response:
  {
    "success": true,
    "user_id": "...",
    "athlete_name": "–†–µ–Ω–∞—Ç"
  }

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Strava
DELETE /api/v1/auth/strava
Response:
  {
    "success": true,
    "message": "Strava disconnected, all cached data deleted"
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞—Ç–ª–µ—Ç–∞
GET /api/v1/athlete/me
Response:
  {
    "has_strava": true,
    "best_efforts": {
      "5k": {"time": "22:00", "date": "2024-09-15"},
      "10k": {"time": "47:00", "date": "2024-10-20"},
      "half_marathon": {"time": "1:48:00", "date": "2024-11-03"}
    },
    "personal_fatigue_factor": 1.11,
    "weekly_volume_km": 45,
    "data_freshness": "2 hours ago"
  }

# –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å–æ Strava –¥–∞–Ω–Ω—ã–º–∏
POST /api/v1/predict/full
Request:
  Content-Type: multipart/form-data
  Authorization: Bearer <token>
  
  gpx_file: <file>
  terrain_type: string
  use_personal_factor: bool   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor

Response:
  {
    "prediction": {...},
    "personalization": {
      "fatigue_factor_used": 1.11,
      "based_on_activities": 47,
      "training_status": "good"  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –æ–±—ä—ë–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
    },
    ...
  }

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
POST /api/v1/predictions/{prediction_id}/actual
Request:
  {
    "actual_time_seconds": 16800,
    "race_name": "–ê–ª–º–∞—Ç—ã –ú–∞—Ä–∞—Ñ–æ–Ω 2025"
  }

Response:
  {
    "prediction_accuracy": "+2.9%",
    "message": "–°–ø–∞—Å–∏–±–æ! –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤."
  }
```

### 7.3 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ GPX —Ç—Ä–∞—Å—Å–∞–º–∏

```yaml
# –ó–∞–≥—Ä—É–∑–∫–∞ GPX
POST /api/v1/gpx
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>
  name: string              # –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞—Å—Å—ã
  make_public: bool         # –°–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π –¥–ª—è –¥—Ä—É–≥–∏—Ö

Response:
  {
    "gpx_id": "...",
    "metadata": {
      "distance_km": 42.2,
      "elevation_gain_m": 847,
      "elevation_corrected": true
    }
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω—ã—Ö —Ç—Ä–∞—Å—Å
GET /api/v1/gpx/public?location=almaty
Response:
  {
    "courses": [
      {
        "id": "...",
        "name": "–ê–ª–º–∞—Ç—ã –ú–∞—Ä–∞—Ñ–æ–Ω 2025",
        "distance_km": 42.2,
        "elevation_gain_m": 847,
        "predictions_count": 234
      },
      ...
    ]
  }
```

### 7.4 API –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤

```yaml
# –ü—Ä–æ–≥–Ω–æ–∑ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∞ (–±–µ–∑ –±–µ–≥–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
POST /api/v1/predict/hike
Request:
  Content-Type: multipart/form-data
  
  # –ú–∞—Ä—à—Ä—É—Ç (–æ–¥–∏–Ω –∏–∑ –¥–≤—É—Ö)
  gpx_file: <file>                    # GPX —Ñ–∞–π–ª
  # –ò–õ–ò
  known_route_id: string              # ID –∏–∑ –±–∞–∑—ã –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö
  
  # –ü—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞
  experience: string                  # beginner|casual|regular|experienced
  backpack_weight: string             # light|medium|heavy
  group_size: int                     # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫
  has_children: bool                  # default: false
  has_elderly: bool                   # default: false
  first_time_altitude: bool           # default: false
  is_round_trip: bool                 # default: true

Response:
  {
    "prediction": {
      "estimated_hours": 5.5,
      "safe_hours": 6.6,
      "formatted": "5 —á 30 –º–∏–Ω ‚Äî 6 —á 40 –º–∏–Ω"
    },
    "schedule": {
      "recommended_start": "07:00",
      "turnaround_time": "10:30",
      "expected_return": "13:30",
      "daylight_margin": "+3 —á–∞—Å–∞ –¥–æ –∑–∞–∫–∞—Ç–∞"
    },
    "course": {
      "name": "–ö–æ–∫-–ñ–∞–π–ª—è—É",
      "distance_km": 12,
      "elevation_gain_m": 680,
      "max_altitude_m": 2500
    },
    "warnings": [
      {
        "level": "warning",  # info|warning|danger
        "icon": "üèîÔ∏è",
        "message": "–í—ã—Å–æ—Ç–∞ 2500–º ‚Äî –∏–¥–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ",
        "detail": "–ü–µ–π—Ç–µ –±–æ–ª—å—à–µ –≤–æ–¥—ã, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ–º"
      },
      {
        "level": "info",
        "icon": "üíß",
        "message": "–í–æ–∑—å–º–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2–ª –≤–æ–¥—ã –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞"
      }
    ],
    "breakdown": {
      "base_naismith_hours": 3.2,
      "profile_multiplier": 1.44,
      "factors": {
        "experience": 1.2,
        "backpack": 1.0,
        "group": 1.1,
        "altitude": 1.1
      },
      "rest_time_hours": 0.7
    },
    "checklist": [
      "‚úì –í–æ–¥–∞ (–º–∏–Ω–∏–º—É–º 2–ª)",
      "‚úì –ü–µ—Ä–µ–∫—É—Å",
      "‚úì –°–æ–ª–Ω—Ü–µ–∑–∞—â–∏—Ç–Ω—ã–π –∫—Ä–µ–º",
      "‚úì –ì–æ–ª–æ–≤–Ω–æ–π —É–±–æ—Ä",
      "‚úì –ó–∞—Ä—è–∂–µ–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω",
      "‚úì –°–æ–æ–±—â–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç –±–ª–∏–∑–∫–∏–º"
    ],
    "share_url": "https://..."
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
GET /api/v1/routes/popular?region=almaty
Response:
  {
    "routes": [
      {
        "id": "...",
        "name": "–ö–æ–∫-–ñ–∞–π–ª—è—É",
        "distance_km": 12,
        "elevation_gain_m": 680,
        "max_altitude_m": 2500,
        "difficulty": "medium",
        "is_round_trip": true,
        "typical_time_hours": 5,
        "photo_url": "https://...",
        "description": "–ñ–∏–≤–æ–ø–∏—Å–Ω–æ–µ –ø–ª–∞—Ç–æ —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä—ã",
        "reports_count": 156,
        "avg_rating": 4.6
      },
      {
        "id": "...",
        "name": "–ë—É—Ç–∞–∫–æ–≤—Å–∫–∏–π –≤–æ–¥–æ–ø–∞–¥",
        "difficulty": "easy",
        ...
      }
    ]
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
GET /api/v1/routes/{route_id}
Response:
  {
    "id": "...",
    "name": "–ö–æ–∫-–ñ–∞–π–ª—è—É",
    "metadata": {
      "distance_km": 12,
      "elevation_gain_m": 680,
      "elevation_loss_m": 680,
      "max_altitude_m": 2500,
      "is_round_trip": true
    },
    "surface_info": {
      "primary": "dirt",
      "breakdown": {"dirt": 65, "rock": 25, "scree": 10},
      "reports_count": 156
    },
    "elevation_profile": [
      {"km": 0, "elevation": 1800},
      {"km": 1, "elevation": 1920},
      ...
    ],
    "tips": [
      "–õ—É—á—à–µ–µ –≤—Ä–µ–º—è ‚Äî —Ä–∞–Ω–Ω–µ–µ —É—Ç—Ä–æ (–¥–æ 8:00)",
      "–ï—Å—Ç—å —Ä–æ–¥–Ω–∏–∫ –Ω–∞ 4-–º –∫–∏–ª–æ–º–µ—Ç—Ä–µ",
      "–í –≤—ã—Ö–æ–¥–Ω—ã–µ –º–Ω–æ–≥–æ –ª—é–¥–µ–π"
    ],
    "seasonal_notes": {
      "summer": "–°—É—Ö–æ, –∂–∞—Ä–∫–æ –¥–Ω—ë–º",
      "winter": "–°–Ω–µ–≥, –Ω—É–∂–Ω—ã –∫–æ—à–∫–∏/—Å–Ω–µ–≥–æ—Å—Ç—É–ø—ã"
    },
    "recent_reviews": [
      {
        "date": "2025-07-15",
        "rating": 5,
        "comment": "–û—Ç–ª–∏—á–Ω–∞—è —Ç—Ä–æ–ø–∞!",
        "difficulty_felt": "medium"
      }
    ]
  }
```

### 7.5 API –¥–ª—è Crowdsourced –ø–æ–∫—Ä—ã—Ç–∏—è

```yaml
# –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –ø–æ—Å–ª–µ –ø–æ—Ö–æ–¥–∞
POST /api/v1/trails/report
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>                    # GPX –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
  overall_difficulty: int             # 1-5
  primary_surfaces: string[]          # ["dirt", "rock"]
  weather_conditions: string          # dry|wet|snow
  date_hiked: string                  # ISO date
  comment: string                     # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  difficult_sections: json            # [{"lat": x, "lon": y, "type": "slippery", "comment": "..."}]
  user_experience: string             # beginner|regular|experienced

Response:
  {
    "success": true,
    "segments_updated": 47,
    "message": "–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç—á—ë—Ç –ø–æ–º–æ–∂–µ—Ç –¥—Ä—É–≥–∏–º —Ç—É—Ä–∏—Å—Ç–∞–º.",
    "route_matched": {
      "id": "...",
      "name": "–ö–æ–∫-–ñ–∞–π–ª—è—É",
      "confidence": 0.95
    },
    "contribution": {
      "total_reports": 5,
      "badge": "Trail Scout ü•æ"
    }
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
POST /api/v1/trails/surface-info
Request:
  Content-Type: multipart/form-data
  
  gpx_file: <file>
  season: string                      # spring|summer|autumn|winter

Response:
  {
    "coverage_percent": 73.5,
    "data_quality": "high",  # high|medium|low
    "primary_surface": "dirt",
    "surface_breakdown": {
      "dirt": 45.2,
      "rock": 28.3,
      "scree": 15.1,
      "unknown": 11.4
    },
    "difficulty_avg": 3.2,
    "seasonal_note": "–î–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã –¥–ª—è –ª–µ—Ç–∞",
    "warnings": [
      {
        "km": 3.2,
        "lat": 43.123,
        "lon": 77.456,
        "type": "slippery_when_wet",
        "reports_count": 7,
        "description": "–°–∫–æ–ª—å–∑–∫–∏–µ –∫–∞–º–Ω–∏ —É —Ä—É—á—å—è"
      }
    ],
    "recent_comments": [
      {
        "text": "–¢—Ä–æ–ø–∞ —Ö–æ—Ä–æ—à–æ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–º–æ–Ω—Ç–∞",
        "date": "2025-07-15",
        "season": "summer",
        "user_experience": "regular"
      }
    ]
  }

# –ü–æ–ª—É—á–µ–Ω–∏–µ OSM –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ fallback
GET /api/v1/trails/osm-info?lat=43.123&lon=77.456
Response:
  {
    "source": "osm",
    "surface": "rock",
    "osm_tags": {
      "highway": "path",
      "surface": "rock",
      "sac_scale": "mountain_hiking"
    },
    "confidence": 0.6
  }
```

---

## 8. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ Strava

### 8.1 OAuth 2.0 flow

```python
from fastapi import FastAPI, Request
from fastapi.responses import RedirectResponse
import httpx

app = FastAPI()

STRAVA_CLIENT_ID = "your_client_id"
STRAVA_CLIENT_SECRET = "your_client_secret"  # –í –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!
REDIRECT_URI = "https://yourdomain.com/api/v1/auth/strava/callback"

@app.get("/api/v1/auth/strava")
async def strava_auth():
    """–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç OAuth flow"""
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û –Ω—É–∂–Ω—ã–µ scopes
    # activity:read ‚Äî —á—Ç–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
    # –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º activity:write, profile:write –∏ —Ç.–¥.
    
    auth_url = (
        f"https://www.strava.com/oauth/authorize"
        f"?client_id={STRAVA_CLIENT_ID}"
        f"&redirect_uri={REDIRECT_URI}"
        f"&response_type=code"
        f"&scope=activity:read"
        f"&approval_prompt=auto"
    )
    
    return RedirectResponse(auth_url)


@app.get("/api/v1/auth/strava/callback")
async def strava_callback(code: str, scope: str):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback –æ—Ç Strava"""
    
    # –û–±–º–µ–Ω–∏–≤–∞–µ–º code –Ω–∞ —Ç–æ–∫–µ–Ω—ã
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://www.strava.com/oauth/token",
            data={
                "client_id": STRAVA_CLIENT_ID,
                "client_secret": STRAVA_CLIENT_SECRET,
                "code": code,
                "grant_type": "authorization_code"
            }
        )
    
    token_data = response.json()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ!)
    await save_strava_tokens(
        athlete_id=token_data["athlete"]["id"],
        access_token=encrypt(token_data["access_token"]),
        refresh_token=encrypt(token_data["refresh_token"]),
        expires_at=token_data["expires_at"]
    )
    
    # Redirect –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    return RedirectResponse("/app?strava=connected")


async def refresh_strava_token(user_id: str) -> str:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç—ë–∫—à–∏–π —Ç–æ–∫–µ–Ω"""
    
    user = await get_user(user_id)
    refresh_token = decrypt(user["strava"]["refresh_token"])
    
    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://www.strava.com/oauth/token",
            data={
                "client_id": STRAVA_CLIENT_ID,
                "client_secret": STRAVA_CLIENT_SECRET,
                "refresh_token": refresh_token,
                "grant_type": "refresh_token"
            }
        )
    
    token_data = response.json()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ
    await update_strava_tokens(user_id, token_data)
    
    return token_data["access_token"]
```

### 8.2 –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞—Ç–ª–µ—Ç–∞

```python
async def fetch_athlete_data(user_id: str) -> dict:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞—Ç–ª–µ—Ç–∞ –∏–∑ Strava.
    
    –í–ê–ñ–ù–û: 
    - –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º GPS/–∫–∞—Ä—Ç—ã
    - –ö—ç—à–∏—Ä—É–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ max 7 –¥–Ω–µ–π
    - –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–ª—å—à–µ
    """
    
    access_token = await get_valid_token(user_id)
    
    async with httpx.AsyncClient() as client:
        headers = {"Authorization": f"Bearer {access_token}"}
        
        # 1. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—Ç–ª–µ—Ç–∞ (best efforts)
        stats_response = await client.get(
            f"https://www.strava.com/api/v3/athletes/{athlete_id}/stats",
            headers=headers
        )
        stats = stats_response.json()
        
        # 2. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (6 –º–µ—Å—è—Ü–µ–≤)
        six_months_ago = datetime.now() - timedelta(days=180)
        activities_response = await client.get(
            "https://www.strava.com/api/v3/athlete/activities",
            headers=headers,
            params={
                "after": int(six_months_ago.timestamp()),
                "per_page": 100
            }
        )
        activities = activities_response.json()
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
    best_efforts = extract_best_efforts(stats)
    
    # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–±–µ–∑ GPS!)
    aggregated = aggregate_activities(activities)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    await save_athlete_metrics(user_id, {
        "best_efforts": best_efforts,
        "training_summary": aggregated,
        "personal_fatigue_factor": calculate_personal_fatigue_factor(best_efforts)
    })
    
    return {
        "best_efforts": best_efforts,
        "training_summary": aggregated
    }


def extract_best_efforts(stats: dict) -> dict:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç best efforts –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ Strava"""
    
    return {
        "5k": {
            "time_seconds": stats.get("best_5k", {}).get("elapsed_time"),
            "date": stats.get("best_5k", {}).get("start_date")
        },
        "10k": {
            "time_seconds": stats.get("best_10k", {}).get("elapsed_time"),
            "date": stats.get("best_10k", {}).get("start_date")
        },
        "half_marathon": {
            "time_seconds": stats.get("best_half_marathon", {}).get("elapsed_time"),
            "date": stats.get("best_half_marathon", {}).get("start_date")
        },
        "marathon": {
            "time_seconds": stats.get("best_marathon", {}).get("elapsed_time"),
            "date": stats.get("best_marathon", {}).get("start_date")
        }
    }


def aggregate_activities(activities: list) -> dict:
    """
    –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –º–µ—Ç—Ä–∏–∫–∏.
    
    –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º:
    - GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    - –ö–∞—Ä—Ç—ã/polylines
    - Segment efforts
    """
    
    runs = [a for a in activities if a["type"] in ["Run", "Trail Run"]]
    
    if not runs:
        return {}
    
    # –°—á–∏—Ç–∞–µ–º –Ω–µ–¥–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º
    total_distance = sum(a["distance"] for a in runs) / 1000  # –≤ –∫–º
    weeks = (datetime.now() - datetime.fromisoformat(runs[-1]["start_date"])).days / 7
    weekly_volume = total_distance / weeks if weeks > 0 else 0
    
    # –°—Ä–µ–¥–Ω–∏–π —Ç–µ–º–ø
    total_time = sum(a["moving_time"] for a in runs)
    avg_pace = total_time / total_distance if total_distance > 0 else 0
    
    # –ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã
    total_elevation = sum(a.get("total_elevation_gain", 0) for a in runs)
    
    return {
        "weekly_volume_km": round(weekly_volume, 1),
        "weekly_runs_count": round(len(runs) / weeks, 1) if weeks > 0 else 0,
        "avg_pace_per_km": round(avg_pace, 0),
        "total_elevation_gain_monthly": round(total_elevation / (weeks/4), 0) if weeks > 0 else 0,
        "activities_count": len(runs)
    }
```

### 8.3 Rate Limiting

```python
from datetime import datetime, timedelta

# Strava API –ª–∏–º–∏—Ç—ã:
# - 200 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 15 –º–∏–Ω—É—Ç
# - 2000 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å

class StravaRateLimiter:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ rate limits –¥–ª—è Strava API"""
    
    def __init__(self, redis_client):
        self.redis = redis_client
        self.SHORT_LIMIT = 200   # –∑–∞ 15 –º–∏–Ω—É—Ç
        self.DAILY_LIMIT = 2000  # –∑–∞ –¥–µ–Ω—å
    
    async def check_and_increment(self, user_id: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏–º–∏—Ç—ã –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫.
        
        Returns:
            True –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à—ë–Ω, False –µ—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
        """
        
        # –ö–ª—é—á–∏ –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤
        short_key = f"ratelimit:strava:short:{user_id}"
        daily_key = f"ratelimit:strava:daily:{datetime.now().date()}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –ª–∏–º–∏—Ç
        short_count = await self.redis.get(short_key) or 0
        if int(short_count) >= self.SHORT_LIMIT:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç
        daily_count = await self.redis.get(daily_key) or 0
        if int(daily_count) >= self.DAILY_LIMIT:
            return False
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏
        pipe = self.redis.pipeline()
        pipe.incr(short_key)
        pipe.expire(short_key, 15 * 60)  # 15 –º–∏–Ω—É—Ç
        pipe.incr(daily_key)
        pipe.expire(daily_key, 24 * 60 * 60)  # 24 —á–∞—Å–∞
        await pipe.execute()
        
        return True
    
    async def get_remaining(self, user_id: str) -> dict:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ª–∏–º–∏—Ç—ã"""
        
        short_key = f"ratelimit:strava:short:{user_id}"
        daily_key = f"ratelimit:strava:daily:{datetime.now().date()}"
        
        short_count = int(await self.redis.get(short_key) or 0)
        daily_count = int(await self.redis.get(daily_key) or 0)
        
        return {
            "short_remaining": self.SHORT_LIMIT - short_count,
            "short_reset_in_seconds": await self.redis.ttl(short_key),
            "daily_remaining": self.DAILY_LIMIT - daily_count
        }
```

### 8.4 Strava Webhooks

–í–º–µ—Å—Ç–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ polling –∏—Å–ø–æ–ª—å–∑—É–µ–º Webhook Subscription API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è
—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

> **üìù –†–µ—à–µ–Ω–∏–µ (–æ–±—Å—É–∂–¥–µ–Ω–æ 2025-01-09):** Webhooks ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è
> –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –≠–∫–æ–Ω–æ–º–∏—Ç API –ª–∏–º–∏—Ç—ã –∏
> –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

#### 8.4.1 –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Webhook –ø–æ–¥–ø–∏—Å–∫–∏

```python
import httpx
from fastapi import APIRouter, Query, Response

router = APIRouter()

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è webhook –ø–æ–¥–ø–∏—Å–∫–∏ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ)
async def create_webhook_subscription():
    """
    –°–æ–∑–¥–∞—ë—Ç webhook –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–æ–±—ã—Ç–∏—è—Ö.

    –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π:
    - activity.create ‚Äî –Ω–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    - activity.update ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    - activity.delete ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    - athlete.update ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –∞—Ç–ª–µ—Ç–∞
    - athlete.deauthorize ‚Äî –æ—Ç–∑—ã–≤ –¥–æ—Å—Ç—É–ø–∞
    """

    async with httpx.AsyncClient() as client:
        response = await client.post(
            "https://www.strava.com/api/v3/push_subscriptions",
            data={
                "client_id": STRAVA_CLIENT_ID,
                "client_secret": STRAVA_CLIENT_SECRET,
                "callback_url": f"{BASE_URL}/api/strava/webhook",
                "verify_token": WEBHOOK_VERIFY_TOKEN  # –°–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
            }
        )

    if response.status_code == 201:
        subscription = response.json()
        logger.info(f"Webhook subscription created: {subscription['id']}")
        return subscription
    else:
        logger.error(f"Failed to create subscription: {response.text}")
        raise Exception("Webhook subscription failed")
```

#### 8.4.2 –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è Webhook endpoint

```python
@router.get("/api/strava/webhook")
async def verify_webhook(
    hub_mode: str = Query(..., alias="hub.mode"),
    hub_challenge: str = Query(..., alias="hub.challenge"),
    hub_verify_token: str = Query(..., alias="hub.verify_token")
):
    """
    Strava –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—à endpoint –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏.
    –î–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å hub.challenge –µ—Å–ª–∏ verify_token —Å–æ–≤–ø–∞–¥–∞–µ—Ç.
    """

    if hub_mode == "subscribe" and hub_verify_token == WEBHOOK_VERIFY_TOKEN:
        logger.info("Webhook verification successful")
        return {"hub.challenge": hub_challenge}

    logger.warning(f"Webhook verification failed: invalid token")
    return Response(status_code=403)
```

#### 8.4.3 –û–±—Ä–∞–±–æ—Ç–∫–∞ Webhook —Å–æ–±—ã—Ç–∏–π

```python
from pydantic import BaseModel
from enum import Enum
from typing import Optional
import asyncio

class WebhookObjectType(str, Enum):
    ACTIVITY = "activity"
    ATHLETE = "athlete"

class WebhookAspectType(str, Enum):
    CREATE = "create"
    UPDATE = "update"
    DELETE = "delete"

class StravaWebhookEvent(BaseModel):
    """–ú–æ–¥–µ–ª—å –≤—Ö–æ–¥—è—â–µ–≥–æ webhook —Å–æ–±—ã—Ç–∏—è –æ—Ç Strava"""
    object_type: WebhookObjectType
    object_id: int                    # ID –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∞—Ç–ª–µ—Ç–∞
    aspect_type: WebhookAspectType
    owner_id: int                     # Strava athlete ID
    subscription_id: int
    event_time: int                   # Unix timestamp
    updates: Optional[dict] = None    # –î–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–ª—è update)

@router.post("/api/strava/webhook")
async def handle_webhook(event: StravaWebhookEvent):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç Strava.

    –í–ê–ñ–ù–û:
    - –û—Ç–≤–µ—á–∞–µ–º –±—ã—Å—Ç—Ä–æ (< 2 —Å–µ–∫—É–Ω–¥), –∏–Ω–∞—á–µ Strava –ø–æ–≤—Ç–æ—Ä–∏—Ç –∑–∞–ø—Ä–æ—Å
    - –¢—è–∂—ë–ª—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–µ–ª–∞–µ–º –≤ —Ñ–æ–Ω–µ
    """

    logger.info(f"Received webhook: {event.object_type}.{event.aspect_type} "
                f"for athlete {event.owner_id}")

    # –ù–∞—Ö–æ–¥–∏–º –Ω–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Strava athlete ID
    user = await get_user_by_strava_id(event.owner_id)
    if not user:
        logger.warning(f"Unknown athlete ID: {event.owner_id}")
        return {"status": "ignored"}

    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ
    asyncio.create_task(process_webhook_event(user["id"], event))

    # –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç Strava
    return {"status": "ok"}


async def process_webhook_event(user_id: str, event: StravaWebhookEvent):
    """–§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook —Å–æ–±—ã—Ç–∏—è"""

    try:
        if event.object_type == WebhookObjectType.ACTIVITY:
            if event.aspect_type == WebhookAspectType.CREATE:
                # –ù–æ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await handle_new_activity(user_id, event.object_id)

            elif event.aspect_type == WebhookAspectType.UPDATE:
                # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚Äî –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if event.updates and "title" not in event.updates:
                    # –ò–∑–º–µ–Ω–∏–ª–∏—Å—å –∑–Ω–∞—á–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    await handle_activity_update(user_id, event.object_id)

            elif event.aspect_type == WebhookAspectType.DELETE:
                # –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                await handle_activity_delete(user_id, event.object_id)

        elif event.object_type == WebhookObjectType.ATHLETE:
            if event.aspect_type == WebhookAspectType.UPDATE:
                # –û–±–Ω–æ–≤–∏–ª—Å—è –ø—Ä–æ—Ñ–∏–ª—å –∞—Ç–ª–µ—Ç–∞
                await handle_athlete_update(user_id)

            elif event.aspect_type.value == "deauthorize":
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–æ–∑–≤–∞–ª –¥–æ—Å—Ç—É–ø –≤ Strava
                await handle_deauthorization(user_id)

    except Exception as e:
        logger.error(f"Error processing webhook for user {user_id}: {e}")


async def handle_new_activity(user_id: str, activity_id: int):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.

    –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ä–∞–∑—É.
    –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏, –æ–±–Ω–æ–≤–∏–º –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–æ–≥–Ω–æ–∑–µ.
    """

    # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –º–µ—Ç—Ä–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await invalidate_athlete_metrics_cache(user_id)

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await notify_user_new_activity(user_id, activity_id)


async def handle_deauthorization(user_id: str):
    """
    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–æ–∑–≤–∞–ª –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Strava.
    –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ Strava —Å–æ–≥–ª–∞—Å–Ω–æ API Agreement.
    """

    logger.info(f"User {user_id} deauthorized Strava access")

    # –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã
    await delete_strava_tokens(user_id)

    # –£–¥–∞–ª—è–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Strava
    await delete_strava_cache(user_id)

    # –ü–æ–º–µ—á–∞–µ–º —á—Ç–æ Strava –æ—Ç–∫–ª—é—á—ë–Ω
    await update_user_strava_status(user_id, connected=False)

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await notify_user_strava_disconnected(user_id)
```

#### 8.4.4 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Webhook –ø–æ–¥–ø–∏—Å–∫–∏

```python
async def check_webhook_subscription():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å webhook –ø–æ–¥–ø–∏—Å–∫–∏.
    –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ (—Ä–∞–∑ –≤ –¥–µ–Ω—å).
    """

    async with httpx.AsyncClient() as client:
        response = await client.get(
            "https://www.strava.com/api/v3/push_subscriptions",
            params={
                "client_id": STRAVA_CLIENT_ID,
                "client_secret": STRAVA_CLIENT_SECRET
            }
        )

    subscriptions = response.json()

    if not subscriptions:
        logger.warning("No active webhook subscriptions! Recreating...")
        await create_webhook_subscription()
    else:
        logger.info(f"Webhook subscription active: {subscriptions[0]['id']}")


async def delete_webhook_subscription(subscription_id: int):
    """–£–¥–∞–ª—è–µ—Ç webhook –ø–æ–¥–ø–∏—Å–∫—É (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)"""

    async with httpx.AsyncClient() as client:
        response = await client.delete(
            f"https://www.strava.com/api/v3/push_subscriptions/{subscription_id}",
            params={
                "client_id": STRAVA_CLIENT_ID,
                "client_secret": STRAVA_CLIENT_SECRET
            }
        )

    return response.status_code == 204
```

> **‚ö†Ô∏è –í–∞–∂–Ω–æ –æ Webhooks:**
> - –û–¥–∏–Ω subscription –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–Ω–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
> - Webhook endpoint –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ < 2 —Å–µ–∫—É–Ω–¥
> - Strava –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å –¥–æ 3 —Ä–∞–∑ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
> - –ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É —Å –Ω–æ–≤—ã–º callback_url

---

## 9. Privacy Policy –∏ —Å–æ–≥–ª–∞—Å–∏—è

### 9.1 –®–∞–±–ª–æ–Ω Privacy Policy

```markdown
# –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ Ayda Run Predictor

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** [–¥–∞—Ç–∞]

## 1. –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –º—ã —Å–æ–±–∏—Ä–∞–µ–º

### 1.1 –î–∞–Ω–Ω—ã–µ –∏–∑ Strava (–ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏)

–ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ Strava –º—ã –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫:
- –í–∞—à–∏–º –ª—É—á—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–∏—Å—Ç–∞–Ω—Ü–∏—è—Ö (5–ö, 10–ö, –ø–æ–ª—É–º–∞—Ä–∞—Ñ–æ–Ω, –º–∞—Ä–∞—Ñ–æ–Ω)
- –ò—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
- –ë–∞–∑–æ–≤—ã–º –º–µ—Ç—Ä–∏–∫–∞–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π (–¥–∏—Å—Ç–∞–Ω—Ü–∏—è, –≤—Ä–µ–º—è, –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã, —Å—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å)

**–ú—ã –ù–ï –ø–æ–ª—É—á–∞–µ–º –∏ –ù–ï —Ö—Ä–∞–Ω–∏–º:**
- GPS-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–∞—à–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫
- –ö–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –î–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
- –í–∞—à—É –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é

### 1.2 GPX —Ñ–∞–π–ª—ã

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å GPX —Ñ–∞–π–ª—ã —Ç—Ä–∞—Å—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞. –≠—Ç–∏ —Ñ–∞–π–ª—ã:
- –•—Ä–∞–Ω—è—Ç—Å—è –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
- –ú–æ–≥—É—Ç –±—ã—Ç—å —Å–¥–µ–ª–∞–Ω—ã –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Å –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è
- –£–¥–∞–ª—è—é—Ç—Å—è –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É

### 1.3 –î–∞–Ω–Ω—ã–µ, –≤–≤–µ–¥—ë–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é

- –í–∞—à –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ 10–ö
- –í–µ—Å –∏ –≤–æ–∑—Ä–∞—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–±–µ–≥–æ–≤ (–¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏)

## 2. –ö–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ

–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è:
- –†–∞—Å—á—ë—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–±–µ–≥–∞
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∞—à–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
- –£–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, 
  –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤–≤–æ–¥–∏—Ç–µ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ)

**–ú—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è:**
- –û–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è
- –ü—Ä–æ–¥–∞–∂–∏ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º
- –†–µ–∫–ª–∞–º–Ω–æ–≥–æ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–∞
- –°–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–æ–≤ –±–µ–∑ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è

## 3. –ö–∞–∫ –¥–æ–ª–≥–æ –º—ã —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ

| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö | –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è |
|------------|---------------|
| –ö—ç—à –¥–∞–Ω–Ω—ã—Ö Strava | –î–æ 7 –¥–Ω–µ–π |
| –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ | –ü–æ–∫–∞ –ø–æ–¥–∫–ª—é—á—ë–Ω Strava |
| GPX —Ñ–∞–π–ª—ã | –ü–æ–∫–∞ –≤—ã –Ω–µ —É–¥–∞–ª–∏—Ç–µ |
| –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ | –ë–µ—Å—Å—Ä–æ—á–Ω–æ (–≤–∞—à–∞ –∏—Å—Ç–æ—Ä–∏—è) |
| –í–≤–µ–¥—ë–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–æ–∫ | –ë–µ—Å—Å—Ä–æ—á–Ω–æ |

## 4. –í–∞—à–∏ –ø—Ä–∞–≤–∞

–í—ã –º–æ–∂–µ—Ç–µ –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç:
- **–û—Ç–∫–ª—é—á–∏—Ç—å Strava** ‚Äî –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Strava –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤ —Ç–µ—á–µ–Ω–∏–µ 48 —á–∞—Å–æ–≤
- **–£–¥–∞–ª–∏—Ç—å GPX —Ñ–∞–π–ª—ã** ‚Äî —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
- **–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç** ‚Äî –≤—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω—ã
- **–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–ø–∏—é –¥–∞–Ω–Ω—ã—Ö** ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –Ω–∞ [email]

## 5. –ü–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º

–ú—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –≤–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º, –∑–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º:
- Strava API (–¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Å –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è)
- –•–æ—Å—Ç–∏–Ω–≥-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (–¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞)

## 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –¢–æ–∫–µ–Ω—ã Strava —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ
- –í—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞—â–∏—â–µ–Ω—ã HTTPS
- –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω

## 7. –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏: [email]
```

### 9.2 Consent screens

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï STRAVA                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  –ú—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫:                                       ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚úì –í–∞—à–∏–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)                           ‚îÇ
‚îÇ  ‚úì –õ—É—á—à–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–∏—Å—Ç–∞–Ω—Ü–∏—è—Ö                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –ú—ã –ù–ï –ø–æ–ª—É—á–∞–µ–º:                                                ‚îÇ
‚îÇ  ‚úó GPS-—Ç—Ä–µ–∫–∏ –∏ –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤                                 ‚îÇ
‚îÇ  ‚úó –î–æ—Å—Ç—É–ø –∫ –∑–∞–ø–∏—Å–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π                                 ‚îÇ
‚îÇ  ‚úó –î–∞–Ω–Ω—ã–µ –≤–∞—à–∏—Ö –¥—Ä—É–∑–µ–π                                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ                ‚îÇ
‚îÇ  –≤–∞—à–µ–π —Ä–µ–∞–ª—å–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏.                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏]                              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ –ü–æ–¥–∫–ª—é—á–∏—Ç—å Strava ‚îÇ  ‚îÇ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å       ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å Strava –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç                     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              –°–î–ï–õ–ê–¢–¨ –¢–†–ê–°–°–£ –ü–£–ë–õ–ò–ß–ù–û–ô?                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ  –í—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏: –ê–ª–º–∞—Ç—ã –ú–∞—Ä–∞—Ñ–æ–Ω 2025.gpx                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Ç—Ä–∞—Å—Å—É –≤ –ø—É–±–ª–∏—á–Ω—É—é –±–∞–∑—É?                  ‚îÇ
‚îÇ  –î—Ä—É–≥–∏–µ –±–µ–≥—É–Ω—ã —Å–º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –¥–ª—è —Å–≤–æ–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑–æ–≤.     ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚óã –î–∞, —Å–¥–µ–ª–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–π                                        ‚îÇ
‚îÇ    –ù–∞–∑–≤–∞–Ω–∏–µ: [–ê–ª–º–∞—Ç—ã –ú–∞—Ä–∞—Ñ–æ–Ω 2025        ]                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚óè –ù–µ—Ç, —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–Ω—è                                         ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                           ‚îÇ
‚îÇ  ‚îÇ    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å     ‚îÇ                                           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                           ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 10. –†–∏—Å–∫–∏ –∏ –ø–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏

### 10.1 –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-------------|-----------|
| Strava –æ—Ç–∑—ã–≤–∞–µ—Ç API –¥–æ—Å—Ç—É–ø | –°—Ä–µ–¥–Ω—è—è | –ü–æ—Ç–µ—Ä—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ | –î–≤–æ–π–Ω–æ–π –≤–≤–æ–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Strava) |
| –ù–∞—Ä—É—à–µ–Ω–∏–µ API Agreement | –ù–∏–∑–∫–∞—è (–µ—Å–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞–º) | –ë–∞–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | –°—Ç—Ä–æ–≥–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª, –∫–æ–¥-—Ä–µ–≤—å—é |
| GDPR –∂–∞–ª–æ–±–∞ | –ù–∏–∑–∫–∞—è | –®—Ç—Ä–∞—Ñ, —Ä–µ–ø—É—Ç–∞—Ü–∏—è | –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è Privacy Policy, –ø—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ |
| Strava —É–∂–µ—Å—Ç–æ—á–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ | –°—Ä–µ–¥–Ω—è—è | –ü–µ—Ä–µ—Å–º–æ—Ç—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç API |

### 10.2 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-------------|-----------|
| –ù–µ—Ç–æ—á–Ω–æ—Å—Ç—å GPX elevation | –í—ã—Å–æ–∫–∞—è | –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ | DEM –∫–æ—Ä—Ä–µ–∫—Ü–∏—è + threshold filtering |
| Formulas –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –∞—Ç–ª–µ—Ç—É | –°—Ä–µ–¥–Ω—è—è | –ü–ª–æ—Ö–æ–π UX | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor + –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª |
| Strava rate limits | –°—Ä–µ–¥–Ω—è—è | –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ | –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, batch requests |
| DEM API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –ù–∏–∑–∫–∞—è | –î–µ–≥—Ä–∞–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ | Fallback –Ω–∞ —Å—ã—Ä—ã–µ GPS –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º |

### 10.3 –ü—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ —Ä–∏—Å–∫–∏

| –†–∏—Å–∫ | –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å | –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-------------|-------------|-----------|
| –ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ | –°—Ä–µ–¥–Ω—è—è | –ü–æ—Ç–µ—Ä—è –¥–æ–≤–µ—Ä–∏—è | –ß–µ—Å—Ç–Ω—ã–π confidence interval (¬±10-20%) |
| –°–ª–æ–∂–Ω—ã–π UX | –°—Ä–µ–¥–Ω—è—è | –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è | –ú–∏–Ω–∏–º—É–º —à–∞–≥–æ–≤, "–ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∂–∏–º" –±–µ–∑ Strava |
| –ù–µ—Ç –≤–∏—Ä–∞–ª—å–Ω–æ—Å—Ç–∏ | –í—ã—Å–æ–∫–∞—è | –ú–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç | –®–µ—Ä–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, —á–µ–ª–ª–µ–Ω–¥–∂–∏ |
| –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã —Å–∫–æ–ø–∏—Ä—É—é—Ç | –°—Ä–µ–¥–Ω—è—è | –ü–æ—Ç–µ—Ä—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ | –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ RU/KZ —Ä—ã–Ω–æ–∫ |

### 10.4 –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫

```
‚ö†Ô∏è –°–¶–ï–ù–ê–†–ò–ô 1: "ML –±–µ–∑ ML"

–ü–†–û–ë–õ–ï–ú–ê: –•–æ—á–µ—Ç—Å—è —É–ª—É—á—à–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: API Agreement –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å Strava –¥–∞–Ω–Ω—ã–µ
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–ú—ã –Ω–µ –æ–±—É—á–∞–µ–º ML, –ø—Ä–æ—Å—Ç–æ —É—Å—Ä–µ–¥–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã"
             ‚Üí –≠—Ç–æ –≤—Å—ë —Ä–∞–≤–Ω–æ "analytics" –∏ "products improvements"
             
–ü–†–ê–í–ò–õ–¨–ù–û: 
- –°–æ–±–∏—Ä–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –°–ê–ú –ø–æ—Å–ª–µ –≥–æ–Ω–∫–∏)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–æ–∫
- –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã –Ω–∞ –ù–ï-Strava –¥–∞–Ω–Ω—ã—Ö
```

```
‚ö†Ô∏è –°–¶–ï–ù–ê–†–ò–ô 2: "–ú—ã –∂–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–º"

–ü–†–û–ë–õ–ï–ú–ê: –•–æ—Ç–∏–º —Å–æ–∑–¥–∞—Ç—å "–ø–æ—Ö–æ–∂–∏–µ –∞—Ç–ª–µ—Ç—ã" –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: –î–∞–∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–ú—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–≥—É–Ω–∞ –ê –±–µ–≥—É–Ω—É –ë, 
              –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞"
             ‚Üí "process Strava Data for analytics" –∑–∞–ø—Ä–µ—â–µ–Ω–æ
             
–ü–†–ê–í–ò–õ–¨–ù–û:
- –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å –Ω–∞—É—á–Ω—ã–º–∏ benchmarks (–ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
- –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–æ–Ω–æ–∫
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

```
‚ö†Ô∏è –°–¶–ï–ù–ê–†–ò–ô 3: "–•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫–∏"

–ü–†–û–ë–õ–ï–ú–ê: –•–æ—Ç–∏–º —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤
–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: 7 –¥–Ω–µ–π –∫—ç—à–∞ –¥–ª—è Strava Data
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–≠—Ç–æ –∂–µ –Ω–µ –∫–∞—Ä—Ç—ã, –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–∞" 
             ‚Üí –î–∏—Å—Ç–∞–Ω—Ü–∏—è, –≤—Ä–µ–º—è, –ø—É–ª—å—Å ‚Äî —ç—Ç–æ Strava Data
             
–ü–†–ê–í–ò–õ–¨–ù–û:
- –ö—ç—à —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö: max 7 –¥–Ω–µ–π
- –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (weekly_volume): –º–æ–∂–Ω–æ –¥–æ–ª—å—à–µ, 
  –Ω–æ —É–¥–∞–ª—è—Ç—å –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Strava
- –¢–≤–æ–∏ —Ä–∞—Å—á—ë—Ç—ã (GAP, –ø—Ä–æ–≥–Ω–æ–∑—ã): –±–µ—Å—Å—Ä–æ—á–Ω–æ
```

```
‚ö†Ô∏è –°–¶–ï–ù–ê–†–ò–ô 4: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–æ–≥–ª–∞—Å–∏–ª—Å—è"

–ü–†–û–ë–õ–ï–ú–ê: –•–æ—Ç–∏–º —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è ML —Å —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï: API Agreement –∑–∞–ø—Ä–µ—â–∞–µ—Ç –¥–∞–∂–µ —Å consent –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: "–£ –Ω–∞—Å –µ—Å—Ç—å —á–µ–∫–±–æ–∫—Å '—Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ ML'"
             ‚Üí –ù–µ–ª—å–∑—è, —ç—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç Strava, –Ω–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
             
–ü–†–ê–í–ò–õ–¨–ù–û:
- ML —Ç–æ–ª—å–∫–æ –Ω–∞ –ù–ï-Strava –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –í–í–û–î–ò–¢–¨ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–Ω–µ –∏–∑ Strava)
- –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–æ–∫, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
```

---

## 11. –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

> **üìù –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–æ–±—Å—É–∂–¥–µ–Ω–æ 2025-01-09):**
> –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: **–¢—É—Ä–∏—Å—Ç—ã ‚Üí –ë–µ–≥—É–Ω—ã ‚Üí Strava –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
>
> –ü—Ä–∏—á–∏–Ω—ã:
> - –¢—É—Ä–∏—Å—Ç—ã ‚Äî –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ
> - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤ –≥–æ—Ä–∞—Ö ‚Äî —Å–æ—Ü–∏–∞–ª—å–Ω–æ –∑–Ω–∞—á–∏–º–æ
> - –ù–µ —Ç—Ä–µ–±—É–µ—Ç Strava Developer Program approval
> - –ë—ã—Å—Ç—Ä–µ–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 11.1 –§–∞–∑–∞ 1: MVP –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤

**–¶–µ–ª—å:** –†–∞–±–æ—Ç–∞—é—â–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Ö–æ–¥–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤

```
–®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ FastAPI scaffold
‚îú‚îÄ‚îÄ PostgreSQL + Alembic setup
‚îî‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

–®–∞–≥ 2: GPX Parser
‚îú‚îÄ‚îÄ gpxpy –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —Ç—Ä–∞—Å—Å—ã
‚îî‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–π elevation calculation

–®–∞–≥ 3: DEM Integration
‚îú‚îÄ‚îÄ Open-Elevation API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (MVP)
‚îú‚îÄ‚îÄ Elevation correction
‚îî‚îÄ‚îÄ Threshold filtering
‚îÇ
‚îÇ   > üìù –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ: –ü—Ä–∏ —Ä–æ—Å—Ç–µ –¥–æ 1000+ –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
‚îÇ   > –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ srtm.py (self-hosted) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

–®–∞–≥ 4: –ê–ª–≥–æ—Ä–∏—Ç–º –ù–µ–π—Å–º–∏—Ç–∞
‚îú‚îÄ‚îÄ –ë–∞–∑–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞
‚îú‚îÄ‚îÄ –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ Tranter
‚îî‚îÄ‚îÄ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Å–ø—É—Å–∫–æ–≤

–®–∞–≥ 5: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∏—Å—Ç–∞
‚îú‚îÄ‚îÄ UI –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–æ–ø—ã—Ç, —Ä—é–∫–∑–∞–∫, –≥—Ä—É–ø–ø–∞)
‚îú‚îÄ‚îÄ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ –ø—Ä–æ—Ñ–∏–ª—é
‚îî‚îÄ‚îÄ –í—ã—Å–æ—Ç–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞

–®–∞–≥ 6: Safety Features
‚îú‚îÄ‚îÄ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–∏—Å–∫–∞—Ö
‚îú‚îÄ‚îÄ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞
‚îú‚îÄ‚îÄ –í—Ä–µ–º—è —Ä–∞–∑–≤–æ—Ä–æ—Ç–∞
‚îî‚îÄ‚îÄ Checklist –ø–µ—Ä–µ–¥ –ø–æ—Ö–æ–¥–æ–º

–®–∞–≥ 7: API Endpoints
‚îú‚îÄ‚îÄ POST /predict/hike
‚îú‚îÄ‚îÄ POST /gpx (upload)
‚îî‚îÄ‚îÄ Validation & error handling

–®–∞–≥ 8: Basic Frontend
‚îú‚îÄ‚îÄ Upload GPX form
‚îú‚îÄ‚îÄ –ü—Ä–æ—Ñ–∏–ª—å —Ç—É—Ä–∏—Å—Ç–∞ (–æ–ø—ã—Ç, —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ)
‚îî‚îÄ‚îÄ Results display —Å timeline

–®–∞–≥ 9: Testing & Deployment
‚îú‚îÄ‚îÄ Unit tests for formulas
‚îú‚îÄ‚îÄ Integration tests
‚îú‚îÄ‚îÄ Railway setup
‚îú‚îÄ‚îÄ Domain & SSL
‚îî‚îÄ‚îÄ Monitoring (Sentry)
```

**Deliverables –§–∞–∑—ã 1:**
- [ ] –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Ö–æ–¥–∞ –Ω–∞ –±–∞–∑–µ Naismith
- [ ] –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—É—Ä–∏—Å—Ç–∞ (–æ–ø—ã—Ç/—Ä—é–∫–∑–∞–∫/–≥—Ä—É–ø–ø–∞)
- [ ] –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –≤—ã—Å–æ—Ç—ã —á–µ—Ä–µ–∑ Open-Elevation API
- [ ] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –í–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å —Ñ–æ—Ä–º–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ GPX

### 11.2 –§–∞–∑–∞ 2: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤

**–¶–µ–ª—å:** –ë–∞–∑–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤, –≥—Ä—É–ø–ø–æ–≤—ã–µ –ø–æ—Ö–æ–¥—ã, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram

```
–®–∞–≥ 1: –ë–∞–∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ê–ª–º–∞—Ç—ã
‚îú‚îÄ‚îÄ –ö–æ–∫-–ñ–∞–π–ª—è—É, –ë—É—Ç–∞–∫–æ–≤—Å–∫–∏–π, –ë–ê–û, –§—É—Ä–º–∞–Ω–æ–≤–∞
‚îú‚îÄ‚îÄ –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ GPX
‚îî‚îÄ‚îÄ –§–æ—Ç–æ –∏ –æ–ø–∏—Å–∞–Ω–∏—è

–®–∞–≥ 2: –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ (–£–¢–ü!)
‚îú‚îÄ‚îÄ –í–≤–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
‚îú‚îÄ‚îÄ –†–∞—Å—á—ë—Ç spread –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
‚îú‚îÄ‚îÄ –¢–æ—á–∫–∏ –≤—Å—Ç—Ä–µ—á–∏
‚îî‚îÄ‚îÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—é –≥—Ä—É–ø–ø—ã

–®–∞–≥ 3: Telegram Mini App
‚îú‚îÄ‚îÄ Telegram Web App setup
‚îú‚îÄ‚îÄ Adapted UI –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤
‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–ª–∞–Ω–∞ –≤ —á–∞—Ç

–®–∞–≥ 4: –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îú‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ "–°–æ–æ–±—â–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –±–ª–∏–∑–∫–∏–º"
‚îú‚îÄ‚îÄ QR-–∫–æ–¥ —Å –ø–ª–∞–Ω–æ–º –ø–æ—Ö–æ–¥–∞
‚îî‚îÄ‚îÄ –§–æ—Ä–º–∞—Ç –¥–ª—è –î–ß–° (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

**Deliverables –§–∞–∑—ã 2:**
- [ ] –ë–∞–∑–∞ 10+ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ê–ª–º–∞—Ç—ã
- [ ] –ì—Ä—É–ø–ø–æ–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏
- [ ] Telegram Mini App –≤–µ—Ä—Å–∏—è
- [ ] –§—É–Ω–∫—Ü–∏—è "–°–æ–æ–±—â–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –±–ª–∏–∑–∫–∏–º"

### 11.3 –§–∞–∑–∞ 3: –†–µ–∂–∏–º –¥–ª—è –±–µ–≥—É–Ω–æ–≤

**–¶–µ–ª—å:** –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ –±–µ–≥–æ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é (–±–µ–∑ Strava)

```
–®–∞–≥ 1: –ë–µ–≥–æ–≤—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã
‚îú‚îÄ‚îÄ Riegel formula
‚îú‚îÄ‚îÄ Minetti/Strava GAP model
‚îî‚îÄ‚îÄ Confidence intervals

–®–∞–≥ 2: Prediction Engine –¥–ª—è –±–µ–≥—É–Ω–æ–≤
‚îú‚îÄ‚îÄ POST /predict/run (manual input)
‚îú‚îÄ‚îÄ –í–≤–æ–¥ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ 10–ö
‚îî‚îÄ‚îÄ Elevation-adjusted pace

–®–∞–≥ 3: UI –¥–ª—è –±–µ–≥—É–Ω–æ–≤
‚îú‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç—É—Ä–∏—Å—Ç/–±–µ–≥—É–Ω
‚îú‚îÄ‚îÄ –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ —Ç–µ–º–ø–∞
‚îî‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–ª–æ—Å–∫–æ–π —Ç—Ä–∞—Å—Å–æ–π

–®–∞–≥ 4: Public Courses Database
‚îú‚îÄ‚îÄ Course submission flow
‚îú‚îÄ‚îÄ Moderation (manual)
‚îî‚îÄ‚îÄ Search by location

–®–∞–≥ 5: Result Tracking
‚îú‚îÄ‚îÄ "Enter actual result" flow
‚îú‚îÄ‚îÄ Accuracy feedback
‚îî‚îÄ‚îÄ Personal progress chart
```

**Deliverables –§–∞–∑—ã 3:**
- [ ] –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ 10–ö
- [ ] –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞ —Ç–µ–º–ø–∞ –¥–ª—è –±–µ–≥—É–Ω–æ–≤
- [ ] –ë–∞–∑–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö —Ç—Ä–∞—Å—Å –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
- [ ] –í–≤–æ–¥ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 11.4 –§–∞–∑–∞ 4: Strava –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–¶–µ–ª—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞—Ç–ª–µ—Ç–∞

> **‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è:** Approval –≤ Strava Developer Program
> –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É: https://www.strava.com/settings/api
> Email: developers@strava.com
> –ü—Ä–æ—Ü–µ—Å—Å: 1-4 –Ω–µ–¥–µ–ª–∏, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "capacity of 1" (—Ç–æ–ª—å–∫–æ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç)

```
–®–∞–≥ 1: Strava OAuth
‚îú‚îÄ‚îÄ OAuth 2.0 flow
‚îú‚îÄ‚îÄ Token storage (encrypted)
‚îî‚îÄ‚îÄ Token refresh

–®–∞–≥ 2: Strava API Client
‚îú‚îÄ‚îÄ Get athlete stats
‚îú‚îÄ‚îÄ Get activities (6 months)
‚îî‚îÄ‚îÄ Rate limiting (in-memory –¥–ª—è MVP)

–®–∞–≥ 3: Webhooks
‚îú‚îÄ‚îÄ Webhook subscription
‚îú‚îÄ‚îÄ Event handling (activity.create, deauthorize)
‚îî‚îÄ‚îÄ Background processing

–®–∞–≥ 4: Data Processing
‚îú‚îÄ‚îÄ Extract best efforts
‚îú‚îÄ‚îÄ Aggregate training metrics
‚îî‚îÄ‚îÄ Personal fatigue factor

–®–∞–≥ 5: Enhanced Prediction
‚îú‚îÄ‚îÄ Use Strava data in prediction
‚îú‚îÄ‚îÄ Training readiness indicator
‚îî‚îÄ‚îÄ Comparison: manual vs Strava

–®–∞–≥ 6: User Management
‚îú‚îÄ‚îÄ User accounts
‚îú‚îÄ‚îÄ Prediction history
‚îî‚îÄ‚îÄ Strava disconnect flow

–®–∞–≥ 7: Privacy & Compliance
‚îú‚îÄ‚îÄ Privacy Policy page
‚îú‚îÄ‚îÄ Consent flows
‚îú‚îÄ‚îÄ Data deletion
‚îî‚îÄ‚îÄ 7-day TTL for Strava cache
```

**Deliverables –§–∞–∑—ã 4:**
- [ ] "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Strava" –∫–Ω–æ–ø–∫–∞
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ best efforts
- [ ] –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π fatigue factor
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–∏—Ç—å Strava

### 11.5 –§–∞–∑–∞ 5: Growth & Monetization

**–¶–µ–ª—å:** –í–∏—Ä–∞–ª—å–Ω–æ—Å—Ç—å, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Ayda Run, –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è

```
–®–∞–≥ 1: Share Features
‚îú‚îÄ‚îÄ –ö–∞—Ä—Ç–∏–Ω–∫–∞ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞ (Pillow/Cairo)
‚îú‚îÄ‚îÄ Shareable comparison images
‚îî‚îÄ‚îÄ Social-friendly format

–®–∞–≥ 2: Ayda Run Integration
‚îú‚îÄ‚îÄ CTA to main app
‚îú‚îÄ‚îÄ UTM tracking
‚îú‚îÄ‚îÄ Cross-promotion
‚îî‚îÄ‚îÄ Deep links

–®–∞–≥ 3: Freemium –º–æ–¥–µ–ª—å
‚îú‚îÄ‚îÄ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–≥–Ω–æ–∑
‚îú‚îÄ‚îÄ Premium: –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∏—Å—Ç–æ—Ä–∏—è, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
‚îî‚îÄ‚îÄ Payment integration

–®–∞–≥ 4: Analytics & Optimization
‚îú‚îÄ‚îÄ Usage analytics
‚îú‚îÄ‚îÄ Conversion tracking
‚îú‚îÄ‚îÄ A/B tests setup
‚îî‚îÄ‚îÄ Performance optimization
```

**Deliverables –§–∞–∑—ã 5:**
- [ ] –ö–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Ayda Run (CTA, deep links)
- [ ] Freemium subscription
- [ ] Analytics dashboard

### 11.6 –§–∞–∑–∞ 6: Crowdsourced –ø–æ–∫—Ä—ã—Ç–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–¶–µ–ª—å:** –£–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

> **üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –≠—Ç–∞ —Ñ–∞–∑–∞ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Ñ–æ—Ä–º—É–ª–∞—Ö Naismith/Minetti,
> crowdsourced –¥–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

```
–®–∞–≥ 1: Geo-indexed —Å–µ–≥–º–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ Geohash —Å–∏—Å—Ç–µ–º–∞
‚îú‚îÄ‚îÄ PostgreSQL + PostGIS —Å—Ö–µ–º–∞ trail_segments
‚îî‚îÄ‚îÄ –ë–∞–∑–æ–≤—ã–µ CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏

–®–∞–≥ 2: –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤
‚îú‚îÄ‚îÄ UI —Ñ–æ—Ä–º—ã –æ—Ç–∑—ã–≤–∞ –ø–æ—Å–ª–µ –ø–æ—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ –í—ã–±–æ—Ä –ø–æ–∫—Ä—ã—Ç–∏—è (multi-select)
‚îî‚îÄ‚îÄ –û—Ç–º–µ—Ç–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ

–®–∞–≥ 3: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞ —Ç–∏–ø –ø–æ–∫—Ä—ã—Ç–∏—è
‚îú‚îÄ‚îÄ –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å (–ª–µ—Ç–æ/–∑–∏–º–∞)
‚îî‚îÄ‚îÄ –ü–µ—Ä–µ—Å—á—ë—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (cron job)

–®–∞–≥ 4: Matching GPX —Ñ–∞–π–ª–æ–≤
‚îú‚îÄ‚îÄ Route fingerprinting
‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
‚îî‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ

–®–∞–≥ 5: Surface-aware –ø—Ä–æ–≥–Ω–æ–∑
‚îú‚îÄ‚îÄ –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ –ø–æ–∫—Ä—ã—Ç–∏—é
‚îú‚îÄ‚îÄ –û—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å–ø—É—Å–∫–æ–≤
‚îî‚îÄ‚îÄ Confidence scoring

–®–∞–≥ 6: OSM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ Fallback –Ω–∞ OpenStreetMap
‚îú‚îÄ‚îÄ –ú–∞–ø–ø–∏–Ω–≥ OSM —Ç–µ–≥–æ–≤
‚îî‚îÄ‚îÄ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

–®–∞–≥ 7 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): Gamification
‚îú‚îÄ‚îÄ –ë–µ–π–¥–∂–∏ –∑–∞ –æ—Ç–∑—ã–≤—ã ("Trail Scout")
‚îú‚îÄ‚îÄ –¢–æ–ø –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–æ–≤
‚îî‚îÄ‚îÄ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
```

**Deliverables –§–∞–∑—ã 6:**
- [ ] –°–±–æ—Ä –æ—Ç–∑—ã–≤–æ–≤ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü—Ä–∏–≤—è–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ (–Ω–µ –∫ —Ñ–∞–π–ª—É)
- [ ] –°–µ–∑–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–ª–µ—Ç–æ/–∑–∏–º–∞)
- [ ] Surface-aware –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OSM –∫–∞–∫ fallback
- [ ] Matching –Ω–æ–≤—ã—Ö GPX –∫ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –º–∞—Ä—à—Ä—É—Ç–∞–º

### 11.7 –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

```
–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ß–ï–ö–õ–ò–°–¢:
‚ñ° HTTPS –≤–µ–∑–¥–µ
‚ñ° –¢–æ–∫–µ–Ω—ã Strava –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (–ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
‚ñ° Rate limiting –Ω–∞ API (in-memory –¥–ª—è MVP)
‚ñ° Error handling –∏ logging
‚ñ° Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)
‚ñ° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Sentry, uptime)
‚ñ° Open-Elevation API fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

–Æ–†–ò–î–ò–ß–ï–°–ö–ò–ô –ß–ï–ö–õ–ò–°–¢ (–¥–ª—è Strava –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):
‚ñ° Privacy Policy –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞
‚ñ° Consent screen –¥–ª—è Strava OAuth
‚ñ° –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ"
‚ñ° –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫–ª—é—á–∏—Ç—å Strava"
‚ñ° 7-day TTL –¥–ª—è Strava –∫—ç—à–∞
‚ñ° –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ API Agreement –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
‚ñ° –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å crowdsourced –¥–∞–Ω–Ω—ã—Ö

–ü–†–û–î–£–ö–¢–û–í–´–ô –ß–ï–ö–õ–ò–°–¢:
‚ñ° –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Strava (fallback)
‚ñ° –†–µ–∂–∏–º –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ñ° –ü–æ–Ω—è—Ç–Ω—ã–µ error messages
‚ñ° Mobile-friendly UI
‚ñ° Share image –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
‚ñ° CTA –Ω–∞ Ayda Run —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ñ° Analytics –ø–æ–¥–∫–ª—é—á–µ–Ω–∞
‚ñ° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

–ß–ï–ö–õ–ò–°–¢ –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (–¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤):
‚ñ° –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤—ã—Å–æ—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
‚ñ° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚ñ° "–°–æ–æ–±—â–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç" —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
‚ñ° Checklist –ø–µ—Ä–µ–¥ –ø–æ—Ö–æ–¥–æ–º –¥–æ—Å—Ç—É–ø–µ–Ω
```

---

## 12. –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### 12.1 –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä prediction endpoint

```python
from fastapi import FastAPI, UploadFile, File, Form, HTTPException
from pydantic import BaseModel
from typing import Optional
import gpxpy

app = FastAPI(title="Ayda Run Predictor")

class PredictionRequest(BaseModel):
    best_10k_seconds: int
    terrain_type: str = "trail"  # road | trail | technical
    
class PredictionResponse(BaseModel):
    prediction: dict
    course: dict
    segments: list
    share_image_url: str


@app.post("/api/v1/predict/simple", response_model=PredictionResponse)
async def predict_simple(
    gpx_file: UploadFile = File(...),
    best_10k_seconds: int = Form(...),
    terrain_type: str = Form("trail")
):
    """
    –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –±–µ–∑ Strava.
    
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç:
    - GPX —Ñ–∞–π–ª —Ç—Ä–∞—Å—Å—ã
    - –õ—É—á—à–µ–µ –≤—Ä–µ–º—è –Ω–∞ 10–ö –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    - –¢–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - –ü—Ä–æ–≥–Ω–æ–∑ –≤—Ä–µ–º–µ–Ω–∏ —Å confidence interval
    - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç—Ä–∞—Å—Å—ã
    - –ü–æ—Å–µ–≥–º–µ–Ω—Ç–Ω—É—é —Ä–∞—Å–∫–ª–∞–¥–∫—É
    - URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞
    """
    
    # 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
    if not gpx_file.filename.endswith('.gpx'):
        raise HTTPException(400, "File must be GPX format")
    
    if best_10k_seconds < 1200 or best_10k_seconds > 7200:
        raise HTTPException(400, "10K time must be between 20:00 and 2:00:00")
    
    # 2. –ü–∞—Ä—Å–∏–Ω–≥ GPX
    try:
        gpx_content = await gpx_file.read()
        gpx_content = gpx_content.decode('utf-8')
    except Exception as e:
        raise HTTPException(400, f"Cannot read GPX file: {e}")
    
    # 3. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –≤—ã—Å–æ—Ç—ã —á–µ—Ä–µ–∑ DEM
    try:
        corrected_gpx = correct_gpx_elevation(gpx_content, smooth=True)
    except Exception:
        # Fallback –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        corrected_gpx = gpx_content
    
    # 4. –í—ã—á–∏—Å–ª—è–µ–º —Ç–µ–º–ø –Ω–∞ –ø–ª–æ—Å–∫–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
    flat_pace = best_10k_seconds / 10  # —Å–µ–∫/–∫–º
    
    # 5. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —Ç–∏–ø—É –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
    terrain_params = {
        "road": {"technical": False, "use_strava_gap": True},
        "trail": {"technical": False, "use_strava_gap": True},
        "technical": {"technical": True, "use_strava_gap": True}
    }
    params = terrain_params.get(terrain_type, terrain_params["trail"])
    
    # 6. –†–∞—Å—á—ë—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞
    result = predict_race_time(
        gpx_content=corrected_gpx,
        athlete_flat_pace=flat_pace,
        fatigue_factor=1.06,  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–µ–∑ Strava –¥–∞–Ω–Ω—ã—Ö
        use_strava_gap_model=params["use_strava_gap"],
        technical_terrain=params["technical"]
    )
    
    # 7. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
    def format_time(seconds: float) -> str:
        hours = int(seconds // 3600)
        minutes = int((seconds % 3600) // 60)
        secs = int(seconds % 60)
        if hours > 0:
            return f"{hours}:{minutes:02d}:{secs:02d}"
        return f"{minutes}:{secs:02d}"
    
    # 8. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞
    share_image_url = await generate_share_image(
        prediction_time=result.total_time_seconds,
        course_name=gpx_file.filename.replace('.gpx', ''),
        elevation_gain=result.total_elevation_gain_m,
        distance=result.total_distance_km
    )
    
    return PredictionResponse(
        prediction={
            "time_seconds": result.total_time_seconds,
            "time_formatted": format_time(result.total_time_seconds),
            "confidence_range": {
                "min_seconds": result.confidence_range[0],
                "max_seconds": result.confidence_range[1],
                "min_formatted": format_time(result.confidence_range[0]),
                "max_formatted": format_time(result.confidence_range[1])
            }
        },
        course={
            "distance_km": result.total_distance_km,
            "elevation_gain_m": result.total_elevation_gain_m,
            "elevation_loss_m": result.total_elevation_loss_m
        },
        segments=[
            {
                "km": f"{i*5}-{(i+1)*5}",
                "pace": format_time(seg["pace_sec_per_km"]) + "/–∫–º",
                "elevation_change": f"{'+' if seg['elevation_change_m'] > 0 else ''}{seg['elevation_change_m']:.0f}–º"
            }
            for i, seg in enumerate(chunk_segments(result.segments, 5))
        ],
        share_image_url=share_image_url
    )


def chunk_segments(segments: list, km_per_chunk: float) -> list:
    """–ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ N –∫–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    chunks = []
    current_chunk = {
        "distance_km": 0,
        "pace_sec_per_km": 0,
        "elevation_change_m": 0,
        "segment_count": 0
    }
    
    for seg in segments:
        current_chunk["distance_km"] += seg["distance_km"]
        current_chunk["pace_sec_per_km"] += seg["pace_sec_per_km"] * seg["distance_km"]
        current_chunk["elevation_change_m"] += seg.get("elevation_change_m", 0)
        current_chunk["segment_count"] += 1
        
        if current_chunk["distance_km"] >= km_per_chunk:
            # –£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Ç–µ–º–ø–∞
            current_chunk["pace_sec_per_km"] /= current_chunk["distance_km"]
            chunks.append(current_chunk)
            current_chunk = {
                "distance_km": 0,
                "pace_sec_per_km": 0,
                "elevation_change_m": 0,
                "segment_count": 0
            }
    
    # –ü–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ–ø–æ–ª–Ω—ã–π chunk
    if current_chunk["segment_count"] > 0:
        current_chunk["pace_sec_per_km"] /= current_chunk["distance_km"]
        chunks.append(current_chunk)
    
    return chunks
```

### 12.2 Share Image Generator

```python
from PIL import Image, ImageDraw, ImageFont
from io import BytesIO
import boto3  # –∏–ª–∏ –¥—Ä—É–≥–æ–π storage

async def generate_share_image(
    prediction_time: float,
    course_name: str,
    elevation_gain: float,
    distance: float
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç branded –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è —à–µ—Ä–∏–Ω–≥–∞ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö.
    
    Returns:
        URL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏
    """
    
    # –†–∞–∑–º–µ—Ä—ã –¥–ª—è Instagram Story / Telegram
    width, height = 1080, 1920
    
    # –°–æ–∑–¥–∞—ë–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    img = Image.new('RGB', (width, height), color='#1a1a2e')
    draw = ImageDraw.Draw(img)
    
    # –®—Ä–∏—Ñ—Ç—ã (–Ω—É–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ–∏)
    try:
        font_large = ImageFont.truetype("fonts/Montserrat-Bold.ttf", 120)
        font_medium = ImageFont.truetype("fonts/Montserrat-Regular.ttf", 60)
        font_small = ImageFont.truetype("fonts/Montserrat-Light.ttf", 40)
    except:
        font_large = ImageFont.load_default()
        font_medium = font_large
        font_small = font_large
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    hours = int(prediction_time // 3600)
    minutes = int((prediction_time % 3600) // 60)
    seconds = int(prediction_time % 60)
    time_str = f"{hours}:{minutes:02d}:{seconds:02d}"
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫
    draw.text(
        (width//2, 300), 
        "–ú–û–ô –ü–†–û–ì–ù–û–ó", 
        font=font_medium, 
        fill='#e94560',
        anchor="mm"
    )
    
    # –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞—Å—Å—ã
    draw.text(
        (width//2, 450), 
        course_name[:30], 
        font=font_medium, 
        fill='#ffffff',
        anchor="mm"
    )
    
    # –í—Ä–µ–º—è (–±–æ–ª—å—à–æ–µ)
    draw.text(
        (width//2, 750), 
        time_str, 
        font=font_large, 
        fill='#ffffff',
        anchor="mm"
    )
    
    # –ú–µ—Ç—Ä–∏–∫–∏
    metrics_y = 1000
    draw.text(
        (width//2 - 200, metrics_y), 
        f"{distance:.1f} –∫–º", 
        font=font_medium, 
        fill='#aaaaaa',
        anchor="mm"
    )
    draw.text(
        (width//2 + 200, metrics_y), 
        f"+{elevation_gain:.0f} –º", 
        font=font_medium, 
        fill='#aaaaaa',
        anchor="mm"
    )
    
    # –ë—Ä–µ–Ω–¥–∏–Ω–≥
    draw.text(
        (width//2, height - 200), 
        "–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –≤ Ayda Run", 
        font=font_small, 
        fill='#666666',
        anchor="mm"
    )
    draw.text(
        (width//2, height - 120), 
        "ayda.run/predict", 
        font=font_small, 
        fill='#e94560',
        anchor="mm"
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ buffer
    buffer = BytesIO()
    img.save(buffer, format='PNG', quality=95)
    buffer.seek(0)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ S3/storage
    filename = f"shares/{uuid.uuid4()}.png"
    
    s3 = boto3.client('s3')
    s3.upload_fileobj(
        buffer, 
        'ayda-run-shares',
        filename,
        ExtraArgs={'ContentType': 'image/png', 'ACL': 'public-read'}
    )
    
    return f"https://ayda-run-shares.s3.amazonaws.com/{filename}"
```

### 12.3 Strava Data Cleanup Job

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from datetime import datetime, timedelta

scheduler = AsyncIOScheduler()

@scheduler.scheduled_job('cron', hour=3)  # –ö–∞–∂–¥—É—é –Ω–æ—á—å –≤ 3:00
async def cleanup_strava_cache():
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–≥–æ –∫—ç—à–∞ Strava.
    
    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ API Agreement:
    "No Strava Data shall remain in your cache longer than seven days"
    """
    
    seven_days_ago = datetime.utcnow() - timedelta(days=7)
    
    # MongoDB TTL –∏–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –¥–µ–ª–∞—Ç—å —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏,
    # –Ω–æ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä—É—á–Ω—É—é
    
    result = await db.activities_cache.delete_many({
        "cached_at": {"$lt": seven_days_ago}
    })
    
    logger.info(f"Cleaned up {result.deleted_count} expired Strava activities")
    
    # –¢–∞–∫–∂–µ —á–∏—Å—Ç–∏–º Redis
    async for key in redis.scan_iter("strava:activities:*"):
        ttl = await redis.ttl(key)
        if ttl < 0:  # –ë–µ–∑ TTL –∏–ª–∏ –∏—Å—Ç—ë–∫
            await redis.delete(key)


@scheduler.scheduled_job('cron', hour=4)  # –í 4:00
async def cleanup_disconnected_users():
    """
    –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–∫–ª—é—á–∏–≤—à–∏—Ö Strava –±–æ–ª–µ–µ 48 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥.
    """
    
    cutoff = datetime.utcnow() - timedelta(hours=48)
    
    # –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç–∫–ª—é—á–∏–≤—à–∏—Ö Strava
    disconnected_users = await db.users.find({
        "strava": {"$exists": False},
        "strava_disconnected_at": {"$lt": cutoff}
    }).to_list(None)
    
    for user in disconnected_users:
        user_id = user["_id"]
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Strava
        await db.activities_cache.delete_many({"user_id": user_id})
        await db.athlete_metrics.delete_many({"user_id": user_id})
        
        # –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥
        await db.users.update_one(
            {"_id": user_id},
            {"$unset": {"strava_disconnected_at": ""}}
        )
        
        logger.info(f"Cleaned up Strava data for disconnected user {user_id}")
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–±–µ–≥–∞ –¥–ª—è Ayda Run. 

**–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**

1. **Privacy by Design** ‚Äî –º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö, –º–∞–∫—Å–∏–º—É–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏
2. **Strava API Compliance** ‚Äî —Å—Ç—Ä–æ–≥–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª, –Ω–∏–∫–∞–∫–∏—Ö —Å–µ—Ä—ã—Ö –∑–æ–Ω
3. **Graceful Degradation** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ Strava, –ª—É—á—à–µ —Å–æ Strava
4. **–ù–∞—É—á–Ω–∞—è –æ—Å–Ω–æ–≤–∞** ‚Äî —Ñ–æ—Ä–º—É–ª—ã –∏–∑ —Ä–µ—Ü–µ–Ω–∑–∏—Ä—É–µ–º—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π, –Ω–µ "—á—ë—Ä–Ω—ã–π —è—â–∏–∫"

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. Review —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
2. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –ø–æ —Ñ–∞–∑–∞–º
3. –°–æ–∑–¥–∞–Ω–∏–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
4. –ù–∞—á–∞–ª–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –§–∞–∑—ã 1

---

*–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ / AI coding agent*
