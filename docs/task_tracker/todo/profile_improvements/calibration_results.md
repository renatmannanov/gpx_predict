# Результаты калибровки: Baseline и прогресс

Этот файл фиксирует результаты калибровки после каждой фазы улучшений.

---

## Состояние данных (2026-02-03)

```
User: 2f07778a-8ab2-41b2-a41b-3dfbc0c4fa16
Sync: 170 / 391 (initial_sync_complete = True)
Run: 107 (106 with splits)
Hike: 3 (3 with splits)
Walk: 4 (4 with splits)
```

---

## Baseline: Текущий профиль (до улучшений)

**Профиль рассчитан на: 59 активностей, 571.5 км, 20042м elevation**

| Категория | Границы | Pace (min/km) | Speed (km/h) | Samples |
|-----------|---------|---------------|--------------|---------|
| Steep down | < -15% | 9.80 | 6.1 | 19 |
| Moderate down | -15% to -8% | 7.32 | 8.2 | 25 |
| Gentle down | -8% to -3% | 6.52 | 9.2 | 49 |
| **Flat** | **-3% to +3%** | **6.85** | **8.8** | **356** |
| Gentle up | +3% to +8% | 8.89 | 6.7 | 66 |
| Moderate up | +8% to +15% | 11.95 | 5.0 | 35 |
| Steep up | > +15% | 14.56 | 4.1 | 7 |

**Walk threshold:** 15.0%

### Проблемы baseline профиля

1. Рассчитан на 59 активностях, а в базе уже 107 Run
2. Steep up: всего 7 samples — ненадёжно
3. Нет фильтрации аномалий (ходьба смешивается с бегом)
4. Используется среднее, а не медиана

---

## Пересчёт из сырых данных (все 106 Run со сплитами)

| Категория | N | Raw Mean | Raw Median | IQR Mean | IQR Median | P25 | P75 |
|-----------|---|----------|------------|----------|------------|-----|-----|
| Steep down | 47 | 13.09 | 10.70 | 10.37 | 10.21 | 7.97 | 12.60 |
| Moderate down | 63 | 9.28 | 7.08 | 7.96 | 6.93 | 6.01 | 10.87 |
| Gentle down | 86 | 8.16 | 6.47 | 7.06 | 6.27 | 5.85 | 8.83 |
| **Flat** | **629** | **6.87** | **6.40** | **6.39** | **6.30** | **5.90** | **7.00** |
| Gentle up | 119 | 10.03 | 8.61 | 9.17 | 8.54 | 7.74 | 10.98 |
| Moderate up | 84 | 14.21 | 12.87 | 12.85 | 12.60 | 11.16 | 14.75 |
| Steep up | 66 | 21.87 | 19.82 | 20.79 | 19.77 | 16.18 | 25.58 |

---

## Baseline: Калибровка по активностям

### Все методы, baseline профиль

| Метод | Asphalt Sky Run (164 min) | Irbis Race (269 min) | Talgar Check #2 (328 min) |
|-------|---------------------------|----------------------|---------------------------|
| **Strava GAP** | **-2.4%** | -33.4% | -44.4% |
| **Minetti GAP** | **-0.1%** | -17.2% | -30.1% |
| Personalized (DB) | +35.8% | -13.6% | -28.1% |

### Экспериментальные варианты профиля (не реализовано, только расчёт)

| Профиль | Asphalt Sky Run | Irbis Race |
|---------|-----------------|------------|
| DB Current (old) | +16.3% | -20.0% |
| IQR Mean | +24.3% | **-7.6%** |
| IQR Median | +15.5% | -11.8% |
| Minetti GAP (ref) | -8.2% | -23.9% |

---

## Детальный разбор: Morning Asphalt Sky Run (ID 494)

21.7 km, +928m, 164 min. Все значения в минутах.

| # | Dist | Grade | Actual | Strava GAP | Minetti GAP | Personalized (DB) |
|---|------|-------|--------|-----------|-------------|-------------------|
| 1 | 1001m | +3.5% | 7.82 | 7.64 | 8.25 | 8.91 |
| 2 | 999m | +5.5% | 8.37 | 8.09 | 9.14 | 11.94 |
| 3 | 1001m | +7.5% | 9.03 | 8.56 | 10.12 | 11.96 |
| 4 | 1000m | +9.0% | 9.88 | 8.89 | 10.84 | 11.95 |
| 5 | 1000m | +10.1% | 10.87 | 9.13 | 11.40 | 14.55 |
| 6 | 1000m | +12.2% | 11.72 | 9.62 | 12.55 | 14.56 |
| 7 | 999m | +11.5% | 10.77 | 9.44 | 12.14 | 14.55 |
| 8 | 1001m | +11.7% | 11.18 | 9.51 | 12.28 | 14.57 |
| 9 | 1000m | +7.4% | 8.37 | 8.52 | 10.04 | 11.94 |
| 10 | 1000m | +8.5% | 8.47 | 8.78 | 10.61 | 11.95 |
| 11 | 1000m | +4.5% | 7.50 | 7.87 | 8.69 | 8.89 |
| 12 | 1000m | -8.9% | 6.02 | 5.94 | 4.30 | 7.33 |
| 13 | 1002m | -6.8% | 5.83 | 6.16 | 4.76 | 7.34 |
| 14 | 999m | -10.4% | 5.70 | 5.78 | 4.02 | 9.79 |
| 15 | 999m | -12.5% | 5.70 | 5.56 | 3.73 | 9.79 |
| 16 | 1001m | -10.9% | 5.88 | 5.74 | 3.95 | 9.81 |
| 17 | 999m | -11.1% | 5.73 | 5.71 | 3.92 | 9.80 |
| 18 | 1000m | -9.0% | 5.22 | 5.92 | 4.27 | 7.32 |
| 19 | 1001m | -8.0% | 5.48 | 6.04 | 4.50 | 7.33 |
| 20 | 999m | -6.1% | 5.45 | 6.21 | 4.92 | 7.32 |
| 21 | 999m | -4.4% | 5.22 | 6.40 | 5.40 | 6.52 |
| 22 | 692m | -3.4% | 3.73 | 4.50 | 3.95 | 4.51 |
| **TOTAL** | | | **163.9** | **160.0** | **163.8** | **222.6** |

---

## Детальный разбор: Irbis Race / Talgar (ID 570)

20.2 km, +2417m, 269 min. Все значения в минутах.

| # | Dist | Grade | Actual | Strava GAP | Minetti GAP | Personalized (DB) |
|---|------|-------|--------|-----------|-------------|-------------------|
| 1 | 1001m | +13.4% | 11.17 | 9.89 | 13.21 | 14.57 |
| 2 | 1001m | +4.5% | 8.62 | 7.88 | 8.70 | 8.90 |
| 3 | 999m | -1.6% | 9.28 | 6.68 | 6.28 | 6.85 |
| 4 | 1000m | +32.3% | 23.70 | 14.16 | 20.56 | 14.56 |
| 5 | 1000m | +13.6% | 12.60 | 9.93 | 13.32 | 14.56 |
| 6 | 1000m | +6.0% | 8.25 | 8.21 | 9.38 | 11.96 |
| 7 | 998m | +3.7% | 9.55 | 7.68 | 8.33 | 8.88 |
| 8 | 1001m | -7.6% | 5.93 | 6.08 | 4.58 | 7.33 |
| 9 | 1000m | +3.6% | 9.35 | 7.67 | 8.30 | 8.89 |
| 10 | 1000m | +9.7% | 12.35 | 9.05 | 11.21 | 11.95 |
| 11 | 1000m | +13.4% | 13.82 | 9.88 | 13.20 | 14.55 |
| 12 | 1000m | +16.9% | 14.72 | 10.67 | 15.24 | 14.55 |
| 13 | 1005m | +27.1% | 22.57 | 13.04 | 20.66 | 14.63 |
| 14 | 996m | +4.4% | 11.13 | 7.82 | 8.62 | 8.86 |
| 15 | 999m | -3.4% | 10.47 | 6.50 | 5.69 | 6.52 |
| 16 | 1000m | +11.9% | 12.87 | 9.54 | 12.38 | 14.56 |
| 17 | 1001m | +23.0% | 19.97 | 12.06 | 19.08 | 14.57 |
| 18 | 999m | +5.6% | 13.57 | 8.12 | 9.19 | 11.95 |
| 19 | 1000m | +9.6% | 24.13 | 9.02 | 11.15 | 11.95 |
| 20 | 999m | -20.6% | 13.72 | 4.73 | 3.45 | 9.79 |
| 21 | 235m | -25.5% | 1.47 | 0.99 | 0.92 | 2.30 |
| **TOTAL** | | | **269.2** | **179.3** | **222.8** | **232.7** |

---

## После Фазы 1: IQR фильтрация (2026-02-13)

**Изменения:**
1. `PACE_MAX_THRESHOLD_RUN`: 15.0 → 30.0 (санитарный порог, двойная защита)
2. `filter_outliers_iqr()` — IQR метод per gradient category, `statistics.quantiles()`
3. Применено только к trail running (hiking не тронут)

### Новый профиль (106 activities)

| Категория | Pace (до) | Pace (после) | Diff |
|-----------|-----------|-------------|------|
| Steep down | 10.01 | 10.78 | +0.77 |
| Moderate down | 8.00 | 8.22 | +0.22 |
| Gentle down | 6.90 | 6.90 | 0.00 |
| **Flat** | **6.63** | **6.39** | **-0.24** |
| Gentle up | 9.13 | 9.13 | 0.00 |
| Moderate up | 12.17 | 13.55 | +1.38 |
| Steep up | 14.67 | 20.71 | +6.04 |

**Примечание:** Steep/moderate uphill выросли значительно — старый PACE_MAX=15 отрезал
легитимные данные (pace 16-25 min/km на крутых подъёмах). Теперь IQR чистит аномалии,
а реальные данные остаются.

### Калибровка (backtest 47 activities, min_elev=100m)

| Метод | MAE (min) | MAPE | Bias | Samples |
|-------|-----------|------|------|---------|
| **Personalized** | **28.8** | **15.0%** | **-13.1%** | **47** |
| Strava GAP | 44.1 | 22.2% | -28.9% | 47 |
| Strava+Minetti | 44.8 | 22.1% | -29.0% | 47 |
| Minetti GAP | 49.3 | 24.5% | -32.4% | 47 |
| Tobler (hiking) | 66.3 | 54.0% | +36.1% | 47 |
| Naismith (hiking) | 79.8 | 64.2% | +49.2% | 47 |

### MAPE по градиентам

| Gradient | Strava | Minetti | S+M | Pers | Segments |
|----------|--------|---------|-----|------|----------|
| Steep down | 40.7% | 61.9% | 40.7% | 28.3% | 33 |
| Mod down | 31.1% | 46.8% | 31.1% | 31.4% | 69 |
| Gentle down | 20.2% | 26.4% | 20.2% | 23.0% | 79 |
| Flat | 13.9% | 14.4% | 13.9% | 14.8% | 240 |
| Gentle up | 20.6% | 17.2% | 17.2% | 19.1% | 115 |
| Mod up | 28.8% | 26.6% | 26.6% | 20.7% | 102 |
| Steep up | 28.3% | 36.9% | 36.9% | 21.9% | 44 |

Personalized лучше всех методов: MAPE 15.0% vs 22.1% (лучший GAP). Отрыв ~7%.

---

## После Фазы 2: 11 категорий + перцентили (2026-02-13)

**Изменения:**
1. `gradient_paces` JSON — 11 категорий с avg + samples
2. `gradient_percentiles` JSON — P25/P50/P75 per category
3. Персонализированный калькулятор использует 11 категорий
4. Legacy 7-cat avg_* поля — weighted average из 11-cat

### 11-category profile (106 activities)

| Category | Avg | Samples | P25 | P50 | P75 |
|----------|-----|---------|-----|-----|-----|
| down_23_over | 13.85 | 14 | 9.93 | 11.59 | 19.12 |
| down_23_17 | 10.51 | 19 | 7.92 | 10.02 | 12.25 |
| down_17_12 | 8.62 | 32 | 6.87 | 7.46 | 10.36 |
| down_12_8 | 8.17 | 40 | 5.76 | 6.80 | 10.75 |
| down_8_3 | 6.90 | 78 | 5.82 | 6.21 | 7.77 |
| **flat_3_3** | **6.39** | **588** | **5.86** | **6.29** | **6.87** |
| up_3_8 | 9.13 | 113 | 7.70 | 8.39 | 9.93 |
| up_8_12 | 11.41 | 39 | 10.25 | 11.07 | 12.35 |
| up_12_17 | 14.50 | 51 | 13.30 | 14.23 | 15.83 |
| up_17_23 | 18.24 | 22 | 15.39 | 18.42 | 20.27 |
| up_23_over | 23.48 | 14 | 20.84 | 24.04 | 26.02 |

### Калибровка (backtest 47 activities, min_elev=100m)

| Метод | MAE (min) | MAPE | Bias | Samples |
|-------|-----------|------|------|---------|
| **Personalized** | **27.5** | **14.2%** | **-13.3%** | **47** |
| Strava GAP | 44.1 | 22.2% | -29.0% | 47 |
| Strava+Minetti | 44.8 | 22.1% | -29.0% | 47 |
| Minetti GAP | 49.3 | 24.5% | -32.4% | 47 |

### Прогресс: Phase 1 → Phase 2

| Metric | Phase 1 | Phase 2 | Change |
|--------|---------|---------|--------|
| MAPE | 15.0% | 14.2% | -0.8% |
| MAE | 28.8 min | 27.5 min | -1.3 min |
| Mod up MAPE | 20.7% | 16.5% | -4.2% |
| Steep up MAPE | 21.9% | 17.7% | -4.2% |

Основной выигрыш — на подъёмах, где 11 категорий дают лучшее разрешение чем 7.

---

## После Фазы 3: Effort Levels (2026-02-13)

**Изменения:**
1. `EffortLevel` enum в `shared/calculator_types.py` — Race/Moderate/Easy
2. `EFFORT_PERCENTILES` — конфигурируемые значения (race=P25, moderate=P50, easy=P75)
3. `RunPersonalizationService` принимает `effort: EffortLevel`, читает из перцентилей
4. Backtest калькулятор считает все 3 варианта параллельно
5. Отчёт показывает `personalized_race`, `personalized_moderate`, `personalized_easy`

### Калибровка (backtest 37 activities, min_elev=200m)

| Метод | MAE (min) | MAPE | Bias | Samples |
|-------|-----------|------|------|---------|
| **Pers. Easy (P75)** | **31.7** | **17.4%** | **-4.1%** | **37** |
| **Pers. Moderate (P50)** | **35.9** | **17.3%** | **-18.8%** | **37** |
| Pers. Race (P25) | 46.5 | 22.8% | -26.6% | 37 |
| Strava GAP | 55.2 | 26.8% | -31.5% | 37 |
| Strava+Minetti | 56.0 | 26.8% | -31.8% | 37 |
| Minetti GAP | 61.8 | 29.9% | -35.3% | 37 |

**Pers. Moderate** — лучший MAPE (17.3%), **Pers. Easy** — минимальный Bias (-4.1%).

### MAPE по градиентам

| Gradient | Strava | P.Race | P.Mod | P.Easy | Segments |
|----------|--------|--------|-------|--------|----------|
| Steep down | 40.7% | 27.7% | 27.8% | 48.8% | 33 |
| Mod down | 31.2% | 26.2% | 26.0% | 47.6% | 69 |
| Gentle down | 20.7% | 20.9% | 20.3% | 29.3% | 73 |
| Flat | 18.5% | 23.2% | 19.8% | 17.6% | 153 |
| Gentle up | 21.2% | 19.0% | 17.6% | 23.8% | 109 |
| Mod up | 28.8% | 17.7% | 16.2% | 19.4% | 102 |
| Steep up | 28.3% | 22.0% | 17.5% | 18.8% | 44 |

### Тестовые активности: выбор effort level

| Активность | Тип | Actual | Race (P25) | Moderate (P50) | Easy (P75) | Лучший |
|------------|-----|--------|-----------|----------------|-----------|--------|
| Asphalt Sky Run (494) | Road | 164 min | **166 min (+1.3%)** | 182 min (+11.1%) | 228 min (+39.0%) | **Race** |
| Irbis Race (570) | Trail | 269 min | 215 min (-20.1%) | 239 min (-11.4%) | **272 min (+0.9%)** | **Easy** |

**Выводы:**
- Road race → **Race** effort практически идеален (+1.3%)
- Technical trail race (2417m D+) → **Easy** effort ближе всего (+0.9%)
- Irbis Race: даже Easy немного завышает — технический рельеф замедляет больше, чем показывают P75

### Прогресс: Phase 2 → Phase 3

| Metric | Phase 2 (avg) | Phase 3 (Moderate) | Phase 3 (Easy) |
|--------|--------------|-------------------|----------------|
| MAPE | 14.2% | 17.3% | 17.4% |
| Bias | -13.3% | -18.8% | -4.1% |

**Примечание:** MAPE немного вырос (14.2% → 17.3%), т.к. Phase 2 считал по avg, а Phase 3 по P50.
Однако теперь у нас диапазон — пользователь выбирает effort и получает:
- Race: быстрый прогноз для гонок
- Moderate: типичная тренировка
- Easy: консервативный прогноз для разведки

Bias улучшился с -13.3% (систематическое завышение скорости) до -4.1% для Easy.

---

## Фаза 4: Финальная валидация (2026-02-13)

### Калибровка (backtest 47 activities, min_elev=100m)

| Метод | MAE (min) | MAPE | Bias | Samples |
|-------|-----------|------|------|---------|
| **Pers. Moderate (P50)** | **28.8** | **14.5%** | **-17.4%** | **47** |
| **Pers. Easy (P75)** | **25.9** | **15.3%** | **-3.2%** | **47** |
| Pers. Race (P25) | 38.0 | 20.1% | -25.1% | 47 |
| Strava GAP | 44.1 | 22.2% | -29.0% | 47 |
| Strava+Minetti | 44.8 | 22.1% | -29.0% | 47 |
| Minetti GAP | 49.3 | 24.5% | -32.4% | 47 |
| Tobler (hiking) | 66.3 | 54.0% | +36.1% | 47 |
| Naismith (hiking) | 79.8 | 64.2% | +49.2% | 47 |

### Все 3 тестовые активности

| Активность | Тип | Actual | Race (P25) | Moderate (P50) | Easy (P75) | Лучший |
|------------|-----|--------|-----------|----------------|-----------|--------|
| Asphalt Sky Run (494) | Road | 164 min | **166 min (+1.3%)** | 182 min (+11.1%) | 228 min (+39.0%) | **Race** |
| Irbis Race (570) | Trail race | 269 min | 215 min (-20.1%) | 239 min (-11.4%) | **272 min (+0.9%)** | **Easy** |
| Talgar Check #2 (563) | Fast hiking | 328 min | 219 min (-33.3%) | 241 min (-26.6%) | **275 min (-16.4%)** | **Easy** |

### Проверка критериев успеха (из Phase 4 плана)

| Активность | Цель | Лучший результат | Статус |
|------------|------|-----------------|--------|
| Asphalt Sky Run | < 15% | Race: +1.3% | PASS |
| Irbis Race | < 10% | Easy: +0.9% | PASS |
| Talgar Check #2 | < 25% | Easy: -16.4% | PASS |

**Все 3 цели достигнуты.**

### Выводы

1. **Road race** → Race (P25) — практически идеальный прогноз (+1.3%)
2. **Technical trail race** → Easy (P75) — отличный прогноз (+0.9%)
3. **Fast hiking/разведка** → Easy (P75) — приемлемый (-16.4%), но заметный недобор
4. **Moderate** — лучший MAPE по всем 47 активностям (14.5%), хороший default
5. **Easy** — минимальный Bias (-3.2%), лучший MAE (25.9 min)

### Прогресс по фазам (все на 47 activities, min_elev=100m)

| Фаза | Лучший метод | MAPE | Bias | MAE |
|------|-------------|------|------|-----|
| Phase 1 (IQR) | Personalized (avg) | 15.0% | -13.1% | 28.8 min |
| Phase 2 (11-cat) | Personalized (avg) | 14.2% | -13.3% | 27.5 min |
| Phase 3 (effort) | Pers. Moderate (P50) | 14.5% | -17.4% | 28.8 min |
| Phase 3 (effort) | Pers. Easy (P75) | 15.3% | -3.2% | 25.9 min |

**Итог:** Phase 2 avg дал лучший MAPE (14.2%), но Phase 3 Easy дал лучший Bias (-3.2%) и MAE (25.9 min). Главная ценность Phase 3 — диапазон прогнозов для разных сценариев.

---

## Валидация на GPX файлах (2026-02-13)

Прогон 5 GPX маршрутов через TrailRunService с персонализированным профилем (106 activities, 11-cat, percentiles).
Используется `all_run_personalized_{effort}` (без threshold/hike detection).

### Результаты

| Маршрут | Dist | D+ | Факт | Race | Mod | Easy | Лучший | Ошибка |
|---------|------|-----|------|------|-----|------|--------|--------|
| Alpine Race | 3.3km | 865m | 60 min | **69m** | 80m | 87m | Race | **+15%** |
| Povlen RED RACE 25 | 27.5km | 886m | 178 min | **188m** | 207m | 259m | Race | **+5.6%** |
| TalgarTrail25 (гонка) | 20.0km | 2323m | 269 min | 237m | **269m** | 314m | **Mod** | **+0.0%** |
| TalgarTrail25 (зона 2) | 20.0km | 2323m | 328 min | 237m | 269m | **314m** | Easy | **-4.3%** |
| TalgarTrail25 (хайк) | 20.0km | 2323m | 484 min | 237m | 269m | 314m | Easy | **-35%** |
| Бутаковка-Пионер (зона 2) | 10.7km | 1069m | 167 min | 117m | 138m | **162m** | Easy | **-3.0%** |
| Шымбулак-Маншук (зона 2) | 15.6km | 1353m | 246 min | 180m | 219m | **251m** | Easy | **+2.0%** |

**Примечание:** TalgarTrail — 3 прохождения одного маршрута с разным усилием. GPX файл один.

### Effort level mapping (подтверждено)

| Сценарий | Лучший effort | Примеры |
|----------|--------------|---------|
| Асфальтовая/пологая гонка | **Race (P25)** | Povlen (+5.6%), Alpine Race (+15%) |
| Техничная trail гонка | **Moderate (P50)** | TalgarTrail гонка (+0.0%) |
| Тренировка зона 2 | **Easy (P75)** | Бутаковка (-3.0%), Шымбулак (+2.0%), TalgarTrail зона 2 (-4.3%) |
| Чистый хайк | За пределами модели | TalgarTrail хайк (-35%) — это hiking, не trail running |

### Анализ проблем

**Alpine Race (+15%):** Чистый подъём ~26%. Данные в профиле есть (up_23_over: 14 samples, P25=20.84 min/km), но на гонке pace = 17.9 min/km — быстрее P25. 14 samples маловато для экстремальных градиентов; с накоплением данных P25 станет агрессивнее.

**TalgarTrail хайк (-35%):** Easy (P75) = 314 min, факт = 484 min. P75 бегового профиля не покрывает hiking — это штатное ограничение trail running модели. Для чистого хайка нужна hiking модель.
