# –§–∞–∑–∞ 2.5: –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## –ö–æ–Ω—Ç–µ–∫—Å—Ç

Races MVP (–§–∞–∑–∞ 2) —Ä–∞–±–æ—Ç–∞–µ—Ç: `/races` ‚Üí –∫–∞—Ä—Ç–æ—á–∫–∞ –≥–æ–Ω–∫–∏ ‚Üí –ø—Ä–æ–≥–Ω–æ–∑/–ø–æ–∏—Å–∫/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞. –ù–æ –ø—Ä–æ–≥–Ω–æ–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–≤–µ–¥—ë–Ω–Ω—ã–π —Ç–µ–º–ø, –ø–æ–∏—Å–∫ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏, –∞ Strava-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–Ω–µ –æ–¥–æ–±—Ä–µ–Ω–∞ Strava). –≠—Ç–∞ —Ñ–∞–∑–∞ —É–ª—É—á—à–∞–µ—Ç UX –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—É—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **–§–∞–∑–∞ 2 –∑–∞–≤–µ—Ä—à–µ–Ω–∞** ‚Äî –±–æ—Ç, API, keyboards, FSM states —Ä–∞–±–æ—Ç–∞—é—Ç
- –î–ª—è –ó–∞–¥–∞—á–∏ 3 ‚Äî endpoint –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ ayda_run

## –ó–∞–¥–∞—á–∏

### –ó–∞–¥–∞—á–∞ 0: –§–∏–∫—Å—ã –≤—ã–≤–æ–¥–∞ –±–æ—Ç–∞ ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ.** –ü–µ—Ä–µ–¥–µ–ª–∞–Ω –≤—ã–≤–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–∏ –≥–æ–Ω–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:

- Race card: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (–ì–æ–Ω–∫–∞/–î–∏—Å—Ç–∞–Ω—Ü–∏—è/–°–ª–æ–∂–Ω–æ—Å—Ç—å/–õ–æ–∫–∞—Ü–∏—è/–ú–∞—Ä—à—Ä—É—Ç)
- GRADE_LABEL —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º (–î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞—á–∏–Ω–∞—é—â–∏–º / –°—Ä–µ–¥–Ω–∏–π / –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π / –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π)
- –ö–Ω–æ–ø–∫–∞ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑" –≤–º–µ—Å—Ç–æ "–ú–æ–π –ø—Ä–æ–≥–Ω–æ–∑"
- –£–±—Ä–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- HTML escaping –¥–ª—è stats (`<` –∏ `>` –≤ bucket labels)
- Fix search: word-by-word matching (Mannanov Renat / Renat Mannanov)
- –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏–∫–∞—Ç `find_distance_results`
- Prediction output: card header, dot-padded –º–µ—Ç–æ–¥—ã, dual Strava+selected pace, comparison
- Hiking output: —Ç–æ–∂–µ —Å card header –∏ dot-padded –º–µ—Ç–æ–¥–∞–º–∏

---

### –ó–∞–¥–∞—á–∞ 1: –ê–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ.** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `race_search_name` –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∏—Å–∫–µ –∏ –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º:

- –ö–Ω–æ–ø–∫–∞ "–ü–æ–∏—Å–∫" (–±—ã–≤—à. "–ù–∞–π—Ç–∏ —Å–µ–±—è") ‚Üí –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∏–º—è ‚Üí –∞–≤—Ç–æ-–ø–æ–∏—Å–∫
- –ü–µ—Ä–≤—ã–π –ø–æ–∏—Å–∫: –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –§–ò–û, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ `users.race_search_name` (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
- "–ò—Å–∫–∞—Ç—å –¥—Ä—É–≥–æ–µ –∏–º—è" ‚Üí —Ä—É—á–Ω–æ–π –≤–≤–æ–¥, –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ –∏–º—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ (–æ–¥–∏–Ω –≥–æ–¥ –∏ –≤—Å–µ –≥–æ–¥—ã)

---

### –ó–∞–¥–∞—á–∞ 2: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –≥–æ–Ω–∫–∏ ‚úÖ

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ.** –ü—Ä–æ–∫–∏–Ω—É—Ç run_profile —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É Bot ‚Üí API ‚Üí RaceService ‚Üí TrailRunService:

- Backend: telegram_id –≤ PredictRequest, –∑–∞–≥—Ä—É–∑–∫–∞ UserRunProfile –∏–∑ –ë–î, personalized_times + run_profile_stats –≤ –æ—Ç–≤–µ—Ç–µ
- Bot: telegram_id –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ predict(), _do_predict() –∏ –¥–∞–ª–µ–µ –≤ API
- Formatter: 3 —Å–µ–∫—Ü–∏–∏ (fast/moderate/easy + Strava stats + effort legend)
- –£–±—Ä–∞–Ω–∞ —Å–µ–∫—Ü–∏—è "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å {year}" –∏–∑ –≤—ã–≤–æ–¥–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–±–µ–≥ –∏ —Ö–∞–π–∫)
- –£–ª—É—á—à–µ–Ω —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ–Ω–∫–∏ –∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏

**–°—É—Ç—å:** –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å Strava + run profile (gradient-pace –¥–∞–Ω–Ω—ã–µ), –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ flat pace.

**–¢–µ–∫—É—â–∏–π flow:**
```
Bot ‚Üí POST /races/{id}/predict {distance_id, flat_pace, mode}
  ‚Üí RaceService.predict_by_pace() ‚Üí TrailRunService(flat_pace=X) ‚Äî –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
```

**–ù–æ–≤—ã–π flow:**
```
Bot ‚Üí POST /races/{id}/predict {distance_id, flat_pace, mode, telegram_id}
  ‚Üí API –∑–∞–≥—Ä—É–∂–∞–µ—Ç UserRunProfile –∏–∑ –ë–î
  ‚Üí RaceService.predict_by_pace(run_profile=profile)
  ‚Üí TrailRunService(flat_pace=X, run_profile=profile) ‚Äî —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π
```

**–§–∞–π–ª—ã:**

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|------|-----------|
| `backend/app/api/v1/routes/races.py` | `PredictRequest` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `telegram_id: Optional[str]`. Endpoint ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `Depends(get_async_db)`, –∑–∞–≥—Ä—É–∑–∫–∞ `UserRunProfile`. `PredictResponse` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `personalized: bool`, `run_profile_stats: Optional[dict]`, `personalized_times: Optional[dict]` |
| `backend/app/features/races/service.py` | `predict_by_pace()` ‚Äî –Ω–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä `run_profile`. `_predict_trail_run()` ‚Äî –ø–µ—Ä–µ–¥–∞—Ç—å –≤ `TrailRunService`. `RacePrediction` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `personalized: bool`, `run_profile_stats`, `personalized_times` |
| `bot/services/clients/races.py` | `predict()` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `telegram_id` –ø–∞—Ä–∞–º–µ—Ç—Ä |
| `bot/handlers/races.py` | `_do_predict()` ‚Äî –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `telegram_id`. `_format_prediction_result()` ‚Äî –¥–æ–±–∞–≤–∏—Ç—å 3 —Å–µ–∫—Ü–∏–∏ (—Å–º. –Ω–∏–∂–µ) |

**–°–µ–∫—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ –±–æ—Ç–∞ (–¥–æ–±–∞–≤–∏—Ç—å –≤ `_format_prediction_result()`):**

–ü–æ—Å–ª–µ –±–ª–æ–∫–æ–≤ Strava/selected pace, –ø–µ—Ä–µ–¥ comparison:

1. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç** (–µ—Å–ª–∏ `personalized_times` –≤ –æ—Ç–≤–µ—Ç–µ API):
```
üéØ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Strava:
  üî• Fast...............1—á 10–º–∏–Ω
  ‚ö° Moderate...1—á 21–º–∏–Ω
  üö∂ Easy..............1—á 31–º–∏–Ω
```

2. **Strava profile stats** (–µ—Å–ª–∏ `run_profile_stats` –≤ –æ—Ç–≤–µ—Ç–µ API):
```
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìà –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Strava:
1091 –∫–º, 111 –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π, 1049 —Å–ø–ª–∏—Ç–æ–≤, –ø—Ä–æ—Ñ–∏–ª—å –∑–∞–ø–æ–ª–Ω–µ–Ω 11 –∏–∑ 11
```

3. **Effort level legend** (–µ—Å–ª–∏ –±—ã–ª –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞—Å—á—ë—Ç):
```
üî• Fast ‚Äî –≥–æ–Ω–æ—á–Ω—ã–π/–∞—Å—Ñ–∞–ª—å—Ç–æ–≤—ã–π —Ç–µ–º–ø
‚ö° Moderate ‚Äî –æ–±—ã—á–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞
üö∂ Easy ‚Äî –ª—ë–≥–∫–∏–π –±–µ–≥ / —Ä–∞–∑–≤–µ–¥–∫–∞
```

–ü–∞—Ç—Ç–µ—Ä–Ω —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –∫–∞–∫ –≤ `bot/handlers/trail_run.py` (—Å—Ç—Ä–æ–∫–∏ 142-197).

**–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–µ:**
- `TrailRunService` ‚Äî —É–∂–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `run_profile` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç personalized times
- `UserRepository.get_by_telegram_id()` ‚Äî —É–∂–µ –µ—Å—Ç—å
- `TrailRunProfileRepository.get_by_user_id()` ‚Äî —É–∂–µ –µ—Å—Ç—å
- `bot/handlers/trail_run.py` ‚Äî –ø–∞—Ç—Ç–µ—Ä–Ω –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è effort levels –∏ Strava stats

**–ö—Ä–∏—Ç–µ—Ä–∏–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:** –ü—Ä–æ–≥–Ω–æ–∑ —Å Strava ‚Üí "–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Å–µ–∫—Ü–∏—è + Strava stats + effort legend. –ë–µ–∑ Strava ‚Üí –∫–∞–∫ —Ä–∞–Ω—å—à–µ (—Ç–æ–ª—å–∫–æ GAP –º–µ—Ç–æ–¥—ã).

---

### –ó–∞–¥–∞—á–∞ 3: Strava —á–µ—Ä–µ–∑ ayda_run ‚Üí –í–´–ù–ï–°–ï–ù–û

**–í—ã–Ω–µ—Å–µ–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω:** `docs/task_tracker/todo/cross_service_integration.md`

–ó–∞–¥–∞—á–∞ –≤—ã—Ä–æ—Å–ª–∞ –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∫—Ä–æ—Å—Å-—Å–µ—Ä–≤–∏—Å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é (4 —à–∞–≥–∞: —Ç–æ–∫–µ–Ω—ã, –∞–≤—Ç–æ-–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—Ä–µ–¥–∏–∫—Ç, –º–∞—Ç—á–∏–Ω–≥).

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. ~~–ó–∞–¥–∞—á–∞ 0 ‚Äî —Ñ–∏–∫—Å—ã –≤—ã–≤–æ–¥–∞~~ ‚úÖ
2. ~~–ó–∞–¥–∞—á–∞ 1 ‚Äî –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ + —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ~~ ‚úÖ
3. ~~–ó–∞–¥–∞—á–∞ 2 ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑~~ ‚úÖ
4. ~~–ó–∞–¥–∞—á–∞ 3~~ ‚Üí –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ `cross_service_integration.md`

## –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ–º –≤ —ç—Ç–æ–π —Ñ–∞–∑–µ

- –ü–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é OAuth (—É–¥–∞–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ OAuth –∏–∑ gpx_predictor)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ç—á–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≥–æ–Ω–∫–æ–π (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ race_name –≤ –ë–î)
- Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ–Ω–∫–∞—Ö
- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
